---
title: 报告编写的艺术-4 查找文章  
date: 2024-05-09 01:11:00  
tags: 报告编写的艺术  
---
  
# 0-章节（查找文章）介绍

好了，你们一直在等待的这一章。在这里，我们将把一篇发现文章分解为关键部分，并研究如何以最佳方式编写每个部分。

我对本章各领域的建议对某些人来说可能是新的。主要区别可能在于我建议将各个调查结果本身放入的深度水平，而不是依赖报告的执行摘要或建议部分。

以这种方式编写问题有充分的理由。首先，人们越来越有可能孤立地看待问题，而远离报告文件的其余部分。这正在成为新常态，因为我们看到客户将报告中的问题加载到 JIRA 和其他类似系统中，但忘记了执行摘要和战略建议中涵盖的内容。这增加了在补救过程中不考虑建议的可能性，这些建议将提高调查结果的整体安全性和上下文影响。其次，我在调查结果文章中观察到的一个常见模式不仅包括缺乏关于为什么调查结果很重要的信息，而且还缺乏关于剥削**对客户**的实际影响和潜在后果的细节。

我们将密切关注我们在课程开始时一直花费的时间来讨论的背景，以及我们如何利用这些知识为我们的客户撰写准确和有影响力的发现。我们还将更加深思熟虑地考虑我们在调查结果中放置的补救措施，以确保我们不仅涵盖快速修复，还涵盖预防性建议。

这可能是课程中最重要的一章。这当然是你将来在制作报告时大部分文字都会写的地方，所以请不要急于阅读本节。花时间完成每节课并完成练习。

我希望你们能看到我在这里宣讲的好处，以及我们可以为我们的报告增加多少质量和价值。

我们走吧！

# 1-章节（报告内容）介绍 - 练习

对于本章，不仅每节课后会有通常的练习，而且通常会有一两个练习，要求你为下面的每个问题写一个部分。在本章结束时，您应该已经为每个问题创建了完整的文章。

课程中将涵盖的调查结果的主要部分是：

- 风险评级
- 其他查找元数据
- 标题
- 描述和影响
- 证据
- 建议
- 受影响的位置
- 引用

因此，请复制以下评估上下文、范围和问题证据，以免您不断返回此页面。我建议你打开一个Word文档或类似文件，这样你就可以边走边写这些问题。在每节课中，我们还将研究另一个发现列表，展示我将在几节课中介绍的示例。

------

## 评估背景

这些示例问题是在对一家名为 OmniCorp 的组织进行多阶段评估时发现的。OmniCorp 是一家技术公司，提供多种存储解决方案，可满足多种类型的组织数据需求。其中包括基于文件的存储、医院成像托管和任意数据的常规日志记录存储。正因为如此，OmniCorp 拥有广泛的客户。

## 范围

以下列表显示了评估的范围，以及有关评估期间或从客户那里了解到的上下文的一些附加信息：

- AWS 配置审核（所有账户）
  - OmniCorp 面向公众的所有网站都存储在 AWS 上。
  - 一些开发人员和其他员工可以在 AWS 中建立基础设施。
  - 有一条从 AWS 到本地环境的路由，该路由是存储所有数据的地方。
- 内部和外部漏洞扫描
  - 外部：所有 AWS 资产和 OmniCorp 的 DMZ 都来自其本地托管生产网络。
  - 内部：扫描其本地托管生产网络。这是存储所有用户数据的地方。
- Windows Server 内部版本评审
  - Windows Server 2022 的黄金构建映像。
- Linux 服务器构建审查
  - Ubuntu Server 的黄金构建映像的配置审查。
  - OmniCorp 对 Linux 的主要用途是运行 Ceph 进行存储，以支持其为客户存储数据的主要应用程序。
  - https://ceph.io/en/
- 论坛软件 Web 应用程序评估
  - 内部论坛软件解决方案的 Web 应用程序评估。
  - 仅用于客户支持。
  - 解决方案后端是用 Java 编写的，具有简单的 jQuery 和 Bootstrap 前端。
- API 评估
  - API 审查 API，该 API 支持与移动应用程序之间的通信。
  - 该 API 用于从本地环境中检索数据，并托管在 AWS 中。
- 移动应用程序评估
  - 该移动应用程序仅适用于 Android，并且是用 Java 编写的。
  - 它为移动设备上的 API 提供前端。

**注意**：对其主网站的 Web 应用程序评估不在本次审查的范围内。

## 发现

### 论坛应用程序中的不安全反序列化

**观察到什么**

Web 论坛包含一种公开的反序列化方法，可用于反序列化任意对象。这可能会被滥用，以便在主机上获得远程执行。结果是托管论坛软件的内部服务器上出现 bash 提示符。这与生产网络位于同一网络中。

**证据**

```
POST /app/Deserialize HTTP/1.1
Host: app.omnicorp.com
Content-Type: application/x-java-serialized-object
Content-Length: 128


ac ed 00 05 73 72 00 12 6a 61 76 61 2e 75 74 69 6c 2e...


HTTP/1.1 202 Accepted
```

侦听器设置：

```
$ nc -lvp 4444


Listener Received Connection:
Listening on [0.0.0.0] (family 0, port 4444)
Connection from [192.168.1.10] port 4444 [tcp/*] accepted (family 2, sport 51768)
bash-4.2$ 
```

### 论坛软件中的 SQL 注入

**观察到什么**

搜索功能容易受到SQL注入的影响，并且可以获取用户哈希值。从经过哈希处理的对应物中恢复了许多密码。论坛的用户似乎在生产应用程序上使用相同的用户名和密码组合。

**证据**

```
GET /app/search?q=' UNION SELECT username, password_hash FROM users -- HTTP/1.1
Host: app.omnicorp.com


HTTP/1.1 200 OK
Content-Type: text/html


<table>
<tr><th>Username</th><th>Password Hash</th></tr>
<tr><td>admin</td><td>5f4dcc3b5aa765d61d8327deb882cf99</td></tr>
<tr><td>johndoe</td><td>202cb962ac59075b964b07152d234b70</td></tr>
...
</table>
```

### 移动应用程序中不安全的直接对象引用

**观察到什么**

对用户对象的直接引用是不安全实现的，允许未经授权访问其他用户的数据。返回的唯一数据仅限于电子邮件和用户 ID。这可用于针对系统的其他攻击。

**证据**

```
GET /api/user/123/profile HTTP/1.1
Host: mobile.omnicorp.com
Authorization: Bearer [Token]


HTTP/1.1 200 OK
Content-Type: application/json


{"profile": {"userId": "123", "email": "user123@example.com"}}
```

### 移动应用程序中的不安全通信

**观察到什么**

通过 HTTP 传输的敏感数据，公开登录凭据和会话令牌等信息。

**证据**

使用Wireshark捕获：

```
tshark -i eth0 -Y 'http.request.method == "POST" and http.request.uri contains "/api/login"'
 
  1 0.000000000 192.168.1.2 → 192.168.1.10 HTTP 150 POST /api/login HTTP/1.1 (text/plain)
  ...
  HTTP/1.1 200 OK
  ...
  username=user&password=pass123
```

### Telnet 暴露在 Internet 上

**观察到什么**

Telnet服务无需加密即可通过互联网访问。针对该服务的密码猜测尝试未成功。这些设备似乎是外围防火墙。

**证据**

```
Trying 203.0.113.5...
Connected to 203.0.113.5.
OmniCorp_Telnet_Server v1.2
login: 
```

**其他受影响的主机**

- 203.0.113.6
- 203.0.113.7

### 公开的管理界面

**观察到什么**

可以访问管理界面的未受保护的登录页面。此管理页面用于外围防火墙。

**证据**

```
GET /admin-login HTTP/1.1
Host: app.omnicorp.com


HTTP/1.1 200 OK
Content-Type: text/html


<html>
<head><title>Admin Login</title></head>
<body>
<form method="post" action="/admin-login">
    Username: <input type="text" name="username"><br>
    Password: <input type="password" name="password"><br>
    <input type="submit" value="Login">
</form>
</body>
</html>
```

### 网络设备中的默认凭据

**观察到什么**

可以使用默认凭据访问网络设备。这影响了内部网络上的交换机。连接到交换机的服务器包含生产环境的很大一部分，交换机的功能允许一定程度的流量操作。

**证据**

```
$ ssh admin@192.168.1.100
Password: admin
Welcome to OmniCorpRouter. Type 'help' for a list of commands.


OmniCorpRouter>
```

**其他受影响的主机**

- 192.168.1.105，端口 22
- 192.168.1.107，端口 2222

### 通过错误消息披露信息

**观察到什么**

详细的错误消息暴露了 Spring 框架的使用。

**证据**

```
GET /app/trigger-error HTTP/1.1
Host: app.omnicorp.com

...

HTTP/1.1 500 Internal Server Error
Content-Type: text/html


Exception in thread "main" java.lang.NullPointerException
    at com.omnicorp.app.MainClass.doSomething(MainClass.java:45)
    at com.omnicorp.app.WebHandler.handleRequest(WebHandler.java:58)
    at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:982)
    at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:861)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:634)
    at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:846)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:741)
    ...
```

**其他受影响的网页**

- /app/enable_flow
- /应用/disable_flow

# 2-查找 ID

在我们进入发现文章和他们需要涵盖的内容之前，我认为最好快速涵盖一些问题的元数据基础知识。首先：用于报表中结果的标识符 （ID）。

标识符用于为每个发现提供唯一的值，并作为客户和报告者的简单参考。除此之外，结果 ID 有时会扩展为包括一个额外的标识符，以显示它在评估的哪个区域（例如 Web 应用程序评估或基础结构评估）中发现，甚至还包括一个标识符来显示 bug 来自哪个评估。

在我看来，上述所有三个标识符至少出现在报告中非常重要，您是否选择将所有 ID 与报告问题以包含所有这些值的发现 ID 放在一起，但这完全取决于您。如今，正如我在课程的其他地方提到的，客户会将发现添加到他们选择的错误跟踪器中，并且他们通常会使用问题和报告元数据作为区分问题的方法。如果他们与少数供应商合作，全年为他们生成多个报告，这对他们特别有用。

下面是我所说的一个示例，其中报告 ID 为 AAA-001，评估区域为 2（我们审查 Web 应用程序的第二阶段工作，而不是基础结构扫描的第一阶段），结果 ID 本身为 3：

> AAA-001-02-003 - 匿名 FTP

或：

> AAA-001-2-3 - 匿名FTP

或者也许：

> AAA-1-2-3 - 匿名 FTP

我还看到过一些例子，其中评估区域 ID 已被删除，或者可能只是不需要，因为报告中只有一个工作阶段：

> BBB-03型

这里还有其他方法可以使标识符更清晰，但它们的代价是将“完整”标识符从结果本身移开。

一种方法是将报表 ID 删除到报表中包含评估元数据的其他位置，例如文档控制部分。这可以与评估名称、任何 SoW 或提案参考等信息一起存储。我从中看到的结果发现 ID 的干净版本是：

> 2.3

...尽管这可能会与一些基于文档的章节编号相混淆，这些章节编号通常遵循技术文档中的 X.Y 约定。

我还见过这样的情况：在你进入描述之前，调查结果在表格中有元数据，并且 ID 存储在那里，而调查结果的名称作为调查结果的标题位于前面和中间。

区域/阶段编号也可以从问题中删除，并保留在文档的章节标题中。您可能需要在诸如“请参阅 Web 应用程序评估部分中的发现 2”之类的调用中引用结果，只要文档采用具有文档导航的格式，处理起来就不算太糟糕。

那么，呈现查找标识符的最佳方式是什么？我认为我不能在这里给出一个好的答案。虽然我稍后会介绍一些缺点，但我认为这个问题的最佳答案是“视情况而定”。

首先，您应该确保所有报告的一致性，最好限制特定于客户的变体，因为这将很难维护（我有很多经验）。但是，您需要为客户识别特定标识符格式的潜在用途。

如果您希望能够帮助客户将问题复制到错误跟踪器中，那么将此信息放在一个地方可能会很好 - 而不是分散在报告的不同区域。但是，可能更有用的是能够提供包含每个发现所需的所有数据的电子表格，如果他们导入错误跟踪器，这可能对他们更有帮助。尽管某些格式可能会丢失，但您可以为电子表格导出构建完整的问题编号，如果您认为它成为问题，则将其排除在问题本身之外。

这里的另一个答案是——不要太担心。如果报告中的发现具有 ID 值，并且您很高兴它看起来不太可怕，并且/或者如果客户想要获取它，报告中存在其他必需的信息（阶段号和报告 ID），也许这不是问题。此外，如果你正在阅读这篇文章，而我所解释的内容对你来说都不是问题，那么你在这里可能都很好。

## 数字查找 ID 的问题

值得指出的是，使用数字标识符可能存在问题，尽管其中一些问题取决于您如何为查找结果提供标识符。

如果您发布具有顺序编号格式的报告，并且问题按严重性排序，则如果客户要求您删除问题（例如，误报），则可能会导致问题编号更改。如果先前报告的 ID 已用作参考，则以顺序格式更改后续问题的 ID 可能会导致冲突。解决这个问题的方法可能是在报告中将问题标记为误报，并在报告中更新各种计数，但是，如果客户希望它完全消失，您可能会有一些看起来很奇怪的东西。

例如，假设问题 2 和 3 被删除，这是结果列表：

- BWO-1-1 - SQL 注入
- BWO-1-4 - 跨站点脚本
- BWO-1-5 - 默认页面存在
- BWO-1-6 - 支持 TLS 版本 1.0

我怀疑大多数人会怀疑这里是否存在编号问题或报告中缺少问题。

如果您在最终版本之前多次向客户端发布更新（可能不寻常，但并非闻所未闻），也会出现这些问题。如果您提前告诉客户仅在最终报告最终确定和发布时使用查找 ID，则这不是问题。

如果您执行一些修正验证（也称为重新测试）并发现新问题，也可能会发生这种情况 - 您会把它放在哪里？我认为处理这个问题的最简单方法是为已识别的其他问题创建一个新的评估阶段，以将它们与发现的原始一批问题分开。

在某些情况下，用于跟踪问题的后端系统对每个发现使用数字 ID 值，但在输入 bug 时会给出该值。这将生成一个调查结果列表，这些发现将给出一个非顺序的顺序（可能），并且由于并非所有问题都会被报告（因为某些问题将被丢弃或保留以供进一步调查），这可能会给出一个看起来很奇怪的顺序。但是，对于客户来说，这些值是唯一的可能更明显：

- BWO-1-7 - SQL 注入
- BWO-1-4 - 跨站点脚本
- BWO-1-3 - 默认页面存在
- BWO-1-1 - 支持 TLS 版本 1.0

上面的列表看起来是随机的，但是当您考虑到它们将按严重性顺序排列在报告中时，很容易想象它们是非连续的和唯一的。

理想情况下，在数字报表中查找 ID 应是唯一标识符，以避免上述问题。这通常不难向客户阐明，并且应该在报告中给出。

## 另一种方法

以非数字或顺序的形式表示查找 ID 是避免上述所有问题的主要方法。这可以通过将标识符设置为字母序列的几个字母来实现，例如 XD 或 BHX。随机数字也可以像 424 或 345 一样工作。在这些情况下，关键是要确保给定报表不会重复任何值。

我认为这种方法对许多人来说有点太不同了。然而，这在许多层面上都是有道理的，考虑到所有组织识别其问题的方式，本课中提出的问题可能足够小，很容易解决。我猜大多数组织如何不遵循这种 ID 模式，也许你也不应该？

如果您想探索这种格式，这取决于您;但是，我将在整个课程中使用它。鉴于我们将处理大量不按顺序引用的示例结果，并且由于我们没有将结果组织到特定的报告部分（因为本课程不是报告文档），因此这种格式对于本课程来说不会那么混乱。

## 课程总结

那么，除了解释数字查找 ID 的优缺点之外，这里应该吸取什么教训呢？

- 理想情况下，问题应该具有某种形式的标识符，您和客户端可以将其用作参考
- 报告还应分解为逻辑区域或阶段，理想情况下，如果可能的话，这些区域或阶段应该有一个标识符供参考
- 总体报告应有自己的唯一标识符，供客户参考

这些应允许客户端为其使用构造唯一的结果 ID，或者您可以在报表中为客户端构造它们。关键是存在足够的元数据，以便他们能够这样做。

正如上一章所述，如果你能与客户交谈，询问他们将如何处理你的报告中的发现，也许你可以以一种更容易导入到他们的系统的方式向他们提供报告信息（例如，他们可以操作的电子表格）。


# 3-查找 ID - 练习

我们刚刚介绍了寻找身份证件的惊险本质。这里有一些练习给你。

**反思练习**

检查您最近撰写或有权访问的报告。根据上一课，您认为查找 ID 的呈现方式是否清晰、一致且易于引用？格式可以改进吗？如果是这样，如何？

**超越练习**

您是否有办法为客户导出结果列表，以便他们轻松地将结果导入其系统？如果没有，你能写一个吗？思考，CSV，JSON，XML等。

# 4-严重程度与风险等级

评级问题是任何安全评估的重要组成部分。它告知客户与评估的内容相比存在多少风险，并充当他们检查的分类列表，通常首先从最关键的风险开始。

我不认为我在整个行业中看到太多差异，当使用“关键”、“高”、“中”或“低”（或微妙的不同版本）等常见的“风险”评分系统时，如何对错误进行评级。

在本课中，我们将介绍如何使用这个久经考验的评级系统对调查结果进行评级。我们还将介绍其他一些评级系统，并考虑如何处理“良好”和“信息性”调查结果。

## 风险

“风险”评级系统使用以下公式：

> 风险 = 可能性 X 严重性

让我们来分解一下：

- 可能性：漏洞被利用的概率
- 严重性（也称为影响）：利用漏洞可能造成的损害或后果
- 风险：将“可能性”和“严重性”组合为分数的结果 - “严重”、“高”、“中”或“低”

这是表格中的样子（请原谅我糟糕的 excel 表格）：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231944793.png)

如果您熟悉此评级系统，您就会知道它提供了一定程度的灵活性和自由裁量权，这也是它优于其他系统的原因之一。

让我们回顾一下本章开头介绍的 OmniCorp 调查结果，并计算出它们的风险。

**可公开访问的 S3 存储桶**

- 可能性：中/高 - 对于攻击者来说，存储桶的名称并非不可能猜到，但也不完全容易。
- 严重性：高 - 存储桶包含一些极其敏感的数据。
- 风险：高/严重 - 根据存储桶的内容，我会将此四舍五入为“严重”。

**Linux 服务器上的弱密码策略**

- 可能性：中 - 虽然密码很常见，但攻击者需要在网络内部才能利用此密码。
- 严重性：低 - 虽然攻击者可以访问基础主机上的低特权帐户，但主机本身并未使用。
- 风险：低 - 鉴于主机上有其他上下文，并且没有其他主机受到影响，这可能是一个孤立的情况。

**Windows Server 漏洞，由于多个缺失修补程序（包括关键 MS17-010）而导致**

- 可能性：中 - 攻击者需要在内部网络上才能利用此问题。
- 严重性：高 - 鉴于这是整个生产网络的域控制器，此漏洞的影响将非常高。
- 风险：高/严重 - 可以提出一个论点，使这成为一个关键问题。但是，根据在内部网络上的要求，我会选择高。

**API 终端节点返回所有用户数据**

- 可能性：高 - API 端点可通过 Internet 访问，只需代理流量即可找到。
- 严重性：高 - 应用程序返回有关所有用户的数据，包括电子邮件地址。
- 风险：高/严重 - 从 GDPR 的角度来看，此问题可能很严重，因为个人数据可能已暴露给未经授权的用户。

**在论坛软件上存储跨站点脚本**

- 可能性：高 - 鉴于论坛评论无法抵御跨站点脚本攻击，新手攻击者可以利用此漏洞。
- 严重性：高 - 由于根本没有保护措施，攻击者可以使用多种类型的攻击。最糟糕的是，他们能够从用户那里窃取会话令牌并作为他们进行身份验证。他们甚至可以进行虚假登录以窃取凭据。
- 风险：严重 - 此漏洞的潜在损害具有重大潜力。

你会注意到，我和自己争论一些收视率。对于这个评级系统来说，这是非常普遍的，因为当问题似乎介于两个严重性级别之间时，通常会对问题进行评级。

## 假设违规和内部威胁

近年来出现的一种理念是零信任。这个概念指出，网络本身应该被认为是敌对的，组织应该认为它们已经被破坏了，并认为员工本身就是攻击者。这是对外围安全控制的有效性和有效性的范式转变，并要求在外部和内部进行严格的控制。

我亲眼目睹了这种转变如何对风险评级产生有趣的影响，客户希望将这一理念应用于调查结果。

让我们回顾一下之前的发现，并根据这种零信任心态重新评估它们。

**可公开访问的 S3 存储桶**

- 可能性：高 - 如果我们假设具有 AWS 访问权限的恶意内部人员可以获取存储桶的名称，他们可能能够轻松访问存储桶内容。
- 严重性：高 - 存储桶包含极其敏感的数据。
- 风险：严重 - 我觉得这比以前稍微严重了一点，但不是很多。

**Linux 服务器上的弱密码策略**

- 可能性：高 - 如果我们假设攻击者已经在内部（员工或突破边界的攻击者），则通过密码喷射攻击成功破坏 SSH 的机会很高。
- 严重性：低 - 虽然攻击者可以访问基础主机上的低特权帐户，但主机本身并未使用。
- 风险：低/中 - 尽管可能性发生变化，但主机的价值对攻击者来说仍然很小，即使它们位于内部网络上。

**缺少修补程序的 Windows Server**

- 可能性：高 - 如果我们假设攻击者已经在网络上，他们将能够轻松利用此漏洞。
- 严重性：高 - 鉴于这是整个生产网络的域控制器，此漏洞的影响将非常高。
- 风险：严重 - 当您认为外部或内部攻击者有权访问网络并可以访问域控制器时，前面关于严重性的论点将失效。

**不带身份验证的 API 端点**

- 可能性：高 - API 端点可通过 Internet 访问，只需代理流量即可找到。
- 严重性：高 - 应用程序返回有关所有用户的数据，包括电子邮件地址。
- 风险：高/严重 - 由于此问题是外部面临的，因此假设违规/内部威胁理念不会改变此问题的风险。特别是考虑到这个问题的可发现性。

**在论坛软件上存储跨站点脚本**

- 可能性：高 - 鉴于论坛评论无法抵御跨站点脚本攻击，新手攻击者可以利用此漏洞。
- 严重性：高 - 由于根本没有保护措施，攻击者可以使用多种类型的攻击。最糟糕的是，他们能够从用户那里窃取会话令牌并作为他们进行身份验证。他们甚至可以进行虚假登录以窃取凭据。
- 风险：严重 - 与上一个问题一样 - 由于此问题是外部面临的，因此假设违规/内部威胁理念不会改变此问题的风险。特别是考虑到这个问题的可发现性。

------

您将看到，对问题所做的调整主要影响内部托管的服务/应用程序/等，或者作为“内部人员”可能会让您更深入地了解发现或利用漏洞的区域（调整的可能性增加）。外部面临的明显或微不足道的漏洞以及对攻击者几乎没有价值的内部漏洞仍然不受影响。

## CVSS系列

我不认为我可以在不涉及 CVSS 的情况下上一堂关于风险评级的课。CVSS（或通用漏洞评分系统）是一种开放标准，它提供了一种公式化方法来确定基于风险的评分。

该标准经过多年的发展，并进行了调整，以应对安全环境的变化，并解决漏洞的不同性质。这当然是 CVSS 版本 2 和版本 3 中的一个问题。我无法对 CVSS 版本 3 或 4 的使用发表评论，但我可以肯定地说，对于 2 来说，报告几个不符合所需标准的漏洞是相当痛苦的，尤其是代码审查和 Web 应用程序漏洞。

虽然 CVSS 过去显然存在一些缺点，但它确实为组织提供了一种更准确地评估漏洞的方法，并提供更一致的风险评级。在上一节中，我不得不与自己讨论什么是可能的，什么是不可能的——CVSS 将强制执行更严格的标准，从而产生更具确定性的漏洞评分——这对组织来说更有用。

可悲的是，“风险”系统的灵活性意味着业内对 CVSS 有很多鄙视。CVSS 通常被视为一种降低风险的手段，以避免不得不修复重大发现，或者是一种用于降低安全研究人员工作的价值和影响的工具。此外，这个评级系统还有一点学习曲线，因为与“风险”系统相比，它非常复杂，有许多指标和修饰符，都有自己的值。

不管你喜不喜欢，如果你是一个渗透测试人员，你将来可能会遇到这个评级系统。如果你想了解它，你可以在这里找到一些详细信息 - https://www.first.org/cvss/

## 客户的风险评级系统

并不是说我在这里可以给你很多建议，但有时你可能需要使用客户的内部评级系统，或者根据客户自己的指标将熟悉的风险评级应用于问题。在某些方面，我觉得这些系统是客户自己对 CVSS 的实现。

这是我比我认识的大多数顾问要做的事情，值得庆幸的是，我花了很多时间与某些客户打交道，以至于我很容易摆脱看待问题及其风险的正常方式。对于其他顾问来说，他们会短暂地加入我从事的长期项目，他们很难重新连接他们的大脑。

虽然以不熟悉的方式进行评级问题可能会非常痛苦和令人沮丧，但我们需要记住，客户是出于自己的原因形成评级的，我们需要支持他们。我见过这些没什么意义的案例，但其他一些案例确实如此。尽管每个客户对风险的看法不同，但这些系统几乎总是用于某种内部风险登记或分类过程。这使他们能够从许多来源（自动化工具、内部测试团队、第三方评估供应商等）获取漏洞信息，应用相同的评级系统，并在所有来源上获得一致的评级。

与往常一样，请务必联系您的客户，就您不确定可能存在的风险的情况寻求任何指导。最好寻求帮助并评价错误的东西，然后在评估完成后处理恼火的客户。

## 信息发现

信息性发现有时会在报告中提出，其中测试人员观察到一些没有与之相关的安全风险，但可能需要客户进行调查。

多年来，我一直喜欢在报告中报告信息问题，但随着时间的推移，我觉得它们在报告中的价值微乎其微。当您认为信息问题没有与之相关的安全风险时，这意味着出于安全评估的目的，不需要对发现进行补救 - 如果是这种情况，为什么要报告它？

解决这个问题的一个好方法是，如果发现有丝毫的安全问题，要么将风险提高到“低”，要么放弃报告发现。如果该项目值得向客户提及，但在报告中没有任何相关性（无论是作为发现、警告还是其他内容），您可以通过电子邮件向客户发送有关它作为提醒。

## 良好的发现

我过去曾看到过“良好”风险评级的概念，所以值得一提。这对我来说有点过时，但由于我使用过的报告要求，我有偏见。当我们谈论“发现”时，对我来说，这是需要补救的事情。对于任何与之相关的潜在安全风险（从关键到低），甚至可能是信息发现（本质上是他们调查或注意的项目，尽管如前所述，如果可能的话，我宁愿跳过这些），但对于“好”发现，没有什么可做的或采取行动。这让我觉得它们的使用与报告中更广泛的调查结果列表不一致。

我认为最好在执行摘要或报告顶部的单独部分讨论高层次的“良好”做法，而不是将它们作为具体问题。但是，只有在您确实有证据证明的情况下，才提及“好”的事情。

## 忽略低风险问题

多年来，我与许多顾问交谈过，我听说过几次，一些低风险或无关紧要的问题没有被报告。我不确定这种做法在整个行业中有多普遍，但原因是他们不想用对他们的风险状况没有任何实际影响的发现来打扰客户。

最初，有些评论对我来说是有道理的，但过了一会儿，这种做法让我感到震惊。作为安全专业人员（或者即使您在内部团队工作），我们也应该强调在参与过程中发现的任何风险。由客户团队选择他们想要对结果执行的操作以及是否要对其进行补救。如果我们觉得发现存在安全风险，即使它是微不足道的，我们当然有责任报告它吗？

如果未报告的 bug 曾经被利用或用作针对客户端的更广泛攻击的一部分，这对测试团队来说可能是非常糟糕的。此外，如果客户将来由不同的测试人员（来自同一测试供应商或其他测试供应商）进行测试，则未报告的结果将显示出来的风险也会增加。鉴于这些风险较低的问题很容易找到，一些客户可能会惊讶地看到它们以前没有被发现。

我怀疑过去一些客户已经推迟了低风险问题，这就是为什么选择省略某些类型的调查结果的原因。但是，在这些情况下，我倾向于在特定客户的基础上应用这一理念，而不是一刀切地应用这一理念，事实上，请确保您警告客户，从报告中省略问题可能会有风险。

## 课程总结

我们必须正确地对问题进行评级，因为这将影响客户在确定何时应该解决的问题时做出决策。如果未以正确的方式对结果进行评级，则重大风险可能会存在足够长的时间，以至于攻击者可能会利用它。使用您不熟悉的风险评级系统时，请确保在对调查结果的风险进行评分时仔细考虑。如果您在这里犯了错误，这可能会导致您不得不重新进行分析。如果客户认为您歪曲了调查结果的风险，则可能会发生这种情况。或者，如果某些调查结果的评分太低，客户可能不会给予适当的关注。关于低风险问题的话题 - 不要代表客户做出决定并省略调查结果，始终报告您认为有风险的调查结果，无论多么小。

# 严重性和风险评级 - 练习

这是一堂关于如何评价问题的相当长的课。

让我们做一些练习来练习对问题的评级，并考虑我们涵盖的其他主题。

**反思练习**

- 查看您编写或有权访问的报告。调查结果描述是否与给定的风险级别匹配？
  - 如果没有，你能纠正它们吗？
  - 如果你不确定，这是为什么？缺少哪些信息可以帮助您确定更准确的风险评级？
- 查看您编写或有权访问的报告。它是否提出了任何“良好”或“信息”问题？你觉得他们为报告增加了价值吗？或者，根据上一课，您觉得它们可以移动到报表中的其他位置或完全删除吗？
- 查看您撰写或有权访问的报告，重点关注分配给每个发现的风险评级。对调查结果的可利用性提出一些假设的缓解措施或更改 - 风险评级会改变吗？

**一般练习**

- 使用风险评级系统对 OmniCorp 章节示例结果进行评分。
  - 以与课程相同的格式，给出可能性、严重性和风险的理由。
- 使用假设违规/内部威胁方法对 OmniCorp 章节示例发现进行评分。
  - 以与课程相同的格式，给出可能性、严重性和风险的理由。

**超越练习**

- 研究和了解 CVSS（最好是最新版本）
- 回顾上一课中的示例问题 - 你能在 CVSS 中对它们进行评分吗？

# 6-其他查找元数据

我们刚刚介绍了风险评级以给出一个发现，但我认为可能值得非常快速地涵盖我偶尔看到的其他特定于发现的元数据。值得指出的是，我也看到了相反的情况，报告的调查结果中几乎没有元数据 - 只是一个风险评级。

一些供应商发现将这些附加信息打包并放在调查结果旁边很有用，这样客户在对调查结果进行分类时可以为客户提供更多的背景信息。在某些情况下，客户将能够使用这些来深入了解给定漏洞的风险是如何获得的，以及他们的下一步可能是什么。

让我们来看看我见过的一些最常见的元数据。

## 影响

影响（或我在本课程中所说的严重性）通常采用“低”、“中”或“高”的格式。这通常是测试人员用来计算给定问题风险的等式的一半。有关此内容，请参阅“严重性和风险评级”课程中的精彩表格。

## 可利用性/可能性

与“影响”类似，可利用性或可能性通常可以用大致相同的方式表示。同样，请参阅“严重性和风险评级”课程中的表格。潜在值可以是“低”、“中”或“高”，也可以是“理论”、“未证实”、“可能”、“可能”、“确认”或“确定”。

## 类别

有时，给定漏洞的类别与调查结果一起提供。我在课程的前面谈到了这一点，以及根据发现的问题的“类型”来分解调查结果是如何有用的，这就是这些信息的来源。

我见过这里使用了多种不同的值，比如来自 OWASP Top 10（以2021年版为例）的名称：

- 访问控制失效
- 加密失败
- 注入攻击
- 不安全设计
- 安全配置错误
- 易受攻击和过时组件
- 身份验证与认证失败
- 安全日志与监控失效
- 服务器端请求伪造

……或者更为宽泛的类别，如：

- 身份验证
- 授权
- 加密
- 补丁管理
- 日志记录

- 等等

使用类别有相当大的价值，然而，挑战在于确保类别列表不会太长，但足够大，以便能够合理地对一系列发现进行分组。

## 需要的修正工作

有时，在估计开发或工程团队解决问题所需的工作量时，会涉及猜测。我总是有点不确定是否建议这种数据，因为在补救措施方面，我们真的永远无法确定团队的能力和优先级。如果客户同意我们只能提供 T 恤尺寸（S、M、L、XL）的粗略估计，并理解我们的知识有限，那么它应该是可以接受的。

显然，客户需要对问题进行自己的调查，以亲眼看看他们将如何计划工作以及他们认为修复它需要多长时间，但测试团队的一些评论可能有助于初步了解这项工作可能是什么。

## CVSS 分数字符串

还记得您刚刚完成的 CVSS 练习吗？如果报告对 CVSS 问题进行了评分，则最好不仅提供分数名称（“严重”、“高”、“中”、“低”、“无”）和十进制数（从 10.0 到 0.0），还要提供等式中给出的所有值的字符串。这可能看起来像这样（对于版本 3.1）：

> CVSS：3.1/AV：N/AC：L/PR：N/UI：N/S：U/C：H/I：H/A：H

我会让你计算出最终的分数以及这一切意味着什么。

## 修复验证状态

如果一份报告已发布给客户，客户已修复了一些问题，且测试团队已进行了某些修复验证（又称重新测试），那么在报告中记录发现项的状态并非罕见做法。

可能的值包括：

- Open（未解决）
- Part Closed（部分关闭）
- Closed（已关闭）
- False Positive（误报）

这样，报告读者就能看到对于给定问题列表，当前存在的开放风险的最新状态。我们将在后续几章中深入探讨修复验证。

## 课程总结

虽然调查结果可以简单地从风险评级分数和标题开始，但在这里，我们展示了如何为客户提供额外的有用元数据，以帮助他们一目了然地了解调查结果。其他元数据在调查结果本身中也很有用，可以涉及修正工作，甚至可以触及调查结果的状态。值得注意的是，我们永远不会真正知道为给定的客户修复某些事情是多么容易或困难，我们应该在报告中提出适当的警告来提及这一点。

# 7-其他查找元数据 - 练习

上一课介绍了一堆额外的元数据，你可以附加到问题上，以便为客户端提供更好的上下文。

让我们做一些练习，看看你过去看到了什么，并练习应用它们。

**反思练习**

- 反思您最近撰写或有权访问的报告。它是否在具体调查结果中包含了任何其他元数据？
  - 如果没有，是否可以将“影响”、“可利用性”和“修正工作”添加到调查结果中？

**一般练习**

- 创建一个可能包含在报告中的漏洞类别列表。确保该列表既全面又不过于冗长，以便对发现项进行合理的分组。

  对于 OmniCorp 章节练习中的每个发现项，请应用以下元数据：

  - 影响
  - 利用难易度
  - 类别（使用您刚刚制作的列表）
  - 修复工作量

# 8-标题

所有发现都需要给它一个名字，这样做并不难。尽管如此，标题可能需要考虑以下几个方面：

- 格式
- 措辞
- 详细查找标题

让我们来看看它们。

## 格式

我在课程的其他地方已经谈到了如何命名部分，所以请将其视为一个温和的提醒，因为这里同样适用。

有三种方法可以做到这一点：

- 所有关键词均大写。介词（例如“in”、“under”、“without”）和冠词（例如“a”、“an”）或其他 3 个字符或更少的单词不大写。
  - “客户配置文件页面中的 SQL 注入”
- 所有单词均大写。
  - “客户配置文件页面中的 SQL 注入”
- 标题更像是一个句子而不是一个标题，我会避免这样做。
  - “客户资料页面中的 SQL 注入”

我通常用第一种格式写标题。这是技术报告写作的一种非常常见的格式，但是，第二种格式已被更多地采用。我不完全确定这是因为对团队说“将标题的所有单词大写”更容易，或者在第一种格式中是否发生了错误或不一致。在我看来，无论哪种方式都可以，正如我之前提到的——一致性是关键。

就我个人而言，我不喜欢第三种格式。这似乎太像一个被用作标题的句子了。我不想这么说，但如果你与这种格式保持一致，它可能没问题，只是我注意到它不是经常使用的（而且我认为它在报告中看起来并不那么好）。

## 措辞

报告中查找标题的措辞方式感觉很重要，主要是为了避免问题标题太长或太模糊。我坐下来思考了我过去看到的一些不好的例子（或者一些我可能考虑过写的例子），所以我可以在这里提供一些智慧。

这是我想出的：

- 跨站点脚本可从用户的个人资料页面利用
- 搜索功能容易受到 SQL 注入的影响
- 允许匿名访问所有患者数据
- 使用过时的第三方库的 Web 应用程序
- 应用程序无法保护静态和传输中的 PII

标题本身内容丰富，但对于其预期目的来说可能过于冗长。简明扼要，使标题更清晰：

- 配置文件页面中的跨站点脚本
- 搜索函数中的 SQL 注入
- 匿名访问患者数据
- 过时的第三方库
- 无效的 TLS 证书
- PII 在静态和传输中不受保护

在上面的例子中，我删除了诸如“易受攻击”和“可利用”之类的词——鉴于我们将它们作为调查结果提出，这两个词都是隐含的。其他多余的词（如“允许”或“Web 应用程序”）也同样被删除，因为它们在报告的上下文中应该是显而易见的。“应用程序失败”也是如此 - 如果它没有失败，那么我们就不会有发现。

## 详细查找标题

您会注意到，在上面的示例中有一些特别命名的发现（从某种意义上说，我指出了受给定错误影响的特定区域）。当有一个特定的函数或“事物”是易受攻击的，并且能够以这种方式被调用时，我认为这样做是可取的。它有助于显示漏洞发生的位置，并表明此实例可能是少数孤立案例之一。当您有一个或多个 bug 类示例时，这很有帮助，但它不够多产，需要过于高级的查找。

考虑确定是否需要更详细的标题的方法是考虑以下问题：

- 是否存在一个 bug 实例？
  - \> 否 - 使用包含细节的标题提出。
  - \> 是 - 发现的实例是两个还是三个之一？
    - \> 是 - 考虑使用包含细节的标题单独提出调查结果。
    - \> 否 - 提出一般性发现并引用发现的实例（在发现本身或附录中）。

何时考虑单独筹集或不考虑单独筹集的门槛可能有所不同，但我会记住的是：

- 这些错误是否彼此明显不同，或者就错误的位置或表现形式而言，它们应该单独提出？例如：
  - 该错误位于同一测试的不同部分或完全不同的 Web 应用程序中
  - 该漏洞的发现和/或利用表明，潜在的发现略有不同
- 这些错误会以不同的方式修复吗？如果是，单独饲养可能更有意义

同样，这些都是小细节。但作为一个长期痴迷于报道的人，它们是我思考的事情。

## 课程总结

在报告写作中，可能比标题看起来更重要的事情需要担心，但是，通过一些简单的调整，本节可以很容易地提高专业性和清晰度的感觉。以更直接、更简洁的方式编写标题感觉更干净，并且使用一致的格式来查找标题（以及报告部分）将避免使文档看起来很草率。如果提出相似但又不同的错误，以便它们在自己的发现中有意义，那么标题中有一些细节是值得的（例如，漏洞的发现地点）。

# 9-标题 - 练习

在上一课中，我们仔细研究了研究结果的标题。我们研究了它们的格式、可能包含的细节以及如何使它们更简洁。

这里没有太多值得赘述的（谢天谢地），所以给你一些简单的练习。

**反思练习**

查看您撰写或有权访问的报告，并查看调查结果的标题。您认为这些标题的格式和措辞是否符合推荐的方法？它们是否清晰、简洁和一致？是否可以根据上一课所涵盖的内容进行改进？

**一般练习**

- 根据上一课中概述的内容，重写以下查找标题，使其更加简洁和准确：
  - “发现用户个人资料页面中存在跨站脚本漏洞”
  - “在搜索功能中发现 SQL 注入漏洞”
  - “已发现匿名用户可以访问所有患者数据”
  - “Web 应用程序当前正在使用过时的第三方库”
  - “该应用程序没有充分保护静态和传输中的个人身份信息”
  - “由于存在无效的TLS证书而导致的加密漏洞”
  - “由于未受保护的管理员凭据导致数据泄露的潜在风险”
  - “用户认证措施不足导致安全风险”
  - “通过不安全的 API 端点过度暴露数据”
  - “缺乏适当的输入验证导致多个安全漏洞”
- 查看 OmniCorp 章节练习的标题并应用您喜欢的格式。

# 10-影响和背景

我编写这门课程的主要驱动力之一是教育测试人员了解我们应该给客户带来的上下文影响的重要性。一份好的报告和一份好的报告之间的区别通常取决于评估团队对客户所做的事情和对他们来说重要的程度，然后确保任何重大问题都与这些信息在安全风险方面联系在一起。

还记得我们曾经报道过与客户进行启动电话会议并提出问题吗？在这次电话会议中获得的信息应反映在调查结果中，当提出调查结果时。这允许以一种超越基本意义上的“为什么问题很糟糕”的方式编写调查结果，并有助于回答“这将对我们的用户、数据、服务或基础设施产生什么影响？”的问题。

现在，执行摘要很可能触及了这些事情，（它应该这样做），但考虑一份包含数十项调查结果的大型报告。通常没有简单的方法来总结所有问题及其各自的影响。此外，请考虑可能会从报告中删除问题并添加到错误跟踪器中，而不会影响手头的执行摘要中的上下文影响。

由于这两个原因，调查结果应包含更多关于如果问题被利用可能发生的后果的进一步后果的信息。调查结果应包括攻击者的下一步可能是什么，或者他们现在处于什么位置来追求客户最关心的事情。这样一来，孤立地阅读问题的人就不需要回到执行摘要中的参考后果，因为所有内容都包含在问题中。

强调这一点的最常见方法是将问题的描述分为两部分：

- 影响
- 描述

在此结构中，影响可以包含潜在的攻击和上下文影响。而描述坚持问题所在，并包含更详细的解释。

如果使用这种方法，则可能会有影响和描述可能有一些重复的措辞。虽然最好避免这种情况，但如果可能的话，为了能够从报告中抽出部分内容并单独理解，一定程度的重复可能是有益的。

我见过一些供应商使用两个单独的部分来表示影响和描述，虽然很常见，但我想说的是，影响信息总是非常笼统，对更广泛的影响没有太多讨论（稍后会详细介绍）。

我首选的方法是确保描述的第一段包含客户了解安全问题是什么、为什么不好以及对其更广泛的资产、数据和用户的影响所需的所有内容。我怀疑这种方法并不适合所有人，因为你最终可能会有一些更大的初始段落，但是，我实际上并没有看到这种方法被客户自己推翻。这种方式的好处是，如果你从每个发现中提取第一段，你应该能够让非技术读者充分了解问题是什么和影响（随着发现的技术部分稍后出现，我们将在后面的课程中介绍这个结构）。

无论上述两种方法如何，或者即使您采用不同的格式来捕获此信息，确保您在报告中捕获了此信息，都会大大提高其价值，因为您可以以大多数测试人员忽略的方式与客户的特定资产和资产交谈。

## 影响更广

当我们查看安全发现的描述时，我们通常会看到以下几点：

- 问题是什么？
- 为什么不好？
- 攻击者可以做什么？

最后一点通常是笼统的，没有探讨它们在开发后可能造成的进一步后果和损害。正因为如此，它变成了一种更温和的影响，而不是探索攻击者可能产生的更广泛的影响，而攻击者可能处于进一步利用的新位置。我们应该努力在执行摘要中阐明，最好是在调查结果本身中阐明，如果攻击者利用漏洞，对客户来说最糟糕的情况是什么。

让我们考虑一下 OmniCorp 评估的结果之一。

以下是对上下文和问题的提醒：

**评估内容**

> OmniCorp 是一家技术公司，提供多种存储解决方案，可满足多种类型的组织数据需求。其中包括基于文件的存储、医院成像托管和任意数据的常规日志记录存储。正因为如此，OmniCorp 拥有广泛的客户。

**AWS 范围**

> - AWS 配置审核（所有账户）
>   - OmniCorp 面向公众的所有网站都存储在 AWS 上。
>   - 一些开发人员和其他员工可以在 AWS 中建立基础设施。
>   - 有一条从 AWS 到本地环境的路由，该路由是存储所有数据的地方。

**结果：可公开访问的 S3 存储桶**

> 在 AWS 配置审查期间为 OmniCorp 发现了一个 S3 存储桶。无需互联网上任何人的身份验证即可访问存储桶。它包含一份关于最近发生的违规行为的机密报告以及所有员工的工资信息。违规报告显示未修补的外部漏洞，这些漏洞将允许攻击者进入网络。

**证据**

> ```
> $ aws s3 ls s3://omnicorp-private-files
> 2024-01-28 12:35:29      1024 confidential_report.pdf
> 2024-01-29 08:15:47      2048 employee_data.xlsx
> ```

以下是我通常看到的格式对这一发现的潜在描述：

> 发现了一个可公开访问的 S3 存储桶。Internet 上任何能够猜出存储桶名称的用户都可以访问和下载 S3 存储桶中的所有文件。该存储桶包含所有员工的工资单信息，以及最近的渗透测试报告的结果，其中包含几个未修补的外部漏洞。

这个描述并不可怕，但可以更好。当测试人员读到这一发现时，我们自然会想到可能发生的最坏情况，并假设报告的读者会分享我们的思维过程。我们不应该假设这一点。相反，我们应该对接下来可能发生的事情提出合理和现实的建议。

如果我们再次回顾一下 OmniCorp 的背景，我们就会了解他们应该关心保护的关键事项：

> OmniCorp 是一家技术公司，提供多种存储解决方案，可满足多种类型的组织数据需求。其中包括基于文件的存储、医院成像托管和任意数据的常规日志记录存储。正因为如此，OmniCorp 拥有广泛的客户。

回顾这个漏洞以及我们从中获得的信息，我们可以利用什么来对客户进行进一步的攻击？

- 利用未修补的外部漏洞访问可能存储敏感客户数据的内部网络。
- 使用员工信息对外部基础设施执行密码猜测攻击或网络钓鱼攻击，以期进入生产网络。

让我们在描述中考虑这些背景和其他影响，并触及进一步的风险可能是什么：

> 发现了一个可公开访问的 S3 存储桶。Internet 上任何能够猜出存储桶名称的用户都可以访问和下载 S3 存储桶中的所有文件。该存储桶包含所有员工的工资单信息，以及最近的渗透测试报告的结果，其中包含几个未修补的外部漏洞。利用这些信息，攻击者可以尝试通过利用上述外部漏洞或根据工资单信息的内容对用户进行网络钓鱼和密码猜测攻击来访问互联网。如果攻击者得逞，无论是获得对生产网络的访问权限还是破坏用户的访问权限，内部网络上的敏感客户信息都可能面临泄露的风险。

在这里，我们添加了有关攻击者下一步可能采取的措施的信息，即利用漏洞的结果（在本例中，访问包含有用信息的敏感文件），然后将其联系起来，以显示 OmniCorp 敏感数据可能面临的风险。

如果没有这些信息，客户有时会说“那又怎样？”，因为他们的心态与黑客不同。这不是他们的错。作为安全专业人员，我们应该运用我们的知识和经验来了解我们可以从单个漏洞中利用什么，以及如何利用它来进一步破坏更多的资产。

值得注意的是，如果您确实有一些信息（但不足以自信地写作）来表明**可能会**发生某些事情，您有几个选择：

- 与客户确认您的理解。
- 注意报告中的措辞。
- 从报表中删除建议。

在这里，第一个选项始终是首选，而不是冒着增加描述文本并带有警告或完全删除重要上下文的风险。

## 但是我对我的客户一无所知？

为了让自己能够深入了解攻击者可能采取的潜在攻击路径，您需要了解您的客户。如果您不知道客户除了您正在审查的东西的安全性之外还关心什么，那么您可能无法为他们提供最佳价值。如果是这种情况，您可能无法谈论这些要点。

这就是为什么与客户进行启动电话会议如此重要的原因，这不仅仅是基本的项目管理步骤，而是要就您正在评估的内容和更广泛的环境进行体面的对话（这里有一个复习）：

- 你在审查什么，它有什么作用？
- 解决方案处理或有权访问哪些类型的数据？
- 解决方案部署在哪里？（例如本地/云供应商和区域）
- 解决方案由哪些组件组成？（服务、软件、其他）
- 有多少用户和哪些类型的用户使用该平台？
- 如果您正在查看更广泛系统的一小部分，请向更广泛的系统提出这些问题。

此问题列表可用于帮助您入门，不应将其视为详尽无遗。你知道的越多，你的问题就会越好，你甚至可以提出可能影响你的客户的问题，如果不先进行这种类型的对话，你就不会想到这些问题。

## 课程总结

在撰写调查结果时，我们应该努力使它们尽可能针对客户。这应该从背景和影响两个方面来完成。由于客户没有知识来了解如果漏洞被利用可能会发生什么坏事，我们应该花时间解释这一点。解释应具体到攻击者可能对我们正在评估的客户端执行的操作。他们能否接触到他们认为敏感或想要保护的东西？他们现在是否能够利用其应用程序、服务或环境的其他部分？调查结果中的这些附加信息极大地提升了它们对客户的价值，并使其更清楚地了解其环境中漏洞的后果。

# 11-影响和背景 - 练习

在上一课中，我们介绍了如何通过反思我们对给定客户端的了解来增强潜在影响，从而提高安全发现的质量。

以下是一些需要考虑的练习（请注意，我们将把 OmniCorp 调查结果的任何影响信息的写作保存到下一课之后）。

**反思练习**

- 反思您撰写或有权访问的报告。在回顾调查结果时，您认为上下文影响可以改进吗？
- 反思最近的一次参与。你是否觉得你对一个客户有足够的了解，以至于你可以扩大调查结果的影响？

**超越练习**

- 调查最近备受瞩目的安全漏洞。从对公司及其客户的更广泛影响的角度分析违规行为。这怎么能在报告中传达出来？

# 12-描述

这是整个课程中最重要的课程之一。我们将介绍如何掌握报告中安全发现的描述：

- 以一种易于记忆的方式
- 允许不同的受众解释调查结果
- 在某种程度上，该描述可以作为其开头段落中发现的惊人总结

在所有问题写作领域中，我认为这是在彻底性或质量方面有最大改进空间的地方。

本课将分为三个主要方面：

- 描述的开头段落
- 描述的更多细节
- 例子

描述的两个部分都很重要，最好分开解决，以尽可能清楚地说明这两个部分需要什么。

## 首段

给定问题的开头段落对于正确处理很重要。它们是首先要阅读的内容，如果操作正确，读者可以选择是否需要阅读其余的发现细节或转到另一个问题。

正如我在本课程中所说，有不同的方式来呈现相同的信息，这很好。出于本课程的目的，我将以两种方式介绍描述部分：

- 仅限“说明”
- “影响”和“描述”分为各自的部分

这些是我在报告中看到的发现的初始部分最常见的格式。虽然“影响”可以被认为是与“描述”分开的，但我认为保持它们密切相关很重要，因为它们所包含的信息可以很好地互补。

首先，让我们研究一下这两种方法的这些初始段落应该是什么样子。

### 仅说明部分

要构建草稿的开头段落，最容易通过回答几个问题来实现。完成后，可以合并和优化答案以创建单个段落。在完成这一段之后，我们可以对调查结果进行更详细的分析，并包括任何证据。

以下是以下问题：

- 结果是什么？
- 为什么不好？
- 如果利用这一发现，对业务、用户和/或数据有什么影响？根据系统的了解，可能发生的最糟糕的事情是什么？
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？

让我们回顾一下评估上下文中的一个示例，以回答这些问题：

**评估背景**

这些示例问题是在对一家名为 OmniCorp 的组织进行多阶段评估时发现的。OmniCorp 是一家技术公司，提供多种存储解决方案，可满足多种类型的组织数据需求。其中包括基于文件的存储、医院成像托管和任意数据的常规日志记录存储。正因为如此，OmniCorp 拥有广泛的客户。

**评估范围**

以下列表显示了评估的范围，以及有关评估期间或从客户那里了解到的上下文的一些附加信息：

- AWS 配置审核（所有账户）
  - OmniCorp 面向公众的所有网站都存储在 AWS 上。
  - 一些开发人员和其他员工可以在 AWS 中建立基础设施。
  - 有一条从 AWS 到本地环境的路由，该路由是存储所有数据的地方。
- 内部和外部漏洞扫描
  - 外部：所有 AWS 资产和 OmniCorp 的 DMZ 都来自其本地托管生产网络。
  - 内部：扫描其本地托管生产网络。这是存储所有用户数据的地方。
- Windows Server 内部版本评审
  - Windows Server 2022 的黄金构建映像。
- Linux 服务器构建审查
  - Ubuntu Server 的黄金构建映像的配置审查。
  - OmniCorp 对 Linux 的主要用途是运行 Ceph 进行存储，以支持其为客户存储数据的主要应用程序。
    - https://ceph.io/en/
- 论坛软件 Web 应用程序评估
  - 内部论坛软件解决方案的 Web 应用程序评估。
  - 仅用于客户支持。
  - 解决方案后端是用 Java 编写的，具有简单的 jQuery 和 Bootstrap 前端。
- API 评估
  - API 审查 API，该 API 支持与移动应用程序之间的通信。
  - 该 API 用于从本地环境中检索数据，并托管在 AWS 中。
- 移动应用程序评估
  - 该移动应用程序仅适用于 Android，并且是用 Java 编写的。
  - 它为移动设备上的 API 提供前端。

注意：对其主网站的 Web 应用程序评估不在本次审查的范围内。

**发现-** Windows Server 漏洞，由于多个缺失修补程序（包括关键 MS17-010）而导致

**观察**

对 OmniCorp 网络中的 Windows Server 进行的 Nessus 扫描显示，缺少许多关键的缺失安全补丁，包括修复 MS17-010 的补丁。这表明服务器没有及时更新必要的安全更新。主机是生产环境的域控制器。进一步的测试表明，该服务器可以利用此漏洞。

**证据**

Nessus：

```
Nessus Scan Report:
Host: 192.168.1.10
OS: Windows Server 2019
Vulnerability: MS17-010 - Critical
Description: Security Update for Microsoft Windows SMB Server (4013389)
Severity: Critical
```

Metasploit：

```
[*] 192.168.1.100:445   - Scanning for vulnerabilities...
[*] 192.168.1.100:445   - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 (64-bit)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

根据以上信息，我们来回答一下相关问题：

- 结果是什么？
  - 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。
- 为什么不好？
  - 如果攻击者利用此发现，他们将控制域控制器。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？接下来可能发生的最糟糕的事情是什么？
  - 鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用 Windows LDAP，破坏域控制器的攻击者将能够利用此方法访问环境中的所有主机。这将包括保存客户数据的后端数据存储。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 由于公开可用的工具的可用性，利用此漏洞是微不足道的，但攻击者需要在内部网络上。
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有已知的缓解措施可以防止攻击者利用此问题。

如果我们把所有的答案合并在一起，稍微整理一下，我们会得到一个不错的第一段：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重的 MS17-010 安全漏洞的影响。利用此发现将导致对服务器的完全控制。由于服务器向环境中的所有主机提供身份验证，因此攻击者可能会破坏整个网络和所有客户数据。内部网络上的攻击者利用此漏洞是微不足道的，因为工具是公开可用的。

本段：

- 清楚地显示了问题所在
- 解释为什么它不好
- 解释了此特定漏洞对 OmniCorp 及其数据的应用方式的影响
- 记下攻击者利用此问题所必须处于的位置，以及该问题的可利用性

鉴于该段落概括了所有这些要点，因此它为那些没有技术背景的人提供了清晰度，并提供了足够的细节，可以作为工程师或开发人员的介绍性概述。这一段给出了对问题的全面理解——单独阅读这种风格的段落就足以理解整个问题。

接下来，让我们介绍一下当我们有“影响”和“描述”部分时如何解决所有这些问题。

### “影响”和“描述”部分

如前所述，某些格式的报告有自己的影响部分，而不仅仅是使用描述（尽管有些报告甚至不考虑影响）。值得庆幸的是，大部分艰苦的工作已经在上一节中完成，这主要是回顾一下。

在回答问题方面，同样的方法也可以在这里应用。与其他报告中可能看到的不同之处在于，“影响”部分看起来相当大。这是因为我建议在本节中包括更广泛的影响之外，将更多关于调查结果的信息放在上面。这是为了使本节变得“可移植”，并以与“描述”部分的上一段相同的方式单独理解。

在许多报告中，我看到了一个很小的“影响”部分——通常是一个断章取义的句子。这总是放在发现的开头，这本身意义不大，因为尚未提供发现的背景。从可读性的角度来看，这随后使问题的流程变得更糟。

让我们以这种格式考虑前面的示例：

> **严重 - 由于多个缺失修补程序（包括严重 MS17-010）导致的 Windows Server 漏洞**
>
> **影响**
>
> 利用受影响主机上的 MS17-010 漏洞的攻击者将能够破坏底层主机，从而获得系统级权限和对系统的完全控制。

这个初始部分有几个缺点：

- 它没有涵盖缺失补丁的更广泛点
- 没有提到现在攻击者处于这个位置可能发生的更广泛的影响

我们克服这些缺点的方法是将影响作为调查结果的引言，这意味着它应该包括更多关于调查结果的信息，然后讨论如果这个问题被利用的更广泛的后果。

让我们看一下构建“影响”部分和“描述”的新开头段落的方法。请注意，在这种格式中，“影响”应该是一个段落（因为调查结果的任何其他细节都将在“描述”部分中。

以下是每个部分的问题：

**影响**

- 结果是什么？
- 如果利用这一发现，对业务、用户和/或数据有什么影响？根据系统的了解，可能发生的最糟糕的事情是什么？
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？

**描述**

- 结果是什么？
- 为什么不好？

以下是这些部分中先前回答的问题：

**影响**

- 结果是什么？
  - OmniCorp 网络上的 Windows 域控制器容易受到严重且可利用的 MS17-010 安全漏洞的攻击。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？接下来可能发生的最糟糕的事情是什么？
  - 鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用 Windows LDAP，破坏域控制器的攻击者将能够利用此方法访问环境中的所有主机。这将包括保存客户数据的后端数据存储。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 由于公开可用的工具的可用性，利用此漏洞是微不足道的，但攻击者需要在内部网络上。
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有已知的缓解措施。

**描述**

- 结果是什么？
  - OmniCorp 网络上的 Windows 域控制器容易受到严重且可利用的 MS17-010 安全漏洞的攻击。
- 为什么不好？
  - 如果攻击者利用此发现，他们将控制域控制器。

以下是这两个部分分开编写后的样子：

> **影响**
>
> 如果攻击者利用主机缺乏修补并利用 MS17-010 漏洞，他们将能够破坏服务器和整个域。鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用此域控制器，攻击者将能够访问环境中的所有主机。这可能包括保存敏感客户数据的后端数据存储。虽然攻击者需要在内部网络上才能利用此漏洞，但由于公开可用的工具，利用此漏洞是多么微不足道，不应低估。
>
> **描述**
>
> 环境中的 Windows 域控制器有许多缺失的修补程序，其中许多与严重漏洞有关。其中最糟糕的是 EternalBlue 漏洞：MS17-010。利用此漏洞的攻击者将能够以 SYSTEM 级权限获得对服务器的完全访问权限。
>
> ...

有几个关键的区别需要解决。

虽然我在“影响”中提到了“为什么不好”，但它并没有被直接指出。这略微缩短了原来的“描述”部分。除了这个小的区别之外，它基本上是相同的，只是我们直接讨论如果攻击者利用该漏洞会发生什么。

“描述”部分现在的规模显然要小得多，因为之前涵盖的大部分内容都在“影响部分”中。在这里，我们说明问题是什么以及为什么它不好，并提供更多技术信息（谈论系统级权限）。

正如你所看到的，这里有一点重复。如果你愿意，你可以努力避免这种重复，但是如前所述，如果你这样做，从上到下阅读时，结果可能不会那么流畅。

是否要将问题分解为单独的部分取决于您。在本课程的其余部分，我将只关注“描述”部分，因为这是我的偏好。

## 发现说明的其余部分

一旦写完了最初的段落，就需要完成其余的调查结果。通过一个小清单，可以以类似的方式处理本节。由于某些类型的发现需要不同数量的解释或证据，或者需要以不同的方式呈现内容，因此这里的差异越来越大。

以下是发现描述的良好结构（使用描述方法中的单个段落）：

- 查找说明（前面介绍过）
- 如果
  - 仅从开头的段落来看，问题并不明显
  - 查找需要详细演练查找的工作原理
  - 发现是多个问题的组合，需要全部指出
- 引入证据
- 插入证据
- 解释证据

您需要使用自己的判断来决定是否需要进一步的解释。然而，思考这个问题的一个好方法是把自己放在客户的位置上——他们是否足够了解问题，仅凭最初的描述和证据来重现和修复？如果没有，您应该考虑提供更多详细信息。

在某些情况下，从证据开始，然后进行进一步的解释是有意义的。我们将在本课后面的示例中看到这种情况。

为发现捕获证据的方式也很重要——我们将在几节课中介绍这一点。这里要强调的主要内容是记住引入证据，以便客户知道我们在说什么，然后在需要时充分解释。我们不能假设一个孤立的代码片段或屏幕截图会在没有对某些客户端的解释的情况下被理解。

对于我们一直在研究的示例，上述方法如下所示（跳过开头的段落）：

> MS17-010 漏洞会影响 Windows Server 消息块协议（1.0 版），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。
>
> 鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。但是，由于这会影响 Windows 域控制器，因此可以访问所有用户的所有凭据材料（以哈希或加密格式）。
>
> 由于这是整个环境的域控制器，并且是环境中通过 LDAP 提供身份验证的主要服务，因此入侵将影响生产域中所有连接的服务器和服务。

“描述”部分的后续段落将详细介绍漏洞的背景，并提供更多技术背景，说明为什么破坏此主机会导致整个环境的破坏。此外，Nessus 的扫描结果与 Metasploit 的证据一起提供，以显示测试结果，以查看服务是否可能易受攻击。

这样就完成了问题的描述部分，显示了足够的证据来支持提出这个问题，并为客户提供了足够的信息来调查调查结果。

## 更多示例

为了结束本课，我将介绍 OmniCorp 的其余示例结果并构建描述。我还将回答前面提到的问题，以展示将重要的第一段再做几次的方法。

我将包括对这些问题的一些反思，其中包括对描述部分中提供的更多信息的一些评论（如果需要）。

### Linux 服务器上的弱密码策略

**观察**

使用 SSH 登录 OmniCorp 网络中的 Linux 服务器的尝试成功，使用非常基本的密码“password”。这表示服务器上的密码策略较弱，可能会影响多个帐户。根据一些额外的分析和与客户端的通信，主机似乎没有处于活动状态，也不包含任何敏感数据。未找到具有此用户名和密码组合的其他主机。服务器本身运行的是 Ubuntu 22.04。

**证据**

```
$ ssh john@example-server.com
john@example-server.com's password: password
Welcome to example-server.com!
Last login: Sun Jan 29 09:00:01 2024 from 192.168.1.2
```

**第一段问题**

- 结果是什么？
  - 环境中的 Linux 服务器配置了可猜测用户名的弱密码。
- 为什么不好？
  - 攻击者可能会在针对服务器的密码猜测攻击中猜测用户名和密码组合。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？根据系统的了解，可能发生的最糟糕的事情是什么？
  - 对环境的影响有限，因为与客户的讨论表明主机未使用。环境中没有其他主机受到相同的弱用户名和密码组合的影响。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 内部网络上的攻击者将能够快速猜出此用户名和密码组合
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有已知的缓解措施。

> **描述**
>
> 环境中 Linux 服务器上的帐户配置了通用用户名和密码组合。内部网络上的攻击者可能会使用基本的用户名和密码猜测攻击来获得访问权限。虽然受影响的用户是管理员，这将导致主机完全受损，但主机未被使用，并且不包含对攻击者有用的数据或凭据材料。环境中没有其他主机受此问题的影响。
>
> 成功登录受影响的 Linux 服务器如下所示：
>
> ```
> $ ssh admin@192.168.1.122.com
> admin@192.168.1.122.com's password: password
> Welcome to 192.168.1.122.com!
> Last login: Sun Jan 29 09:00:01 2024 from 192.168.1.122
> admin@192.168.1.122:~$
> ```

这是能够在内部网络上成功猜测用户密码的一个非常基本的问题。用户名是通用的，这显然很糟糕，但是与此密码的组合使其特别成问题。幸运的是，在此示例中，影响很小，因为主机未以任何方式连接到更广泛的解决方案，并且未被主动使用。

我觉得我不需要为这个问题提供任何额外的评论。因此，我跳过了进一步的细节，直接进入了这个问题的证据。

### 可公开访问的 S3 存储桶

**观测**

在 AWS 配置审查期间为 OmniCorp 发现了一个 S3 存储桶。无需互联网上任何人的身份验证即可访问存储桶。它包含一份关于最近发生的违规行为的机密报告以及所有员工的工资信息。违规报告显示未修补的外部漏洞，这些漏洞将允许攻击者进入网络。

**证据**

```
$ aws s3 ls s3://omnicorp-private-files
2024-01-28 12:35:29      1024 confidential_report.pdf
2024-01-29 08:15:47      2048 employee_data.xlsx
```

**第一段问题**

- 结果是什么？
  - 发现了一个可公开访问的 S3 存储桶。
- 为什么不好？
  - Internet 上的任何用户都可以访问存储在存储桶中的文件。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？接下来可能发生的最糟糕的事情是什么？
  - 该存储桶包含有关最近渗透测试报告的信息，该报告详细介绍了未修补的外部漏洞。
  - 存储桶还包含一个文件，其中列出了员工及其工资单数据。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 如果攻击者能够猜到存储桶的名称，则很容易利用此问题
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有已知的缓解措施。

> **描述**
>
> 发现了一个可公开访问的 S3 存储桶。Internet 上任何能够猜出存储桶名称的用户都可以访问和下载 S3 存储桶中的所有文件。该存储桶包含所有员工的工资单信息，以及最近的渗透测试报告的结果，其中包含几个未修补的外部漏洞。利用这些信息，攻击者可以尝试通过利用上述外部漏洞或根据工资单信息的内容对用户进行网络钓鱼和密码猜测攻击来访问互联网。如果攻击者得逞，无论是获得对生产网络的访问权限还是破坏用户的访问权限，内部网络上的敏感客户信息都可能面临泄露的风险。
>
> aws 命令行工具的以下命令输出显示了存储在存储桶中的文件。
>
> ```
> $ aws s3 ls s3://omnicorp-private-files
> 2024-01-28 12:35:29      1024 confidential_report.pdf
> 2024-01-29 08:15:47      2048 employee_data.xlsx
> ```
>
> 这两个文件都可以下载和检查：
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231945248.png)
>
> confidential_report.pdf内容
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231945989.png)
>
> employee_data.xlsx内容
>
> 机密报告包含以下可外部利用的漏洞列表，所有这些漏洞都在此评估期间存在：
>
> - 使用可猜测凭据向 Internet 公开的 RDP
> - 使用匿名绑定向 Internet 公开的 LDAP
> - 暴露的 Apache Tomcat 过时且易受攻击
>
> 获取此文档访问权限的攻击者将能够立即确认这些问题的可利用性，因为它们都是面向 Internet 的，并且可能能够透视到内部网络。
>
> 工资单电子表格不仅显示了所有员工的当前工资和奖金，而且还泄露了大量可用于欺诈目的的信息，以及对 OmniCorp 进行其他攻击（例如密码猜测攻击或网络钓鱼）。电子表格中包含以下敏感信息：
>
> - 名字和姓氏
> - 工资
> - 家庭住址
> - 个人电子邮件地址
> - 个人电话号码

描述中的影响非常强烈，因此我觉得这不需要在其余的发现中详细说明。但是，我确实觉得有必要扩展文件的某些内容，并将其与所涵盖的影响联系起来。

我也在这里更改了顺序。我觉得先展示证据并解释其中的内容更合适，而不是相反。这表明在结构方面灵活处理剩余的发现细节是多么好。虽然有一个精心设计的开场白是必不可少的，但其余部分应该以任何最好的方式来讲述发现的故事。

### API 端点返回用户数据，无需身份验证

**观测**

尝试访问 API 端点 http://api.example.com/v1/userdata 成功，而无需任何形式的身份验证。这是在看到对 http://api.example.com/v1/userdata/2 的调用后尝试的，该调用返回了当前用户自己的数据以显示在配置文件部分中。这种未经身份验证的访问导致检索所有用户数据，表明对 API 的安全控制不足。其他 API 端点未受到影响。此终结点已向 Internet 公开。

**证据**

```
$ curl -i http://api.example.com/v1/userdata
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 150
{"users": [{"id": "1", "name": "John Doe"}, {"id": "2", "name": "Jane Smith"}]}
```

**第一段问题**

- 结果是什么？
  - 无需任何用户身份验证即可访问 API 端点，该端点返回有关平台上所有用户的信息。
- 为什么不好？
  - 知道 API 端点的攻击者可以访问所有用户数据。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？接下来可能发生的最糟糕的事情是什么？
  - 攻击者可以使用此数据执行其他攻击，例如网络钓鱼或密码猜测。
  - 知道什么 ID 对应于哪些用户可用于针对系统的其他攻击。
  - 获取用户帐户的访问权限将使攻击者能够访问其数据。
  - 这些信息的泄露可能是违反GDPR。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 以应用程序为目标的攻击者很容易利用该漏洞。通过查看从移动客户端到 API 服务器的流量，可以发现端点，并且可以从 Internet 上利用。
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有已知的缓解措施。

> **描述**
>
> 发现了一个 API 端点，该端点返回了平台上所有用户的数据，并且无需身份验证即可访问。如果攻击者发现端点，则返回的数据将能够用于目标平台用户。这可能以密码猜测攻击、网络钓鱼或在其他 API 调用中利用其用户 ID 的形式出现。这些攻击不仅可能导致访问用户的敏感信息，而且这些信息的泄露可能会构成具有GDPR影响的隐私泄露。任何以经过身份验证的用户身份检查流量的攻击者都可能发现此漏洞，这意味着它更有可能被系统用户发现，而不是被外部攻击者随机发现。
>
> 在评估期间，观察到以下 API 调用，该调用检索到的信息随后将放置在用户的个人资料页面上：
>
> **请求**
>
> ```
> GET /api/user/profile/1 HTTP/1.1
> Host: example.com
> Authorization: Bearer REDACTED
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: application/json
> Content-Length: 150
> {"id": "1", "name": "John REDACTED", "email": "REDACTED"}
> ```
>
> 根据 REST 命名方案的构造方式，不带标识符后缀的 URL 通常会返回与对象类型（在本例中为配置文件）关联的所有对象。如下图所示，这返回了所有用户的数据：
>
> **请求**
>
> ```
> GET /api/users/profile HTTP/1.1
> Host: example.com
> Authorization: Bearer REDACTED
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: application/json
> Content-Length: 150
> {"users": [{"id": "1", "name": "John REDACTED", "email": "REDACTED"}, {"id": "2", "name": "Jane REDACTED", "email": "REDACTED}]}
> ```
>
> 虽然这本身就是一个重大问题，但执行了另一项检查，以查看终结点是否无需身份验证即可使用。这是通过删除请求中发送的 API 令牌来实现的，并且仍然返回来自服务器的响应，表明不需要身份验证：
>
> **请求**
>
> ```
> GET /api/users/profile HTTP/1.1
> Host: example.com
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: application/json
> Content-Length: 150
> {"users": [{"id": "1", "name": "John REDACTED", "email": "REDACTED"}, {"id": "2", "name": "Jane REDACTED", "email": "REDACTED"}]}
> ```

在这里，我强调了这个问题如何导致多种攻击途径，从而导致用户数据泄露。除此之外，我还提出了对隐私风险的担忧，因为它返回了用户的 PII（名字、姓氏和电子邮件）。

这个问题本身并不太复杂，无法解释，但我确实觉得讲述它是如何被发现的故事很重要，这样客户就可以理解攻击者的思维过程，并在需要时复制它。

我还指出，以一种迂回的方式，它未经身份验证的事实并不是这里的主要关注点，更多的是关于端点返回的数据。

### 在论坛软件上存储跨站点脚本

**观察**

在 OmniCorp 用于客户支持的论坛软件中，可以在评论字段中注入任意 JavaScript，每当用户访问受影响的页面时都会执行该字段。这表明该网站容易受到存储的跨站点脚本的影响。会话令牌可通过 JavaScript 有效负载获得。客户告知，该论坛确实安装了 Web 应用程序防火墙，但当前未运行。

**证据**

```
POST /forum/post/comment HTTP/1.1
Host: forum.example.com
...
comment=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E
```



```
HTTP/1.1 200 OK
...
<div class="comment">User posted: <script>alert('XSS')</script></div>
```

**第一段问题**

- 结果是什么？
  - OmniCorp 使用的论坛容易受到存储的跨站点脚本的影响。
- 为什么不好？
  - 任意 JavaScript 可以在任何用户的浏览器中运行。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？接下来可能发生的最糟糕的事情是什么？
  - 攻击者可以注入类似于论坛登录页面或 OmniCorp 应用程序登录页面的 JavaScript，以窃取客户凭据。
  - 攻击者可能试图通过窃取用户的身份验证令牌来劫持用户的会话。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 似乎没有防御性编码，这意味着新手攻击者很容易利用它。由于论坛允许自行注册，因此任何基于 Internet 的攻击者都可能尝试利用此问题。
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有采取任何缓解措施，但是，客户端建议正在使用 Web 应用程序防火墙，但当前已禁用。

> **描述**
>
> OmniCorp 用于协助客户支持请求的论坛软件容易受到存储的跨站点脚本的影响。此漏洞影响了论坛帖子页面上的评论部分，任何恶意注入的代码都会对访问受影响页面的任何用户运行。攻击者可以利用此漏洞破坏用户论坛会话（包括论坛版主或管理员），甚至提供虚假的登录表单，试图窃取用户的生产凭据。如果获取了用户凭据，则可能导致攻击者获得对敏感用户数据的访问权限。此漏洞的攻击复杂度非常低，因为没有防御性编码，使攻击者更容易利用;唯一的要求是用户访问受影响的论坛帖子。虽然只有该平台的用户可以利用这个问题，但鉴于互联网上的任何人都可以自行注册和使用该平台，这是没有意义的。虽然在托管论坛的 Web 服务器上安装了 Web 应用程序防火墙，但它当前并未运行。但是，即使启用了此问题，它也可能无法阻止所有利用此问题的尝试。
>
> 存储的跨站点脚本是一种漏洞，Web 应用程序未对不受信任的输入执行足够的输入验证或清理，或者未对值执行足够的输出编码。其结果是，应用程序（在数据库、日志或其他系统中）提交并随后存储的恶意信息随后被反映并合并到生成的网页中。在跨站点脚本的情况下，JavaScript 被发送到服务器、存储并返回到用户的浏览器，并执行以执行各种恶意操作。
>
> 利用跨站点脚本漏洞存在一系列可能性，其中一些包括：
>
> - 在浏览器会话中运行加密矿工
> - 尝试窃取经过身份验证的页面上特定于用户的会话令牌或内容
> - 注入虚假表格供用户填写，以试图窃取信息（例如，用于收集凭据的登录表格）
> - 在用户不知情的情况下在用户上下文中执行操作（例如，将恶意内容发布到论坛）
> - 显示恶意内容
>
> 鉴于利用此漏洞的方式多种多样，此问题会严重影响任何处理敏感数据的应用程序，因为它更有可能被盗、修改或删除。
>
> 以下 HTTP 请求和响应显示了 OmniCorp 论坛应用程序软件接受的基本 JavaScript 的注入。
>
> **请求**
>
> ```
> POST /forum/post/1/comment HTTP/1.1
> Host: forum.example.com
> Content-Type: application/x-www-form-urlencoded
> Content-Length: 68
> Cookie: sessionid=REDACTED
> 
> 
> postId=42&comment=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: text/html; charset=UTF-8
> Content-Length: 256
> ```
>
> 以下 HTTP 请求和响应显示服务器作为可在用户浏览器会话中运行的可执行 JavaScript 返回的有效负载。
>
> **请求**
>
> ```
> GET /forum/post/1/comments HTTP/1.1
> Host: forum.example.com
> Content-Type: application/x-www-form-urlencoded
> Content-Length: 68
> Cookie: sessionid=REDACTED
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: text/html; charset=UTF-8
> Content-Length: 256
> 
> 
> <html>
> <body>
>   <div id="content">
>     <div class="comment">User posted: <script>alert('XSS')</script></div>
>   </div>
> </body>
> </html>
> ```
>
> 下图显示了正在执行的有效负载：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231945055.png)
>
> 正在执行的 Omnicorp 存储的跨站点脚本
>
> 创建概念验证 JavaScript 有效负载以生成以下 OmniCorp 登录表单。这将显示在请求的论坛帖子的顶部，以提示输入用户的凭据。提交后，用户的凭据将被发送到攻击者控制的服务器，然后帖子将变得可见。
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231945398.png)
>
> 假 OmniCorp 登录屏幕
>
> 
>
> 可以在附录第 5.2 节中找到虚假登录概念证明 HTML 和 JavaScript 有效负载的完整副本，以及使用的 HTTP 请求和响应。

这个问题有点技术性，需要一些进一步的解释，因为需要修复它的人可能不清楚此问题发生的原因。因此，对于这个问题，我试图使开头的段落尽可能易于理解，以了解发生的事情和随后可能发生的事情。

在围绕存储的跨站点脚本如何工作的理论进行了更多解释，并展示了一些如何利用它的示例之后，我展示了如何将有效负载发送到服务器的 HTTP 请求和响应证据。然后，显示它如何被利用的证据以及生成的屏幕截图。

最后，我展示了一个对客户来说比简单的警报框更有意义的内容的屏幕截图。这应该有助于使总体问题及其如果被利用的潜在影响变得严肃起来。考虑到在显示如何完成此操作时将涉及多少 HTML 和其他 HTTP 请求和响应，我决定将其放在报告的附录部分。

## 课程总结

我们已经完成了构建发现的开始的过程，要么是“描述”部分的第一段，要么是“影响”和“描述”的第一段。采用本课中概述的方法应该可以帮助您为发现生成一个信息量大且清晰（且便携）的开场白。

使用这些可重复的过程，您应该能够轻松地制作问题草案，首先是回答问题和合并答案，然后确保您的问题包含证据和进一步的细节。

# 13-描述 - 练习

在上一课中，我们介绍了创建发现描述或具有单独影响和描述部分的发现的理想方法。

让我们将您学到的知识付诸实践：

**反思练习**

- 反思您最近撰写或有权访问的报告。查看问题描述的开头段落。他们是否清楚地定义了问题、其影响以及为什么它是坏的？如何改进这些段落，使不同的读者能够理解？
- 想想你最近从事或阅读过的安全发现。反思调查结果的影响和描述的传达情况。非技术读者能否理解其严重性和影响？您如何重新表述描述以迎合技术和非技术受众？

**一般练习**

- 浏览 OmniCorp 章节的示例发现，并编写每个问题的发现说明。
  - 使用单个“描述”部分或“影响”和“描述”
  - 按照概述的过程并记录问题的答案，然后再将它们合并为初始段落
  - 请记住将适当的写作风格应用于文本
  - 确保您尽可能简洁明了

**超越练习**

重写您的结果描述，以使用您以前未使用过的任何演示文稿（如果您只做了“描述”部分，则为“影响”和“描述”，如果您只做了“描述”部分，则为“描述”）

# 14-描述 - 其他上下文

我已经谈过几次确保可以孤立地阅读调查结果的重要性，这里的课程与这个主题有关。我们讨论的不是严格的必要性，而是更像是一种边缘情况。

假设您正在执行一项大规模评估，其中包含类似工作的多个阶段（例如多个 Web 应用程序、服务器构建和 Active Directory 环境）。评估结果将被捕获在问题跟踪系统中，并由您的客户和潜在的第三方进行审查。在这些情况下，如果发现是以通用方式编写的，则团队很难将发现与特定区域联系起来。在这种情况下，在调查结果描述的主要部分之前提供一些初步信息可以提供有用的上下文。如果您已经从以前的课程中采纳了建议，则这种情况不太可能发生，但是在必须清楚地了解问题的影响或所属位置的情况下，确保这反映在您的文档中是值得的。

一个简单的解决方案是用一个简短的句子开始发现，以陈述所评估的主题并提及其功能。当不熟悉所评估内容的人可能会阅读该发现时，这非常有用，或者如果您稍后回来并忘记了您过去审查的内容，甚至您自己也会阅读。

结合这个简单的句子可以大大减少对后续解释（通过电话或电子邮件）的需要，以澄清调查结果，并且我个人为我节省了无数时间，用于我承担的一些大型项目的电话。此外，如果这些发现将上传到问题跟踪器并单独审查，则此介绍性上下文可能非常有用，因为报告的更广泛上下文可能无法立即获得，或者可能不清楚调查结果的影响位置或影响。

这种方法将导致您的调查结果高度重复，在同一评估区域的调查结果中出现相似或相同的句子。我只建议使用这种方法，因为它可能使客户受益，节省您将来的时间，或者如果发现将在问题跟踪器上以孤立的方式进行审查。

## 例子

让我们使用前面编写的描述来浏览一些示例。

### Windows Server 漏洞，由于多个缺失修补程序（包括关键 MS17-010）而导致

下面是先前发现描述的示例，其中添加了此句子。

> **OmniCorp 的生产环境利用 Windows 域为环境中的所有 Windows 和 Linux 主机提供身份验证机制。** 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重的 MS17-010 安全漏洞的影响。利用此发现将导致对服务器的完全控制。由于服务器向环境中的所有主机提供身份验证，因此攻击者可能会破坏整个网络和所有客户数据。内部网络上的攻击者利用此漏洞是微不足道的，因为工具是公开可用的。

在这里，我添加了一句话，以告知读者我们审查的“事物”是什么以及它的作用，然后再详细介绍什么是易受攻击的。

让我们看看其他问题的其他例子。

### 可公开访问的 S3 存储桶

在此示例中，在进入调查结果之前，我们概述了 AWS 的主要用途。

> **OmniCorp 使用 Amazon 的 AWS 来托管其公共 Web 应用程序，但也为普通员工和开发团队提供了一些临时用途。** 发现了一个可公开访问的 S3 存储桶。Internet 上任何能够猜出存储桶名称的用户都可以访问和下载 S3 存储桶中的所有文件。该存储桶包含所有员工的工资单信息，以及最近的渗透测试报告的结果，其中包含几个未修补的外部漏洞。利用这些信息，攻击者可以尝试通过利用上述外部漏洞或根据工资单信息的内容对用户进行网络钓鱼和密码猜测攻击来访问互联网。如果攻击者得逞，无论是获得对生产网络的访问权限还是破坏用户的访问权限，内部网络上的敏感客户信息都可能面临泄露的风险。

### Linux 服务器上的弱密码策略

Linux 服务器在环境中的主要用途是运行其 Ceph 存储集群，所以我提到了这一点。但是，当您通读发现时，这样的添加在这里感觉有点没有意义。通常与一般基础设施（或涵盖各种服务或产品的一般领域）相关的调查结果不会从本序言中获益太多，因此在这种情况下，最好将其排除在外。

> **OmniCorp 在整个环境中利用 Linux 服务器作为其主要用例来运行其生产应用程序的存储层。** 环境中 Linux 服务器上的帐户配置了用户名和密码组合。内部网络上的攻击者可能会使用基本的用户名和密码猜测攻击来获得访问权限。虽然受影响的用户是管理员，这将导致主机完全受损，但主机未被使用，并且不包含对攻击者有用的数据或凭据材料。环境中没有其他主机受此问题的影响。

### API 终端节点返回所有用户数据

在此示例中，我提到了 API 在评估范围内。这为API的主要用例提供了一些额外的见解。在这些情况下，提及产品名称（如果有）可能会有所帮助，或者如果发现仅影响几个问题中的一个

> **OmniCorp 使用 API 为用户提供从其移动应用程序读取和写入数据的功能。** 发现了一个 API 端点，该端点返回了平台上所有用户的数据，并且无需身份验证即可访问。如果攻击者发现端点，返回的数据将能够用于目标平台用户。这可能以密码猜测攻击、网络钓鱼或在其他 API 调用中利用其用户 ID 的形式出现。这些攻击不仅可能导致访问用户的敏感信息，而且这些信息的泄露可能会构成具有GDPR影响的隐私泄露。任何以经过身份验证的用户身份检查流量的攻击者都可能发现此漏洞，这意味着它更有可能被系统用户发现，而不是被外部攻击者随机发现。

### 在论坛软件上存储跨站点脚本

本期已经有大量信息涵盖了受影响的内容。这里的主要变化是提到论坛软件是内部构建的。

> OmniCorp 用于协助客户支持请求的**内部构建**论坛软件容易受到存储的跨站点脚本的影响。此漏洞影响了论坛帖子页面上的评论部分，任何恶意注入的代码都会对访问受影响页面的任何用户运行。攻击者可以利用此漏洞破坏用户论坛会话（包括论坛版主或管理员），甚至提供虚假的登录表单，试图窃取用户的生产凭据。如果获取了用户凭据，则可能导致攻击者获得对敏感用户数据的访问权限。此漏洞的攻击复杂度非常低，因为没有防御性编码，使攻击者更容易利用;唯一的要求是用户访问受影响的论坛帖子。虽然只有该平台的用户可以利用这个问题，但鉴于互联网上的任何人都可以自行注册和使用该平台，这是没有意义的。虽然在托管论坛的 Web 服务器上安装了 Web 应用程序防火墙，但它当前并未运行。但是，即使启用了此问题，它也可能无法阻止所有利用此问题的尝试。

## 课程总结

在这个快速课程中，我们介绍了必须在调查结果中提供额外信息的利基用例。我不认为这对许多人非常有用，但对于那些属于执行大型评估的团队的人来说，请考虑一下是否包含这些附加信息可以减少通话时间和其他进一步的澄清。

# 15-描述 - 其他上下文 - 练习

在上一课中，我们介绍了一个用例，在问题描述中加入一些前导文本可以帮助设置问题影响的区域。

让我们通过一些快速练习来尝试这个额外的问题演示。

**反思练习**

- 反思您撰写或有权访问的报告。查看调查结果，看看如果单独阅读，它们是否会被误解或不清楚。介绍性句子如何提高清晰度？
- 您能想到任何时候，在问题上提供更清晰的信息可能会导致与客户的后续互动减少吗？如果是这样，可以做些什么？

**一般练习**

- 对于您之前编写的每个 OmniCorp 章节练习查找说明，请在开头添加一个额外的句子以使其更加清晰。
  - 完成此操作后，请记住查看整个描述，以确保限制重复并最大限度地简洁。

# 16-使描述开场白更简洁

我之前提到过，我建议创建问题的开头段落的方式可能会导致相当大的段落。我再次强调，这真的不是问题。如果客户无论如何都要阅读您的所有发现，那么文本的分布几乎没有区别，如果他们只想了解问题所在，他们应该拥有本段中的所有信息。

此外，值得反思您以前撰写报告的任何经验。如果你觉得你制作的描述开场白的尺寸较大，感觉“错误”或“不熟悉”，你可能只是习惯于期待更小的描述。这是很自然的，也是我必须接受自己的。为了向客户提供他们需要的额外信息，必须在描述中包含更多信息。这与我团队的“正常”不一致。

也就是说，有一些方法可以限制这些段落的大小，同时确保它包含所需的所有信息。而且，如果运气好的话，您也许可以减小这些开瓶器的尺寸，使其更符合您习惯的尺寸。

让我们回过头来重新审视描述课中的示例问题。

## 提高简洁性

在“说明”课程中，我们介绍了 Windows 域控制器上缺少的修补程序。以下是调查结果的观察文本：

> 对 OmniCorp 网络中的 Windows Server 进行的 Nessus 扫描显示，缺少许多关键的缺失安全补丁，包括修复 MS17-010 的补丁。这表明服务器没有及时更新必要的安全更新。主机是生产环境的域控制器。进一步的测试表明，该服务器可以利用此漏洞。

使用我概述的技术，这是我回答的问题。

- 结果是什么？
  - 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。
- 为什么不好？
  - 如果攻击者利用此发现，他们将控制域控制器。
- 如果利用这一发现，对业务、用户和/或数据有什么影响？接下来可能发生的最糟糕的事情是什么？
  - 鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用 Windows LDAP，破坏域控制器的攻击者将能够利用此方法访问环境中的所有主机。这将包括保存客户数据的后端数据存储。
- 攻击者需要处于什么位置才能利用这一发现，他们利用的难易程度如何？
  - 由于有公开可用的工具，利用此漏洞是微不足道的。
  - 攻击者需要在内部网络上才能利用此问题。
- 是否有任何相关的缓解措施可能会使其更难被利用，应该被提及？
  - 没有已知的缓解措施可以防止攻击者利用此问题。

如果你把所有这些放在一起形成你的初稿，这就是你得到的：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。如果攻击者利用此发现，他们将控制域控制器。鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用 Windows LDAP，破坏域控制器的攻击者将能够利用此方法访问环境中的所有主机。这将包括保存客户数据的后端数据存储。由于有公开可用的工具，利用此漏洞是微不足道的。攻击者需要在内部网络上才能利用此问题。没有已知的缓解措施可以防止攻击者利用此问题。

以下是可以采取的几个步骤来减少字数：

- 删除多余的句子
- 删除技术细节
- 联接句子
- 更简洁

可能还有一些策略可以减少描述中的单词，但这些是我在合并示例句子和重新处理文本时所经历的主要步骤。重要的是，我们不会删除太多文本，以免客户端无法理解最终版本。

让我们一步一步地完成这个并调整文本。

### 删除冗余文本

由于没有缓解措施可谈，我们可以简单地删除以下句子：

> 没有已知的缓解措施可以防止攻击者利用此问题。

这将导致以下结果：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。如果攻击者利用此发现，他们将控制域控制器。鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用 Windows LDAP，破坏域控制器的攻击者将能够利用此方法访问环境中的所有主机。这将包括保存客户数据的后端数据存储。由于有公开可用的工具，利用此漏洞是微不足道的。攻击者需要在内部网络上才能利用此问题。

### 删除技术细节

接下来，让我们回顾一下文本，看看可以从本节中删除哪些过于技术性的信息。理想情况下，开场白需要在负责修复结果的高管和技术人员的可读性之间取得平衡。

一个可以改进为技术含量稍低的主要领域可能是：

> 鉴于环境中所有 Windows 和 Linux 服务器的主要身份验证方法都使用 Windows LDAP，破坏域控制器的攻击者将能够利用此方法访问环境中的所有主机。

我们可能根本不需要在这里提及 LDAP，这会稍微减少字数：

> 鉴于服务器向环境中的所有 Windows 和 Linux 服务器提供了身份验证，破坏域控制器的攻击者将能够利用这一点来访问环境中的所有主机。

这将导致以下结果：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。如果攻击者利用此发现，他们将控制域控制器。鉴于服务器向环境中的所有 Windows 和 Linux 服务器提供了身份验证，破坏域控制器的攻击者将能够利用这一点来访问环境中的所有主机。这将包括保存客户数据的后端数据存储。由于有公开可用的工具，利用此漏洞是微不足道的。攻击者需要在内部网络上才能利用此问题。

### 联接句子

这是一个可以显着减少字数的领域。

这里有两句话可以组合在一起：

> 由于有公开可用的工具，利用此漏洞是微不足道的。攻击者需要在内部网络上才能利用此问题。

本期的第二句话有点多余。我们本可以更早地删除它，但指出攻击者利用该问题（在内部网络上）所需的位置至关重要。让我们将两个句子中的信息合并为一个：

> 由于公开可用的工具的可用性，内部网络上的攻击者利用此漏洞是微不足道的。

其结果是：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。如果攻击者利用此发现，他们将控制域控制器。鉴于服务器向环境中的所有 Windows 和 Linux 服务器提供了身份验证，破坏域控制器的攻击者将能够利用这一点来访问环境中的所有主机。这将包括保存客户数据的后端数据存储。由于公开可用的工具的可用性，内部网络上的攻击者利用此漏洞是微不足道的。

### 更简洁

到目前为止，我们已经删除了大约 10% 的单词。让我们看看我们是否可以更简洁地进一步减少字数。这次让我们一句一句地去。

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重且高度可利用的 MS17-010 安全发现的影响。

更简洁的版本：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重的 MS17-010 安全漏洞的影响。

我在这里删除了“和高度可利用性”，因为我们在后面的发现中讨论可利用性。

> 如果攻击者利用此发现，他们将控制域控制器。

更简洁的版本：

> 利用此发现将导致对服务器的完全控制。

在这里，我把这句话改写得更直接一些，减少了字数。

> 鉴于服务器向环境中的所有 Windows 和 Linux 服务器提供了身份验证，破坏域控制器的攻击者将能够利用这一点来访问环境中的所有主机。

更简洁的版本：

> 由于服务器向环境中的所有主机提供身份验证，因此攻击者将能够访问环境中的所有主机。

我在这里合并了“Windows”和“Linux”，因为这些细节在这里无关紧要。我还删除了上一句中关于“攻击者破坏域控制器”的一堆信息。

> 这将包括保存客户数据的后端数据存储。

更简洁的版本：

> ，包括那些拥有客户数据的人。

在这种情况下，我发现将这句话与前一句话的新版本合并很有用。

> 由于公开可用的工具的可用性，内部网络上的攻击者利用此漏洞是微不足道的。

更简洁的版本：

> 内部网络上的攻击者利用此漏洞是微不足道的，因为工具是公开可用的。

我稍微改写了这句话，并删除了多余的“可用性”一词。

### 最终版本

经过上述所有更改后，这里是该段落的最终版本，它比原始版本更短，更简洁：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重的 MS17-010 安全漏洞的影响。利用此发现将导致对服务器的完全控制。由于服务器向环境中的所有主机提供身份验证，因此攻击者将能够访问环境中的所有主机，包括具有客户数据的主机。内部网络上的攻击者利用此漏洞是微不足道的，因为工具是公开可用的。

现在值得进行最后的通读并进行一些调整，以便文本听起来不会重复并且流畅。

这是最终版本：

> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重的 MS17-010 安全漏洞的影响。利用此发现将导致对服务器的完全控制。由于服务器向环境中的所有主机提供身份验证，因此攻击者可能会破坏整个网络和所有客户数据。内部网络上的攻击者利用此漏洞是微不足道的，因为工具是公开可用的。

我巩固了发现不那么啰嗦的影响部分，并略微增加了庄严感。

## 课程总结

因此，通过这个过程，字数从 129 个单词减少到 73 个单词 - 在涵盖我们需要的所有信息的同时显着减少。这表明可以在不产生大量文本的情况下编写内容丰富的开场白描述。

就我个人而言，我认为少于 120 个字的内容对于这些开场白来说都是可以的，但我确实认为，将所有信息都包含在本段中比试图限制本节中的字数更重要。

# 17-使描述开场白更简洁 - 练习

在上一课中，我们研究了如何减少描述中产生的文本量，主要集中在开头的段落上。

让我们通过一些练习，看看是否可以对以前的报告和本章中正在处理的问题进行改进。

**反思练习**

反思您最近撰写或有权访问的报告。你能发现使用上一课中概述的策略可以使任何方面更简洁吗？你能改进它们吗？

**一般练习**

再次查看您为 OmniCorp 章节示例问题制作的发现描述段落（以及影响部分，如果您编写了这些段落）。你能在保留所有必需信息的同时使它们更简洁吗？将此过程应用于结果说明的其余部分。

# 18-证据

确保结果不仅包含证据，而且包含良好的证据，这对客户和测试人员都至关重要。正如前面在描述课程中提到的，应该向客户展示存在问题的证据，并包括良好的证据，使我们的同行能够更轻松地执行补救验证工作。后一点非常重要，每次撰写发现时都应该考虑这一点 - 如果您必须尝试重现此发现，本文档是否包含有效执行此操作所需的所有内容？如果不是，证据可能不充分。

让我们来看看报告中可能出现的一些典型证据示例，并展示一些好的和坏的例子。

## 截图

在你截取任何东西之前，你应该问问自己“作为片段，而不是截图会更好吗？这在本课中会出现几次来强调这一点，但通常以文本而不是屏幕截图的形式呈现证据会更清晰。这是因为文本大小可以与文档的其余文本匹配，并且对于客户端能够从文档中复制和粘贴内容也很有用。

作为指导，如果您正在查看已经采用文本格式的内容，则可能应将其作为文本捕获在报告中。这适用于：

- 法典
- 文本格式的配置文件
- HTTP 请求和响应

任何不在此列表中的内容都应该是屏幕截图。

解释了这一点，让我们看一个坏的和好的示例屏幕截图。

**坏例子**

下面是 Jenkins 主机配置问题的示例问题：

以下屏幕截图显示了此问题：

> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231946635.png)

这有一些问题。首先，图像的分辨率太低，可能难以阅读。截取某些内容的屏幕截图时，请确保它一旦放入报告文档中即可阅读。

其次，没有明确的迹象表明这是从正在审查的系统中获取的。由于这是一个 Jenkins 主机，我们应该提供一个带有 URL 的屏幕截图。

最后，我们想在这里展示什么？您可能会在查找文本中的图像之后详细了解您所指的内容，但图像本身涵盖了许多设置，但没有明确指示正在谈论的是哪一个。

**好例子**

让我们看一下上述问题的一个很好的版本。

> Jenkins 系统配置页面的以下屏幕截图显示已启用调试模式：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231946033.png)

在此修订后的屏幕截图中，包含主机 URL，并且图像的冗余部分已被裁剪掉。此外，我在屏幕截图中突出显示了受影响的设置，因此很清楚。

另外，请注意我是如何介绍证据的，这样它就可以为读者指明正确的方向，让他们知道他们在看什么。

## 源代码片段

如果要执行代码审查或评估，需要突出显示配置文件中的某些信息，则将信息清晰地显示为证据至关重要。呈现此信息的方式既有好有坏;让我们看一些例子。

**坏例子**

> 以下代码片段显示了易受攻击的函数：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231946153.png)

在这个糟糕的例子中，我们没有被告知这个函数存在在哪里，客户端可能需要自己手动搜索它。除此之外，证据没有明确指出漏洞在哪里。如果您稍后跟进解释哪个部分容易受到攻击，那可能是可以的。

令人讨厌的是，他们无法复制任何文本，因为证据是以图像形式提供的。在此示例中，这可能不会为他们节省太多时间，但请考虑发现可能与他们需要搜索的过于复杂和冗长的类名相关的位置。像这样的东西：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231946032.png)

有人手动键入此响应类型会非常痛苦。

**好例子**

下面是显示代码片段的一个很好的示例。

> 以下代码片段显示了易受攻击的execute_command功能：
>
> 测试公司/应用程序/服务器/app.py：15
>
> ```
> @app.route('/execute', methods=['POST'])
> def execute_command():
>     command = request.json.get('command')
>     try:
>         process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)  # VULNERABLE
>         stdout, stderr = process.communicate()
>         return jsonify({'stdout': stdout.decode(), 'stderr': stderr.decode()}), 200
>     except Exception as e:
>         return jsonify({'error': str(e)}), 400
> ```

在上面的示例中，我们引入了代码片段（引用函数名称），并为客户端提供了要转到的文件路径和行号。此外，这次不是屏幕截图，如果读者想要从示例中搜索关键字，则可以从代码片段中复制和粘贴。受影响的行已被调用，并添加了“# VULNERABLE”注释。然后，可以在问题后面引用这一点。

如果您的报告平台支持编程语言的语法突出显示，也可以利用这一点。这将使其在报告中更具可读性。使用线条突出显示或不同的文本样式突出显示受影响的行也可能有效。

我见过的另一种方法是在代码片段中提供行号。这可能会使证据如下所示：

> 以下代码片段显示了易受攻击的函数：
>
> beta-corp/app/server/app.py
>
> ```
> 15. @app.route('/execute', methods=['POST'])
> 16. def execute_command():
> 18.    command = request.json.get('command')
> 19.
> 20.    try:
> 21.        process = subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
> 22.        stdout, stderr = process.communicate()
> 23.        return jsonify({'stdout': stdout.decode(), 'stderr': stderr.decode()}), 200
> 24.
> 25.    except Exception as e:
> 26.        return jsonify({'error': str(e)}), 400
> ```

这不是一个坏方法，因为现在您可以在后续文本中引用行号。

## HTTP 请求和响应

提供 Web 应用程序或 Web API 问题的证据对于正确处理非常重要。客户不理解 HTTP 层是很常见的，即使他们是 Web 应用程序开发人员。正因为如此，至关重要的是，我们不仅要给开发人员一个 HTTP 响应，还必须显示请求（可能会被修改），它突出显示了来自浏览器或其他应用程序的数据如何不应该被信任，因为它可以被修改。

此外，如果同事（甚至您）将来需要执行一些修正验证，如果没有完整的 HTTP 请求示例，则可能难以重现该发现。

**坏例子**

下面是一个请求和响应易受攻击问题的坏示例：

> 来自服务器的以下响应显示返回 uname -a 输出的 /execute 函数：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231946280.png)

虽然屏幕截图的介绍很好，很清楚，但证据本身并没有显示 HTTP 请求。如果将来的客户或测试人员想要重现结果，这是一个问题。请求的格式是什么？存在哪些 HTTP 标头，并且可能需要哪些 HTTP 标头才能正常工作？此处不提供此信息。

通过包含BurpSuite的完整屏幕截图，可以稍微好一点：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231946849.png)

但是，这有其自身的缺点。屏幕截图现在变得稍微难以阅读。由于 BurpSuite 的默认布局，当您将文本大小粘贴到报告文档中时，文本大小将变得不可读（HTTP 请求在左侧，HTTP 响应在右侧）：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231947170.png)

此外，如果需要通过代理工具复制此发现，则从图像中复制文本将不简单。我们需要确保客户和同事在未来尽可能容易地重现这些发现。

**好例子**

> 这里有一个更好的例子。
>
> 以下 HTTP 请求显示正在向服务器发送命令 uname -a：
>
> ```
> POST /execute HTTP/1.1
> Host: app.omnicorp.com
> User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3
> Accept: application/json
> Accept-Language: en-US,en;q=0.5
> Accept-Encoding: gzip, deflate, br
> Content-Type: application/json
> Content-Length: 31
> Connection: keep-alive
> Upgrade-Insecure-Requests: 1
>  
> {
>   "command": "uname -a"
> }
> ```
>
> 下面生成的 HTTP 响应显示了服务器 uname -a 的输出：
>
> ```
> HTTP/1.1 200 OK
> Server: Werkzeug/3.0.1 Python/3.11.0
> Date: Mon, 05 Feb 2024 11:27:00 GMT
> Content-Type: application/json
> Content-Length: 148
> X-Custom-Header: Value
> X-Security-Policy: Strict
> X-Powered-By: Flask
> X-Content-Type-Options: nosniff
> X-Frame-Options: SAMEORIGIN
> Content-Security-Policy: default-src 'self'
> Access-Control-Allow-Origin: *
> Connection: close
>  
> {
>   "stderr": "",
>   "stdout": "Linux omnicorp-server 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux"
> }
> ```

在这里，我已将 HTTP 请求和响应复制到查找文本中。这可以更容易地读取，当然，如果需要，将来复制回测试工具是微不足道的。

理想情况下，应该在这里执行语法高亮显示（Markdown 实际上支持 HTTP，如果你正在使用它的话），并且行高亮也应该以与代码片段相同的方式使用。

## 工具输出

我们的很多证据将基于工具输出。值得庆幸的是，我们已经介绍了上面的规则。

- 如果输出来自命令行，则应使用与代码片段相同的规则对其进行处理
- 如果输出来自显示结果通过或失败的应用程序，则最好将其呈现为屏幕截图

请考虑 wpscan 的以下工具输出：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231947829.png)

显然，这是一个大屏幕截图，可以进行一些裁剪。但值得一提的是，这在报告文件中可能是什么样子——不是很好。

下面是文本的样子：

```
┌──(kali㉿kali)-[~]
└─$ wpscan --url http://192.168.1.67:8082 --force
_______________________________________________________________
         __          _______   _____
         \ \        / /   __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |   ___/ \___ \ / __|/ _` | '_ \
            \  /\   /  | |     ____) | (__| (_| | | | |
             \/  \/    |_|    |_____/ \___|\__,_|_| |_|
 
         WordPress Security Scanner by the WPScan Team
                          Version 3.8.22
       Sponsored by Automattic - https://automattic.com/
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________
 
[+] URL: http://192.168.1.67:8082/ [192.168.1.67]
[+] Effective URL: http://192.168.1.67:8080/
[+] Started: Mon Feb   5 11:16:32 2024
 
Interesting Finding(s):
 
[+] XML-RPC seems to be enabled: http://192.168.1.67:8082/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/
 
[+] WordPress readme found: http://192.168.1.67:8082/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 
[+] The external WP-Cron seems to be enabled: http://192.168.1.67:8082/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299
 
[+] WordPress version 6.4.3 identified (Latest, released on 2024-01-30).
 | Found By: Style Etag (Aggressive Detection)
 |  - http://192.168.1.67:8082/wp-admin/load-styles.php, Match: '6.4.3'
 | Confirmed By: Opml Generator (Aggressive Detection)
 |  - http://192.168.1.67:8082/wp-links-opml.php, Match: 'generator="WordPress/6.4.3"'
 
[i] The main theme could not be detected.
 
[+] Enumerating All Plugins (via Passive Methods)
 
[i] No plugins Found.
 
[+] Enumerating Config Backups (via Passive and Aggressive Methods)
 Checking Config Backups - Time: 00:00:03 <=============================================================================================================================================================================================================================================> (137 / 137) 100.00% Time: 00:00:03
 
[i] No Config Backups Found.
 
[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register
 
[+] Finished: Mon Feb   5 11:17:04 2024
[+] Requests Done: 171
[+] Cached Requests: 7
[+] Data Sent: 44.134 KB
[+] Data Received: 38.077 KB
[+] Memory used: 220.699 MB
[+] Elapsed time: 00:00:31
```

这看起来并不令人惊奇，但它确实允许您以与代码片段相同的方式匹配文档其余部分的格式。

在这些情况下，语法突出显示可能无法很好地工作，在这种情况下，您应该裁剪掉，直到您留下要显示的证据的主要部分（如果可以的话）。如果可能的话，也要利用线条突出显示。行号在这里没有意义，因此应省略这些行号。

## 调查结果或附录中的证据

值得注意的是，有些证据可能太长，无法清晰地纳入调查结果。这可能是因为输出非常冗长，或者包含一些需要完整查看的示例（这可能会占用大量空间）。在这些情况下，只需将证据放在附录中并参考问题中的部分即可。

例如：

> 附录第 5.2 节详细介绍了整个攻击链的大量 HTTP 请求和响应。

一个超过几页的问题可能需要删减，尽管请在这里使用您的判断。

## 裁剪证据

如果您有包含冗余区域的证据，则可以将其裁剪回来。如果您想让结果更清晰地放在一两页上，或者您有很多示例要显示但不想将它们移动到附录部分，这将特别有用。

让我们看一个基于文本和屏幕截图的示例。

### 代码片段

对于基于文本的证据，这应该像注入“SNIP”或“[...]”词一样简单（记住在报告中的所有证据中使用相同的词）。

让我们看一个例子：

> 以下 PHP 应用程序包含易受攻击的 /search 端点：
>
> 应用程序/serve.php
>
> 
>
> ```
> 1. <?php
> 2. // Display search results
> 3. function displaySearchResults($query) {
> 4.     echo "Search results for: $query";
> 5. }
> 6.
> 7. // Process search query
> 8. function processSearchQuery($query) {
> 9.     // SNIP: Other processing logic could go here
> 10.    displaySearchResults($query);
> 11. }
> 12.
> 13. // Validate search query
> 14. function validateSearchQuery($query) {
> 15.     // SNIP: Validation logic might be expected here
> 16.    return $query; // Directly returns the query without sanitization
> 17. }
> 18.
> 19. // Main routing logic
> 20. $path = $_SERVER['REQUEST_URI'];
> 21.
> 22. if ($path == '/') {
> 23.     echo '<h1>Welcome to the PHP App</h1>';
> 24.     echo '<p>Use our API to interact with the system.</p>';
> 25. }
> 26. elseif ($path == '/data') {
> 27.     header('Content-Type: application/json');
> 28.     $data = ['key' => 'value', 'number' => 42, 'message' => 'Hello, world!'];
> 29.     echo json_encode($data);
> 30. }
> 31. elseif ($path == '/submit' && $_SERVER['REQUEST_METHOD'] == 'POST') {
> 32.     $name = isset($_POST['name']) ? $_POST['name'] : 'Anonymous';
> 33.     $email = isset($_POST['email']) ? $_POST['email'] : '';
> 34.     echo json_encode(['message' => "Thank you $name, we will contact you at $email."]);
> 35. }
> 36. elseif ($path == '/search') {
> 37.     $query = isset($_GET['query']) ? $_GET['query'] : '';
> 38.     $validatedQuery = validateSearchQuery($query);
> 39.     processSearchQuery($validatedQuery);
> 40. }
> 41. else {
> 42.     header("HTTP/1.0 404 Not Found");
> 43.     echo '<h1>404 Not Found</h1>';
> 44.     echo '<p>The page you requested was not found.</p>';
> 45. }
> 46. ?>
> ```

让我们裁剪掉不相关的代码，包括任何对问题不重要的尾随代码：

> 以下 PHP 应用程序包含易受攻击的 /search 端点：
>
> 应用程序/serve.php
>
> 
>
> ```
> 19. // Main routing logic
> 20. $path = $_SERVER['REQUEST_URI'];
> 21.
> 22. if ($path == '/') {
> SNIP
> 26. elseif ($path == '/data') {
> SNIP
> 31. elseif ($path == '/submit' && $_SERVER['REQUEST_METHOD'] == 'POST') {
> SNIP
> 36. elseif ($path == '/search') {
> 37.     $query = isset($_GET['query']) ? $_GET['query'] : '';
> 38.     $validatedQuery = validateSearchQuery($query);
> 39.     processSearchQuery($validatedQuery);
> 40. }
> 41. else {
> ```

此版本已被编辑以排除文件的开头，该文件不需要显示我们拥有的证据。然后，“if”和“elseif”执行路径的内容已被剪切，因为它们的内容对于解释漏洞不是必需的。你可以在这里更积极地进行截图，但我认为显示代码流很重要。

### 截图

与文本片段一样，图像也可以被剪切。我们之前看到过一个类似的例子，其中 Jenkins 系统配置页面被删减以专注于相关领域。

下面是另一个示例：

> 以下屏幕截图显示了正在启用的调试模式：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231947340.png)

我们可以比前面的示例更积极，通过调整浏览器页面的大小来减少屏幕截图占用的空间。另外，不要忘记添加有用的框突出显示：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231947240.png)

这对这些证据所占用的空间量产生了巨大的影响，但同时将所需的信息全部保留在屏幕截图中。

如果您已将屏幕截图做得更小且简洁，则不需要使用框突出显示显示受影响的区域。在这里使用你自己的判断。

## 没有证据的调查结果

虽然 99.9% 的发现应该有证据，但也有一些没有。这些边缘情况通常围绕着缺乏与安全相关的内容。以下是一些示例：

- 无密码更改机制（用于 Web 应用程序评估）
- 无多重身份验证（用于 Web 应用程序评估）
- 未安装日志记录或监视系统（用于服务器内部版本审查）
- 缺少 XXX 的策略（用于策略审查）
- No training being performed for XXX (for a policy review)

For these examples there is no evidence you can show that makes sense.

There are however other examples that might fall into this category, but evidence could be shown:

- 默认帐户和密码
  - 示例证据：HTTP 请求和响应显示使用一组默认凭据成功登录
- API 终端节点无速率限制
  - 示例证据：许多请求快速连续发送到服务器而未被阻止
- 没有帐户锁定机制
  - 示例证据：在多次尝试失败后，针对登录的暴力攻击成功
- 不遵循最小特权原则
  - 示例证据：同一组中所有用户的屏幕截图

因此，请仔细考虑没有明确证据的发现。你能用其他方式展示证据吗？例如，在没有安全功能存在或启用的情况下显示攻击是可能的。

## 课程总结

在本课中，我们介绍了确保报告中的证据清晰且对客户和我们的同行有帮助的关键领域。以下是我们介绍的内容的快速细分：

- 确保您只截取不仅仅是文本的内容
- 确保屏幕截图清晰易读 - 理想情况下，屏幕截图中的文本应与文档中的文本大小相似
- 突出显示屏幕截图中感兴趣的特定区域（如果适用）
- 在屏幕截图中，如果适用，请包含已测试内容的 URL 或其他可识别信息
- 避免对代码、配置文件或任何其他基于文本的格式进行屏幕截图
  - 这包括 HTTP 请求和响应！
- 对以文本形式呈现的所有证据使用语法高亮，记住存在 HTTP 语法高亮
- 通过剪掉图像的冗余部分（并在屏幕截图之前调整页面或应用程序的大小）和剪掉多余的文本来保持证据简洁
- 将大量证据移至附录

如果您在创建调查结果时遵循这些要点，您的客户将清楚地了解证据，并且他们将更容易重现漏洞。此外，任何验证结果是否已修复的后续工作对同事来说都将更容易，因为可以快速找到结果中受影响的功能，并且他们需要的所有信息都将在手边重现结果。

# 19-证据 - 练习

在上一课中，我们介绍了许多证据类型以及呈现它们的最佳方式。

让我们通过一些练习来测试你所学到的东西。

**反思练习**

- 反思您最近撰写或有权访问的报告。调查结果中提供的证据是否足够清晰和全面，以至于不熟悉该项目的人能够理解和重现调查结果？
  - 如何改进证据呈现？
- 想一想，由于证据不足，您很难从报告中重现调查结果。缺少什么，如何才能更好地呈现？

**一般练习**

- 回顾一下您在 OmniCorp 章节示例调查结果中包含的证据 - 您是否包含了所有必需的证据？如果没有，请根据上一课的信息进行必要的调整。
- 请看以下屏幕截图。您能发现哪些问题？你会如何提出证据？
- ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231947177.png)
- 请考虑以下 testssl 工具输出。您能发现哪些问题？你会如何提出证据？([output.csv](https://files.cdn.thinkific.com/file_uploads/584845/attachments/559/a43/e44/output.csv))

**超越练习**

您能否从常用工具中找到任何 CLI 工具或输出模式，以保留任何颜色高亮，使客户更容易阅读输出？

# 20-机密和敏感数据的编辑

报告不仅非常敏感（包含影响基础设施、Web 应用程序和/或其他事物的开放漏洞列表），而且它们通常可以包含凭据或其他秘密材料作为证据的一部分。这实质上意味着任何有权访问包含此信息的报告的人都可能能够破坏帐户、解密数据或以其他方式访问他们通常不会拥有的东西。

虽然报告应由顾问安全地交付，但报告及其内容在未来仍有可能受到损害：

- 报告是安全存储的，但高级威胁参与者可以访问这些参与者，这些参与者已泄露了具有重要权限的帐户
- 报告的内容已被提取并放入问题跟踪系统进行补救，并且具有访问权限的开发人员帐户已遭到入侵
- 报告文档被过度共享，而那些不应该有权访问它们的人可以访问它们

这一点很重要，因为报告中讨论的调查结果可能与高特权帐户有关，如果它们被利用，它们可能不明显如何以及是否受到损害。应该注意的是，有时很难不提及找到的特定凭据，尤其是在默认凭据或极其常见的服务密码的情况下。但是，如果报告落入坏人之手，我们应该帮助限制后果。

除了防止帐户和服务泄露外，我们还必须照顾客户的客户。我们应尽可能确保我们的报告不包含 PII（个人身份信息），并且我们应确保始终执行敏感客户数据的编辑。

最后，具体评估可能需要编辑或完全省略其他信息。客户可以规定某些证据不能放在报告中，或者应该以某些方式进行编辑。例如，根本不允许将代码片段作为证据，只允许使用文件路径和行号，或者不应将来自代码某些区域的代码片段放入报告中（例如，与非常敏感的专有算法相关的代码）。在开始评估之前，请确保了解这些要求。

因此，应考虑编辑的关键信息是：

- 任何形式的证书材料
- 个人身份信息 （PII）
- 其他敏感数据

在这个包罗万象的要点中，“敏感”的关键词显然是与上下文相关的。如果您正在测试医疗保健软件提供商，“敏感”可能与患者的医疗记录有关。如果您正在为一家律师事务所执行内部基础设施评估，并发现一个包含与其知名客户达成和解协议备份的未结份额，则这些将被视为敏感。在为您的问题创建证据时，请考虑数据的所有者及其涉及的对象（组织或个人）——是否应该编辑他们的信息以保护他们的业务或身份？如果是，则应对证据进行编辑或以省略敏感方面的方式捕获证据。

让我们看一下编辑的过程。

## 编辑过程

编辑机密并不一定很困难 - 只需确保将机密替换为 REDACTED，如果它与特定问题有关，则可能会突出显示编辑。

下面是查看包含基本身份验证用户名和密码的客户端的 DevOps 代码时可能会看到的 .htaccess 文件中的基本示例：

```
AuthType Basic
AuthName "Admin Area"
AuthUserFile /dev/null
AuthBasicProvider env
SetEnv MY_BASIC_AUTH "admin:password123"
Require expr %{HTTP:Authorization} == "Basic %{ENV:MY_BASIC_AUTH}"
```

以下是编辑可能的样子：

```
AuthType Basic
AuthName "Admin Area"
AuthUserFile /dev/null
AuthBasicProvider env
SetEnv MY_BASIC_AUTH "admin:REDACTED"
Require expr %{HTTP:Authorization} == "Basic %{ENV:MY_BASIC_AUTH}"
```

我经常看到顾问对一些机密进行一些部分编辑（通常使用 NTLM 哈希以显示共享密码使用情况），留下前 3-4 个字符、单词 REDACTED 和尾随的 3-4 个字符。这是可以的，并且在某些问题上进一步证明您发现的内容是有效的。对于在正在审查的文件中找到敏感信息的某些问题，可以编辑整个字符串。最有效的用例是当您运行工具或对某些东西执行漏洞利用时，您需要展示可以获得什么。

下面是来自 Linux 主机的影子文件示例，其中使用的哈希格式为 SHA-1：

```
root:$1$VGxkR3Mw$4Wj2r0QabIoFbC9EYK5A4/:18295:0:99999:7:::
daemon:*:18295:0:99999:7:::
bin:*:18295:0:99999:7:::
sys:*:18295:0:99999:7:::
sync:*:18295:0:99999:7:::
games:*:18295:0:99999:7:::
man:*:18295:0:99999:7:::
lp:*:18295:0:99999:7:::
mail:*:18295:0:99999:7:::
news:*:18295:0:99999:7:::
uucp:*:18295:0:99999:7:::
proxy:*:18295:0:99999:7:::
www-data:*:18295:0:99999:7:::
backup:*:18295:0:99999:7:::
list:*:18295:0:99999:7:::
irc:*:18295:0:99999:7:::
gnats:*:18295:0:99999:7:::
nobody:*:18295:0:99999:7:::
systemd-timesync:*:18295:0:99999:7:::
systemd-network:*:18295:0:99999:7:::
systemd-resolve:*:18295:0:99999:7:::
systemd-bus-proxy:*:18295:0:99999:7:::
syslog:*:18295:0:99999:7:::
_apt:*:18295:0:99999:7:::
lxd:*:18295:0:99999:7:::
messagebus:*:18295:0:99999:7:::
uuidd:*:18295:0:99999:7:::
dnsmasq:*:18295:0:99999:7:::
sshd:*:18295:0:99999:7:::
user:$1$VGxkR3Mw$4Wj2r0QabIoFbC9EYK5A4/:18295:0:99999:7:::
```

与其使用“已编辑”一词，另一种选择是用 X（大写或小写）替换字符。有时，哈希的剪切部分只是三个 x 是很常见的。稍后将看到这方面的示例。无论您决定采用哪种方式，只要确保在整个报告中保持一致即可。

以下是部分编辑的样子（哈希编辑而不是盐）：

```
root:$1$VGxkR3Mw$4WjXXXXXXXXXXXXXXX5A4/:18295:0:99999:7:::
daemon:*:18295:0:99999:7:::
bin:*:18295:0:99999:7:::
sys:*:18295:0:99999:7:::
sync:*:18295:0:99999:7:::
games:*:18295:0:99999:7:::
man:*:18295:0:99999:7:::
lp:*:18295:0:99999:7:::
mail:*:18295:0:99999:7:::
news:*:18295:0:99999:7:::
uucp:*:18295:0:99999:7:::
proxy:*:18295:0:99999:7:::
www-data:*:18295:0:99999:7:::
backup:*:18295:0:99999:7:::
list:*:18295:0:99999:7:::
irc:*:18295:0:99999:7:::
gnats:*:18295:0:99999:7:::
nobody:*:18295:0:99999:7:::
systemd-timesync:*:18295:0:99999:7:::
systemd-network:*:18295:0:99999:7:::
systemd-resolve:*:18295:0:99999:7:::
systemd-bus-proxy:*:18295:0:99999:7:::
syslog:*:18295:0:99999:7:::
_apt:*:18295:0:99999:7:::
lxd:*:18295:0:99999:7:::
messagebus:*:18295:0:99999:7:::
uuidd:*:18295:0:99999:7:::
dnsmasq:*:18295:0:99999:7:::
sshd:*:18295:0:99999:7:::
user:$1$VGxkR3Mw$4WjXXXXXXXXXXXXXXX5A4/:18295:0:99999:7:::
```

当涉及到屏幕截图时，只需将屏幕截图复制到图像编辑器中，然后将敏感信息的区域涂黑即可。

下面是一个示例：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231948521.png)

不要在文字处理器中将框覆盖在图像上，因为底层图像可能是可检索的！

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231948466.png)

最后，在问题中提及凭据的编辑以及它们被编辑的原因也不是一个坏主意 - 这可能会先发制人地解决客户可能对您为什么这样做的任何问题。我以前没有做过很多次，因为这很明显，但如果你愿意，你可以这样做。

你可以简单地说这样的话：

> 由于拥有此 API 密钥的任何人都可以删除整个生产数据库，因此它已被编辑。

让我们看一些具体发现的证据示例，并展示如何编辑它们。

### 弱SNMP社区字符串

SNMP社区字符串通常很弱，在网络上很容易被猜到。让我们看一下 Metasploits snmp_login模块的示例输出：

```
use auxiliary/scanner/snmp/snmp_login
set RHOSTS 192.168.1.0/24
set THREADS 10
run
[*] Scanning IP range 192.168.1.0/24 for SNMP devices using community strings from list.txt...
[+] 192.168.1.20:161 - Success: 'secret'
[*] Scan completed in 45 seconds
```

在这里，我们有一些证据证明发现了一个非常弱的社区字符串。在本例中，使用了 Metasploit 中的默认单词列表。最好在证据中掩盖社区字符串，并简单地描述这个词。利用此漏洞的影响可能仅限于信息泄露，但攻击者可能足以发现足够的信息，使其他攻击成为可能（例如，查找针对特定操作系统版本或服务版本所需的特定版本控制信息）。

证据应按以下方式编辑，并给予以下评论：

> 使用 Metasploit 的 snmp_login 模块对网络上运行的 SNMP 服务执行了密码猜测攻击。以下输出显示，其中一个主机响应了一个基本社区，这是一个小写的常用词：
>
> ```
> use auxiliary/scanner/snmp/snmp_login
> set RHOSTS 192.168.1.0/24
> set THREADS 10
> run
> [*] Scanning IP range 192.168.1.0/24 for SNMP devices using community strings from list.txt...
> [+] 192.168.1.20:161 - Success: 'REDACTED'
> [*] Scan completed in 45 seconds
> ```

当然，攻击者可以自己执行攻击，但我们至少可以通过不给他们确切的社区字符串来让他们更难。

**反射的 XSS**

您可能想知道为什么反射的 XSS 会包含敏感信息。它可能取决于应用程序和用户，但当您发现经过身份验证的 Web 应用程序漏洞时，通常最好从请求中删除会话令牌，因为它们是机密。

下面是一个示例请求和响应：

```
GET /search?query=<script>alert('XSS');</script>&sessionToken=abc123 HTTP/1.1
Host: vulnerable-website.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Referer: https://vulnerable-website.com/search
Cookie: sessionToken=7f5f228e8e23a804f37d5256173976a2b70a2c14; otherCookie=value
Connection: keep-alive


HTTP/1.1 200 OK
Date: Mon, 05 Feb 2024 12:00:00 GMT
Server: Apache/2.4.29 (Ubuntu)
Content-Type: text/html; charset=UTF-8
Content-Length: 1024
<html>
<head><title>Search Results</title></head>
<body>
<h1>Search Results for '<script>alert('XSS');</script>'</h1>
<p>No results found for your search.</p>
</body>
</html>
```

虽然此处描述的问题与会话令牌无关，但仍应谨慎对待。被盗的会话令牌将允许攻击者成为用户并执行用户有权执行的任何操作。值得注意的是，评估结束后代币的会话到期和一般有效性可能会使编辑变得毫无意义，但我觉得最好谨慎行事并无论如何编辑它们。

以下是我们如何编辑这个秘密：

```
GET /search?query=<script>alert('XSS');</script>&sessionToken=abc123 HTTP/1.1
Host: vulnerable-website.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Referer: https://vulnerable-website.com/search
Cookie: sessionToken=REDACTED; otherCookie=value
Connection: keep-alive
```

您始终可以完全删除 Cookie 行，但务必使请求的结构尽可能接近原始结构，以确保将来可以复制它们。

### 代码中的硬编码机密

这是一个我过去处理过很多次的经典例子——硬编码的秘密。这在所有大型代码库中都是一个普遍存在的问题，并且通常总是在我参与的代码审查项目中提出。

机密可以采取多种形式：

- 用户帐户凭据
- 服务帐户凭据
- API 密钥
- SSH 密钥
- 私钥
- 密码哈希
- 加密密钥

我见过这样的案例，客户会声称其中一些不是真正的秘密，因为它们要么是哈希的，要么是加密的。如果攻击者已经获取了代码，他们现在可以尝试检索这些机密的明文版本。如果还获得了任何加密密钥的密钥，他们也将能够解密这些密钥。任何秘密材料的最佳位置是在加密的密钥存储服务中，只有有限的一组工程师可以访问它们。

无论客户对此类问题的容忍度如何，我都建议报告您发现的所有实例。如果他们觉得自己在安全地管理风险，则由他们来评估风险并接受风险。

以下是一些机密和编辑过程的示例：

**服务帐户凭据**

```
import com.google.auth.oauth2.GoogleCredentials;
import com.google.cloud.storage.Storage;
import com.google.cloud.storage.StorageOptions;
public class StorageService {
    private Storage storage;
    public StorageService() {
        String projectId = "your-project-id";
        String credentialsJSON = "{"
                + "\"type\": \"service_account\","
                + "\"project_id\": \"" + projectId + "\","
                + "\"private_key_id\": \"29a5404bed7...",
                + "\"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBg...",
                + "\"client_email\": \"storage-access@your-project-id.iam.gserviceaccount.com\","
                + "\"client_id\": \"113545198550469668813\","
                + "\"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\","
                + "\"token_uri\": \"https://oauth2.googleapis.com/token\","
                + "\"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\","
                + "\"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/storage..."
                + "}";
        try {
            this.storage = StorageOptions.newBuilder()
                    .setProjectId(projectId)
                    .setCredentials(GoogleCredentials.fromStream(new ByteArrayInputStream(credentialsJSON.getBytes())))
                    .build()
                    .getService();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    // Method to interact with Cloud Storage...
}
```

**服务帐户凭据 - 已编辑**

```
import com.google.auth.oauth2.GoogleCredentials;
import com.google.cloud.storage.Storage;
import com.google.cloud.storage.StorageOptions;
public class StorageService {
    private Storage storage;
    public StorageService() {
        String projectId = "your-project-id";
        String credentialsJSON = "{"
                + "\"type\": \"service_account\","
                + "\"project_id\": \"" + projectId + "\","
                + "\"private_key_id\": \"29a5404bed7...",
                + "\"private_key\": \"REDACTED",
                + "\"client_email\": \"storage-access@your-project-id.iam.gserviceaccount.com\","
                + "\"client_id\": \"113545198550469668813\","
                + "\"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\","
                + "\"token_uri\": \"https://oauth2.googleapis.com/token\","
                + "\"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\","
                + "\"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/storage..."
                + "}";
        try {
            this.storage = StorageOptions.newBuilder()
                    .setProjectId(projectId)
                    .setCredentials(GoogleCredentials.fromStream(new ByteArrayInputStream(credentialsJSON.getBytes())))
                    .build()
                    .getService();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    // Method to interact with Cloud Storage...
}
```

**API 密钥**

```
const API_ENDPOINT = 'https://api.thirdpartyservice.com/data';
const API_KEY = 'AIzaSyD-3nJrHqZzX78PQlLW2KxYQ4elV2Q7X9M';
fetch(`${API_ENDPOINT}?key=${API_KEY}`, {
    method: 'GET',
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
    },
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Error fetching data:', error));
```

**API 密钥 - 已编辑**

```
const API_ENDPOINT = 'https://api.thirdpartyservice.com/data';
const API_KEY = 'REDACTED';
fetch(`${API_ENDPOINT}?key=${API_KEY}`, {
    method: 'GET',
    headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
    },
})
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error('Error fetching data:', error));
```

**加密密钥**

```
from cryptography.fernet import Fernet
class DataEncryptor:
    def __init__(self):
        self.encryption_key = b'G68ZAfT3WbR8KfrP4u5Bw1vQ2sTc6X0vq9eRySdZzWc='
        self.cipher_suite = Fernet(self.encryption_key)
    def encrypt_data(self, data):
        return self.cipher_suite.encrypt(data.encode())
    def decrypt_data(self, token):
        return self.cipher_suite.decrypt(token).decode()
```

**加密密钥 - 已编辑**

```
from cryptography.fernet import Fernet
class DataEncryptor:
    def __init__(self):
        self.encryption_key = b'REDACTED'
        self.cipher_suite = Fernet(self.encryption_key)
    def encrypt_data(self, data):
        return self.cipher_suite.encrypt(data.encode())
    def decrypt_data(self, token):
        return self.cipher_suite.decrypt(token).decode()
```

### 具有弱密码的域用户帐户

下面是工具输出和密文的示例。在本例中，我们使用 crapmapexec 工具使用通用密码列表使用一组已知的用户名在网络上执行密码猜测攻击：

```
[*] Starting CrackMapExec password spray attack at 2024-02-05 10:00:00
[*] Targeting IPs: 192.168.1.100-192.168.1.150
[*] Using username list: usernames.txt
[*] Using password list: common_passwords.txt
[*] Attempting connection to 192.168.1.105:445 - SUCCESS
[*] Spraying password: Summer2024
    [-] Failed login for: admin
    [-] Failed login for: user1
    [+] Successful login for: jdoe - Password: Summer2024
    [-] Failed login for: guest
[*] Attempting connection to 192.168.1.110:445 - SUCCESS
[*] Spraying password: Password123
    [-] Failed login for: admin
    [+] Successful login for: admin - Password: Password123
    [-] Failed login for: user1
    [-] Failed login for: jdoe
[*] Attempting connection to 192.168.1.120:445 - FAILED
[*] Attempting connection to 192.168.1.125:445 - SUCCESS
[*] Spraying password: admin2024
    [-] Failed login for: admin
    [-] Failed login for: user1
    [-] Failed login for: jdoe
    [-] Failed login for: guest
[*] Attack summary:
    - Total attempts: 12
    - Successful logins: 2
    - Unique IPs attempted: 4
[*] Successful credentials:
    - 192.168.1.105 - jdoe:Summer2024
    - 192.168.1.110 - admin:Password123
[*] CrackMapExec password spray attack completed at 2024-02-05 10:15:00
```

在这里，我们应该简单地编辑为帐户找到的密码。由于这是来自内部测试，我们应该告诉客户端哪些帐户受到弱密码的影响：

```
[*] Starting CrackMapExec password spray attack at 2024-02-05 10:00:00
[*] Targeting IPs: 192.168.1.100-192.168.1.150
[*] Using username list: usernames.txt
[*] Using password list: common_passwords.txt
[*] Attempting connection to 192.168.1.105:445 - SUCCESS
[*] Spraying password: REDACTED
    [-] Failed login for: admin
    [-] Failed login for: user1
    [+] Successful login for: jdoe - Password: REDACTED
    [-] Failed login for: guest
[*] Attempting connection to 192.168.1.110:445 - SUCCESS
[*] Spraying password: REDACTED
    [-] Failed login for: admin
    [+] Successful login for: admin - Password: REDACTED
    [-] Failed login for: user1
    [-] Failed login for: jdoe
[*] Attempting connection to 192.168.1.120:445 - FAILED
[*] Attempting connection to 192.168.1.125:445 - SUCCESS
[*] Spraying password: REDACTED
    [-] Failed login for: admin
    [-] Failed login for: user1
    [-] Failed login for: jdoe
    [-] Failed login for: guest
[*] Attack summary:
    - Total attempts: 12
    - Successful logins: 2
    - Unique IPs attempted: 4
[*] Successful credentials:
    - 192.168.1.105 - jdoe:REDACTED
    - 192.168.1.110 - admin:REDACTED
[*] CrackMapExec password spray attack completed at 2024-02-05 10:15:00
```

### 正在使用的 SNMP 公共社区字符串

让我们再次访问SNMP，但谈谈公共社区字符串。下面是示例输出：

```
use auxiliary/scanner/snmp/snmp_login
set RHOSTS 192.168.2.0/24
set COMMUNITY_FILE /path/to/community/string/list.txt
set THREADS 10
run
[*] Scanning IP range 192.168.2.0/24 for SNMP devices using community strings from list.txt...
[+] 192.168.2.22:161 - Success: 'public'
[*] Scan completed in 45 seconds
```

当您遇到默认凭据或通常在标题中称为问题的非常常见的凭据时，在处理证据时有两种选择。您可以选择将其保持“原样”，即使您编辑了凭据，知道自己在做什么的攻击者也可能很容易找出凭据。另一种选择是调整标题并围绕证据进行讨论，就像前面的例子一样。

以下是您的处理方法：

> 标题：正在使用的 SNMP 弱社区字符串
>
> 从Metasploit工具对网络上运行的SNMP服务执行了单词列表攻击。以下输出显示其中一个主机响应了一个非常常见且默认的社区字符串：
>
> ```
> use auxiliary/scanner/snmp/snmp_login
> set RHOSTS 192.168.2.0/24
> set COMMUNITY_FILE /path/to/community/string/list.txt
> set THREADS 10
> run
> [*] Scanning IP range 192.168.2.0/24 for SNMP devices using community strings from list.txt...
> [+] 192.168.2.22:161 - Success: 'REDACTED'
> [*] Scan completed in 45 seconds
> ```

正如你所看到的，证据的描述与前面的例子一样，但足够模糊，以至于读者无法立即看出它是什么。与本课中需要轮换/更改凭据的所有实例一样，客户端需要转到源代码进行更改，因此他们应该能够自己查看密钥是什么。

这取决于你想如何处理这个问题，以及你的谨慎门槛是什么。显然，任何知道自己在做什么的攻击者都会看穿这一点。如果是我，我会谨慎行事并编辑。

### 正在使用的 SHA-1 密码哈希方案

让我们看另一个例子，其中有一些从数据库返回的哈希和敏感数据。此工具输出是使用 sqlmap 工具收集的：

```
Database: customers_db
Table: users
[5 entries]
+----+------------------+----------------------------+------------------------------------------+-----------------------------+
| id | name             | email                      | address                                  | sha1_password_hash               |
+----+------------------+----------------------------+------------------------------------------+-----------------------------+
| 1  | John Doe         | johndoe@example.com        | 1234 Elm St, Anytown, CA 90210           | 21d8f9ab49dfad293255f9c467d5a9e4a3b55a47 |
| 2  | Jane Smith       | janesmith@example.com      | 5678 Oak St, Somewhere, NY 10001         | 3f79bb7b435b05321651daefd374cdc681dc06e7 |
| 3  | Mike Johnson     | mikej@example.net          | 91011 Pine St, Littletown, TX 75001      | 71ac9eac8c7c5ab3d9e0bda11691a23e561b1a37 |
| 4  | Emily White      | emilywhite@example.org     | 1213 Maple Ave, Bigcity, FL 33101        | 2a76fba8c72a9db9d4a1e5d1d1f5bf68d1981651 |
| 5  | Alex Brown       | alexb@example.com          | 1415 Cherry Blvd, Smallville, WA 98101   | 05a671c66aefea124cc08b76ea6d30bb9c337a8b |
+----+------------------+----------------------------+------------------------------------------+-----------------------------+
```

我们不想像这样在报告中披露特定的个人，也不想输入他们的哈希值，这可能会被有权访问报告的攻击者破解。

让我们看看如何编辑这些内容：

```
Database: customers_db
Table: users
[5 entries]
+----+----------------+----------+----------+--------------------+
| id | name           | email    | address  | sha1_password_hash |
+----+----------------+----------+----------+--------------------+
| 1  | John REDACTED  | REDACTED | REDACTED | 21dxxxa47          |
| 2  | Jane REDACTED  | REDACTED | REDACTED | 3f7xxx6e7          |
| 3  | Mike REDACTED  | REDACTED | REDACTED | 71axxxa37          |
| 4  | Emily REDACTED | REDACTED | REDACTED | 2a7xxx651          |
| 5  | Alex REDACTED  | REDACTED | REDACTED | 05axxxa8b          |
+----+----------------+----------+----------+--------------------+
```

在这里，个人的姓氏以及他们的电子邮件和地址都被屏蔽了（这应该会阻止他们被识别）。哈希值大多被编辑，xxx 代表取出的哈希值的中间。作为奖励，报告中的表格要干净得多。

### 屏幕截图示例

下面是一个示例 LFI（本地文件包含）问题，最好截屏而不是复制并粘贴到报告中（或者您可以使用 HTTP 请求和响应，但假设您要截取它）：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231948743.png)

与本课前面的示例一样，目标是屏蔽敏感信息：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231948803.png)

和以前一样，我已经掩盖了所有会泄露客户身份的元素。这一次，我决定屏蔽整个哈希值。这不是从数据库获取特定数据的问题，而是在磁盘上检索文件的问题，因此我认为不需要显示任何哈希样本。

## 课程总结

本课介绍了在安全报告中编辑敏感信息的重要性。我们强调了这些报告中的风险，其中包含有关开放漏洞和潜在秘密材料的详细信息，如何被破坏文档的攻击者或可能无权访问报告中证明的秘密的恶意内部人员所利用。

以下是我们介绍的内容：

- 安全报告的敏感性和相关的暴露风险。
- 迫切需要安全传输和存储这些报告。
- 编辑敏感数据（如凭据、PII 和其他敏感详细信息）的过程和重要性。
- 不同方案中的脱敏示例，包括代码、配置文件和安全测试证据。
- 客户特定要求对编辑过程的重要性。

要记住的事项：

- 仔细审查证据并编辑任何敏感内容。
- 遵循特定于客户端的编辑要求。
- 使用部分编辑来平衡结果证明，同时限制安全风险。
- 如果不确定是否需要编辑，则最好进行编辑。

通过关注这些做法，我们可以最大限度地降低敏感信息泄露的风险，并在报告落入坏人之手时保护客户及其客户。

# 21-机密和敏感信息的编辑 - 练习

上一课介绍了确保包含机密和其他敏感数据的证据应谨慎处理并适当编辑的重要性。

让我们对此做一些快速练习。

**反思练习**

查看您最近撰写或有权访问的报告。报告是否包含任何应编辑的秘密或敏感信息？

**一般练习**

- 查看 OmniCorp 章节练习结果、您包含在问题中的证据。是否需要执行任何其他编辑？
- 列出应从报告中编辑的项目清单。

**超越练习**

调查可能存在哪些工具可以协助编辑过程，尤其是那些可以在不影响发现证据完整性的情况下自动执行部分编辑的工具。

# 22-建议 - 简介

一旦我们向客户解释了这个问题，他们就会了解如何解决这个问题。建议部分是我通常鼓励添加比通常级别更多的信息的另一个领域。

提供其他信息有三个主要原因：

- 确保客户了解他们可以执行的步骤，以发现并防止再次出现相同的问题
- 如果需要，建议客户端在其他地方检查问题
- 确保可以单独解决问题（与描述一样）

这里的第一点与预防性指导有关。其中一些内容可载于报告的战略建议部分。虽然这样做非常重要，但我确实发现将这些信息保留在调查结果本身中很有用，因为它可以将所有建议集中在一个地方。除此之外，它还是一个很好的提示，说明在主要建议部分要写什么（您可以扫描所有发现以查看您需要涵盖的内容）。此外，如果调查结果从报告中转移到单独的跟踪系统，执行摘要中概述的任何预防措施仍将包含在调查结果本身中。这样，这些重要的建议就不太可能被遗忘。

这里的第二点是，如果需要，给你的客户一些提示，去对评估的内容进行全面检查，以确保问题在其他地方不存在。这并不适用于所有问题（例如，环境中的单个服务缺少特定的配置设置），但在许多情况下，这将适用。一些例子包括：

- 在大型代码库中发现的危险编程模式
- 在基于抽样的测试中发现的结果
- 在 Web 应用程序中发现的注入类型漏洞
- 等。

如果你觉得其他地方存在某种合理的可能性，你应该建议你的客户进行一些调查。

在涉及这两个额外领域后，调查结果建议可以从报告中获取并单独使用，而不必参考报告的主要建议部分。

因此，这就引出了我建议在建议部分提出的三个要点：

- 修复发现的内容：
  - 客户端应如何修正您发现的问题？
- 查找其他实例：
  - 这个问题可能存在于其他地方吗？如果是，建议客户进行调查。
- 预防性建议
  - 您有什么建议可以确保此问题不再发生？
  - 如果再次发生，您有什么建议可以确保发现此问题？

您需要将所有这些要点都放在推荐部分吗？我绝对会涵盖前两个类别。正如我在整个课程中提到的，我非常赞成确保可以孤立地阅读问题，因此我会将这些信息放在调查结果中。但是，预防性建议部分可以留给执行摘要之后的建议部分。与描述中的影响和您在其中输入的信息一样，您的偏好或报告结构可能会有所不同。

在呈现方面，我通常会将所有这些信息包含在一个部分中，而不会单独指出这三个类别中的每一个，但是，我可以看到这样做的好处。这种方式将清楚地显示客户可以而且应该采取的各种方法来解决问题。

我将本课分为多个部分，涵盖了上述三个小节，用于调查结果的推荐部分，然后是包含一些示例的课程，最后是课程总结，其中包括一些关于建议部分需要考虑的注意事项。

让我们更详细地了解这些要点。

# 23-建议 - 修复发现的内容

建议部分的这一部分的内容应完全集中在客户应如何解决发现的直接问题上。如果你以前写过报告，这肯定是你习惯写的。

一些高级示例：

- 这些可能是需要采取的步骤来修正配置问题
- 用于修复代码或 Web 应用程序问题的实现级别建议
- 关于改进现有安全功能的建议

本节的内容看起来与每个问题和评估的问题大不相同，但是有一些建议可以应用于大多数问题。

现在让我们来看看这些。

## 推荐上下文

一些修复方法可以直接向客户表达，要么是因为一般建议是司空见惯的，要么是问题有如此明确的解决方案，很容易谈论。但是，在许多情况下，有些建议会受益于您对客户的额外见解和背景。这可能是他们的实现堆栈、他们的运作方式或您正在评估的具体内容。

此外，虽然您应该始终努力推荐最佳指导，但有时需要对客户做出更谨慎和深思熟虑的回应。在某些情况下，针对某个问题的建议修复要么不可行，要么需要花费大量时间和/或精力（甚至金钱）来修复。如果您知道客户可能是这种情况，您应该考虑客户处理问题的其他方法，但这应该始终首先遵循最佳建议（无论努力或成本如何），并且其他建议应该有任何影响或缺点。

以下是几个示例：

**过时的第三方库**

考虑一个小型开发团队，该团队已经构建并维护了一个大约 10 年的应用程序。他们经常对他们的 Web 应用程序进行外部测试，但你进来是为了对底层应用程序执行他们的代码审查。虽然您发现应用程序本身大多是健壮的，但存在少量缺陷（在通常只能通过访问代码才能发现的领域），但您确实发现许多第三方库已经过时并且运行易受攻击的版本。考虑到正在使用的库的年龄以及针对它们的集体 CVE 的数量，在测试时间内验证漏洞在其应用程序中是否可利用是不可行的。

现在这里要说的显而易见的事情是：

> 将第三方库更新到最新版本。

和

> 确保库在开发过程中保持最新状态。

虽然这些应该是最终目标，但客户的现实情况是，他们无法简单地升级所有库并期望一切正常。它需要是一种缓慢而有条不紊的升级方法。客户的测试过程（代码中的单元测试（自动代码测试）和用于测试应用程序的功能和核心功能的动态测试）可能低于标准甚至缺失。如果是这种情况，那么安全地升级到更高版本的代码将变得非常困难。

因此，我们应该考虑他们的情况，同时确保我们提供最好的建议。下面可能是这样：

> 查看过时和易受攻击的库，并将其升级到最新版本。考虑首先关注具有已知漏洞的库，并进一步确定这些漏洞的优先级，以发现应用程序因使用和/或对正在运行的版本存在严重问题的库而容易受到攻击的库。
>
> 如果特定代码库由于实现方式而难以升级，则可以利用 Web 应用程序防火墙来防止利用影响库的已知漏洞的尝试。但是，这只能被视为短期缓解措施，并且应解决所有包含漏洞的过时库的升级问题。
>
> 展望未来，确保在开发过程中及时审查和更新库。理想情况下，这应该使用工具自动执行（例如 GitHub 上的 Dependabot、Trivy 或 OWASP Dependency Check）。确保跟踪主要框架版本的生命周期终止通知，以便可以提前执行任何迁移。

在这里，我们为客户提供了一种有节制的方法，以解决可能压倒性的问题，并提供一些临时措施，这些措施可用于在他们升级解决方案时在短期内抵消一些风险。我要指出的是，我们在这里误入了预防性指导的领域，你可以看到我们如何建议他们如何阻止和防止这种情况在未来成为问题。

**过时和有缺陷的支付网关实施**

假设我们已经为一个使用传统支付网关平台进行支付的电子商务网站的客户进行了深入评估。该解决方案的架构不支持任何现代加密标准或安全身份验证方法，这使客户卡详细信息（及其个人信息）面临重大风险。

这里最好的指导显然是使用提供最新加密和身份验证标准的支付提供商来安全传输支付详细信息。以下是可能推荐的内容：

> 将电子商务支付操作迁移到支持最新加密标准的提供商（用于传输层安全和现代身份验证的最低 TLS v1.2（例如，双向 TLS 与基于 API 密钥的身份验证相结合））。

此响应为客户提供了一些有用的细节供客户调查，但从不使用 TLS 或任何身份验证且与电子商务网站具有截然不同的通信方式的旧系统的过渡可能相当可观。虽然我们必须建议他们摆脱这种薄弱的架构，必须处理硬迁移过程，但我们应该提供一些建议来限制短期内的风险。

下面是这可能是什么样子的：

> 将电子商务支付操作迁移到支持最新加密标准的提供商（用于传输层安全和现代身份验证的最低 TLS v1.2（例如，双向 TLS 与基于 API 密钥的身份验证相结合））。
>
> 建议在执行迁移到新系统时，在短期内采取几个步骤来保护客户数据：
>
> - 请考虑对包含客户数据的未加密流量执行网络隔离，并且仅允许对特定提供商的出站访问。这可以防止攻击者轻松访问已破坏内部网络的流量。
> - 请与当前的提供商联系，看看他们是否会将 TLS（甚至 SSL）作为短期解决方案。如果有任何形式的传输层加密，甚至是过时的版本，这将是比完全不加密更好的选择。
> - 请与当前提供商联系，了解他们是否有任何可以在短期内使用的身份验证方法。这总比完全没有身份验证要好。
> - 请与当前提供商联系，了解他们是否可以允许从您的环境建立 VPN 隧道，以隧道传输未加密的流量。虽然这将允许在加密隧道中通过 Internet 发送流量，但它无法解决隧道内数据本身的根本问题，该问题可能会被网络两侧的攻击者拦截。

在这里，我们保留了最初的建议，因为离开旧平台至关重要，但我们也提供了一些关于在短期内可以采取哪些措施来限制该问题的可利用性的指南，尽管是有限的。

------

另一个重要的领域是利用我们对特定组织的了解。我们可以用它来定制特定的建议，否则这些建议会稍微通用一些。一些示例可能包括：

- 如果 Web 服务器没有返回标头，我们可以向它们提供我们知道正在使用的 Web 服务器中配置的示例
- 如果我们发现一台服务器没有将日志推送到中心位置，并且我们知道中央日志服务器的位置和详细信息，我们可以提供有关如何设置的具体指南，或者至少在建议中提及这一点
- 如果我们知道一个团队使用某种静态代码分析工具，我们可以建议他们为这个软件制定一个自定义规则，以捕获他们代码中不良代码模式的实例。

其中一些非常容易转化为调查结果，并且对客户来说非常好，因为您不仅试图将建议与他们联系起来，而且还倾听并了解了他们的环境、工具和其他服务。

通用模板发现与为适应相关客户而略有更改的模板之间存在巨大的接收差异。这真的有很大的不同。

## 具体和可操作的建议

当谈到对客户的实际建议时，大多数人只想被告知该怎么做。在大多数情况下，这对我们来说通常很容易做到，我们应该在本节中尽可能具体和清晰。

是时候举几个例子了。

**弱密码策略**

假设我们围绕 Web 应用程序中存在的弱密码策略提出了一个问题，我们应该避免像这样含糊不清：

> 改进 Web 应用程序的密码策略，使其符合行业标准。

这是一个可悲的建议，要么会让客户摸不着头脑，不知道具体要更改什么或设置什么，还可能让他们尝试解决问题，但不是达到最佳标准。这可能会导致客户之间无休止的来回，因为他们试图正确解决问题，通常会让他们感到非常沮丧。让我们看一个更具体的建议：

> 应按以下方式调整密码策略：
>
> - 将最小密码长度从 6 增加到至少 12。
> - 添加对密码复杂性的要求，以下集中的字符：
>   - 小写
>   - 大写
>   - 数字
>   - 特殊字符
> - 所有管理员级别用户的最小密码长度都应更改为 16。
>
> 还可以考虑实现有限的密码复杂性，但使用更大的最小长度。例如，普通用户为 16，管理员用户为 24。已发现长度较长的密码明显更强。

在这里，我们为客户提供了具体的指导，以及可能更适合他们的替代方案。这对他们来说更具可操作性，并减少了他们需要花在研究补救措施上的时间（如果他们愿意的话），这样他们就可以根据需要立即解决问题。

**弱密码哈希算法**

另一个示例可能是您发现客户端正在使用 MD5 对用户密码进行哈希处理。这显然并不理想，因为数据库泄露将允许攻击者快速恢复用户密码的明文版本，以在应用程序中进行身份验证或尝试在其他站点上的电子邮件/用户名和密码组合。以下是一些模糊建议的示例：

> 实现包含功因子和盐的现代哈希算法。

虽然此示例给出了需要选择的哈希算法类型的一些指示，但它没有给出任何细节。此外，在没有任何指导的情况下立即提及盐和迭代将导致低于标准的实现。

这里有一些更具体、更全面的建议。

> 为用户使用更现代的哈希算法。按优先顺序，最推荐的哈希算法优先：
>
> - Argon2id
> - scrypt
> - bcrypt
> - PBKDF2
>
> 这些算法提供了可配置的工作成本，可用于使试图恢复任何恢复的密码哈希的任何明文版本的攻击者速度变慢。此外，每种算法都使用盐（通常是默认情况下），这也有助于在尝试恢复哈希的明文版本时减慢攻击者的努力。这是通过在哈希处理之前向每个密码添加唯一的数据来实现的。这可以防止攻击者简单地对猜测的密码进行哈希处理，然后检查所有哈希值以查看它是否匹配，他们必须生成盐 + 猜测的哈希值。加盐还可以防止攻击者创建“彩虹表”，即预先计算的明文密码哈希值。由于使用强大显卡的密码破解软件的进步，针对较弱算法的攻击者通常不需要这种方法。
>
> 除了改进密码哈希算法外，还可以实现“辣椒”，即在哈希之前在应用程序级别将其他数据添加到密码中。与盐不同，胡椒粉对于所有密码都是相同的，必须将其排除在数据库之外才能有效。在计算期间应包含 Pepper，并安全地存储在密码保管库或 HSM 中。这大大降低了如果攻击者只能访问数据库内容，则密码被恢复的风险。
>
> 鉴于实现这些算法并确保它们尽可能安全的复杂性，请遵循 OWASP 密码存储备忘单 （https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html） 中概述的指南。

在这里，我们已经从一个非常模糊的建议变成了涵盖客户应该调查的细节。虽然我在密码哈希方面确实有很多经验，但我仍然利用优秀的资源来构建我的发现并包括对源代码的引用。通过这种方式，我简要概述了客户在实施方面可以采取的潜在选项，并参考了 OWASP 指南，以便他们调查具体情况。

**代码审查问题 - SQL 注入示例**

假设我们在 Ruby on Rails 项目中发现了一个 SQL 注入漏洞，这是由于误用了影响旧版本 Ruby（版本 3 之前）的方法所致。在这种情况下，开发人员误解了sanitize_sql方法的使用。此方法用于清理单个条件或变量，而不是整个查询字符串。

这是它的样子：

```
class UsersController < ApplicationController
  def search_user
    user_input = params[:email]
    entire_query = "SELECT * FROM users WHERE email = '#{user_input}'"
    safe_query = ActiveRecord::Base.sanitize_sql(entire_query)
    @users = User.find_by_sql(safe_query)
    render json: @users
  end
end
```

如上所示，用户的输入与使用 Ruby 的格式字符串语法的查询相结合。然后，将整个查询传递到 sanitize_sql 方法中，在该方法中，它无法进行清理，并且不会返回任何更改。然后执行此恶意查询。

处理此处建议的最佳方法是提供一个固定代码片段的示例，该代码片段已根据所分析的内容进行了轻微的调整，或者可能是从编程语言或相关框架或库文档的可信来源获得的代码片段。

有时这并不容易避免（在小编码错误的情况下），但我们不应该修复所有客户端代码并将其发送回去。最好不要在文件级别提供完整且详尽的实现级别修补程序（除非与客户的协议要求这样做，尽管这种情况很少见）。这样做可能意味着，如果您将来要执行任何补救验证，您将“标记自己的作业”。此外，您可能希望避免因建议易受攻击或损坏的实现而承担责任。这通常只会在需要对代码库进行彻底更改并且小片段通常没问题的情况下才会出现。

因此，与其更正整个文件并将其发回，不如展示一个很好的示例，说明如何安全地使用该方法或可能可用的替代选项。

在这种情况下，鼓励客户端升级到最新版本的 Ruby on Rails，并解释如何使用 ActiveRecord 的内置功能来获取数据，该内置功能将对传入的参数进行清理（从 Ruby 版本 3 开始可用）。

显示如下所示的小片段就足够了：

```
@users = User.where(email: params[:email])
render json: @users
```

此代码片段充当代码修复可能是什么的缩小示例，而不是受影响文件的完整副本。

## 参考资料

我们将在即将到来的课程中更详细地讨论这一点，但我想我会在这里提到这一点，而且这样做感觉很自然。

有些建议可能会让开发人员或工程师稍微偏离他们的舒适区，并且他们可能不太了解您推荐的概念或建议。然而，即使是在一个简单的问题上，我们也不应该假设读者会理解我们在说什么，向读者指出一些额外的资源通常是有帮助的。正因为如此，在发现中有一个体面的参考更安全、更有帮助。

如果您通常不会在问题中添加参考文献，请在撰写您认为可能被误解或误解的发现时考虑一下 - 最好将读者链接到供应商文档、已知良好的博客文章或文章，或引用一些安全材料，例如 OWASP。这将为客户提供一个很好的进一步阅读来源，以提高他们对问题的理解，限制所需的跟进次数，并增加他们在第一次尝试时正确解决问题的机会。

如果您仍然不确定何时使用参考文献至关重要，那么一个好的迹象是您是否需要查找某些内容。尽管如前所述，为了安全起见，我建议在任何问题中参考。

您将看到，我已将引用直接添加到前面密码哈希示例的文本中。这些可以通过不同的方式呈现或插入，我们也将在后面的课程中介绍这些内容。不过，在这个例子中，我需要仔细检查我的知识在密码哈希方面是否仍然是最新的，并且考虑到使用最佳选项实现正确算法的潜在复杂性，我认为参考OWASP密码存储备忘单是明智的。

## 举例说明

在一些发现中，通过示例来演示修正更容易。这就像我们已经经历过的代码审查示例，但责任和“标记自己的作业”问题更少。

让我们看几个例子，一个是基于文本的证据，另一个是基于用户界面的。

**没有 HttpOnly 和安全标志的会话 Cookie**

我在很多情况下看到的一个经典例子是缺少HTTP cookie标志。显示缺少这些内容的典型方法是显示从服务器收到的响应。

下面是一个示例：

```
HTTP/1.1 200 OK
Date: Thu, 08 Feb 2024 12:00:00 GMT
Server: Apache/2.4.41 (Ubuntu)
Content-Type: text/html; charset=UTF-8
Content-Length: 1234
Connection: keep-alive
Keep-Alive: timeout=5, max=100
X-Powered-By: PHP/7.4.3
Set-Cookie: sessionId=REDACTED; Path=/
Cache-Control: no-cache, private
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
X-XSS-Protection: 1; mode=block
Strict-Transport-Security: max-age=31536000; includeSubDomains
SNIP
```

这里的关键线是：

```
Set-Cookie: sessionId= REDACTED; Path=/
```

在建议中，我们解释了设置 Secure 和 HttpOnly 标志，并展示了一个示例，说明如果正确修正，HTTP 响应中的 Set-Cookie 将是什么样子：

```
Set-Cookie: sessionId=abc123; Path=/; Secure; HttpOnly
```

如果还可以以某种方式突出显示 Secure 和 HttpOnly，这将使读者清楚地了解要修正的问题需要存在哪些内容（粗体、不同颜色或突出显示）。

让我们转到一个 UI 示例。

**已启用基于 TCP/IP 的 NetBIOS**

当 TCP/IP 上的 NetBIOS 处于活动状态时，它允许攻击者拦截网络内的广播请求。然后，这些攻击者可以通过响应这些请求来伪装成合法服务，从而可能诱骗网络设备与它们通信。在此通信过程中，设备可能会尝试对攻击者控制的服务进行身份验证，从而无意中发送凭据。此漏洞可被利用进一步破坏网络或伪装成受感染的计算机或用户执行操作。

若要解决此问题，客户端应禁用 TCP/IP 上的 NetBIOS。在建议中，我们应该解释进入正确菜单的步骤，并举例说明禁用的外观。虽然这是一个简单的例子，但如果客户正在努力进入正确的菜单，它可能会对客户有所帮助（请注意，我是如何在屏幕截图中显示大多数窗口的旅程的）。

在这里：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231949166.png)

对于大多数基于 UI 的问题，可以采用这种类型的方法，尽管在这种情况下，有时为客户提供其他选项会有所帮助，例如一个小脚本来解决问题（如果你已经彻底测试了它，并且你知道它有效）。这就像您可能会发现云配置存在问题，并且可以在 Web UI 中应用修复程序，也可以通过供应商提供的命令行工具应用。

------

接下来，让我们看看当我们认为需要指导客户检查发现的其他实例时，我们应该发表哪些评论。

# 24-建议 - 查找其他实例

这部分建议很容易涵盖。理想情况下，这只是一些一般性建议，如果适用的话，在其他地方寻找相同的问题。

在我们进入一些示例之前，重要的是要提到基于样本的测试。通过基于抽样的测试，我们被要求审查许多“事物”的少量内容。这些可能是 AWS 帐户、IP 地址范围、服务器构建等。这里的目标通常是通过审查更广泛遗产的代表性选择来全面了解安全性。我为什么要提到这个？好吧，每当我们执行基于样本的测试时，我们都应该假设还有其他“事情”没有被我们审查过，需要补救。这对某些客户来说可能是显而易见的，但根据经验，如果没有提示，此检查通常会被遗忘（完全错过了基于抽样的测试的重点）。

另一方面，即使我们不执行基于样本的评估，我们也应该鼓励客户审查他们的服务/代码/环境，以检查是否存在给定漏洞的更多实例。这既是因为我们可能无法检查它们，要么是因为它们处于更好的位置找到它们（由于评估的时间限制或进入其他地方）。

说到这里，让我们看几个例子。

**云配置评估问题**

假设您对 2 或 3 个云环境执行基于采样的审查，其中您发现了默认防火墙配置。你可能只是有一句话说（如果它是 Azure）：

> 查看其他 Azure 订阅，以检查此问题的进一步实例。

**代码审查问题**

如果你正在执行代码审查，并且你发现了一个危险的编程模式或使用了危险的方法，我们应该建议客户端检查他们可能拥有的其他代码库。以下是您可能会说的：

> 请考虑查看其他代码库，以检查此问题的进一步实例。

**Web 应用程序或 API 问题**

在执行 Web 应用程序评估时，如果发现其他应用程序中可能存在某些内容，您可能会说：

> 请考虑查看类似的应用程序是否存在此问题。

**基础设施评估**

如果您扫描了网络并发现了几个影响主机的问题，但您知道其他网络中可能还有更多问题，您可能会说：

> 请考虑扫描环境中的所有相关区域，以检查是否存在此问题。

正如你所看到的，这些句子写起来非常简单，实际上只是提示客户去检查问题的其他实例。对我们来说，检查问题的其他实例似乎是一件好事，但是，我从经验中知道这不会发生，因此我们应该尽最大努力将客户推向正确的方向。

这些评论非常适合基于样本的测试。但是，如果您没有执行基于样本的测试，但观察到其他区域、代码存储库、环境等可能存在此问题，则应写类似的句子 您可以随时询问您的客户是否有其他可能适用于给定发现的领域。

------

接下来，让我们看看预防性建议，以及它们如何帮助客户在发现再次出现时发现它们，或完全阻止它们。

# 25-建议 - 预防性建议

建议的这一部分有几个目的：

- 如果建议不平凡、昂贵或需要大量时间，您能为客户提供什么建议？您能推荐一种多阶段方法吗？
- 客户应该怎么做才能确保此发现不会再次出现？
- 如果问题再次出现，客户可以做些什么来确保他们发现问题？

我们在“推荐上下文”中介绍了第一点，测试人员应该仔细考虑某些发现的补救措施。这通常保留给修正可能需要较长时间的情况，或者应考虑多种选择。这一切都是为了权衡各种选择以及如何管理风险。

本节将重点介绍此列表中的后两点。在这里，我们希望确保客户在评估后继续前进，并且不会再次发现自己处于同样的情况。

让我们看一下前面的“查找其他实例”部分中的一些示例，其中包含一些更具体的信息：

**云配置评估问题**

假设此问题与禁用服务器端加密的 AWS SQS 队列有关。

> 今后，请确保定期扫描云环境，以识别任何禁用了服务器端加密的 SQS 队列（ScoutSuite 等工具可用于此目的）。此外，请考虑实施护栏以防止创建未加密的 SQS 队列。这可以使用 AWS Identify and Access Management （IAM） 策略或服务控制策略 （SCP） 来实现。

通过建立设置强默认值的策略，或定期运行工具来检测有问题的实例，可以避免许多云问题。在这里，我们向客户推荐了这两种产品。

**代码审查问题**

假设我们发现开发人员使用了一种危险的 React 框架方法，这可能会导致跨站点脚本。以下是我们如何建议他们将来停止在生产代码中使用它：

> 开发人员应该利用代码 linter 来确保在提交代码之前发现 React 方法（包括 'dangerouslySetInnerHTML'）的危险用法。此外，在合并到生产代码之前，应执行自动化测试，这应该包括基本的静态代码分析。除了自动控制之外，还应制定安全编码指南，以强调使用“dangerouslySetInnerHTML”以及框架支持的任何其他已知危险方法的危险。

在这里，我提供了三种方法来限制此问题再次出现的可能性：

- 让开发人员在将代码提交到源代码管理系统之前发现危险实例
- 自动扫描开发管道中的易受攻击或危险代码，以防止其进入生产环境
- 要求客户考虑制作一个安全的编码标准文档，以告知开发人员 React 框架的危险区域

**Web 应用程序或 API 问题**

对于下一个示例，让我们考虑一个场景，其中我们发现了一个返回所有对象数据的 API 端点，包括前端应用程序不需要的字段，例如用户的密码哈希。从预防性修复的角度来看，我们可能要说以下几点：

> 确保所有未来 API 端点的实现都经过同行评审，以确保仅将所请求对象的所需数据发送到客户端。请考虑使用自定义静态分析规则或作为代码审查过程的一部分来阻止任何返回整个对象而不是指定必填字段的代码。添加或创建安全编码标准，以警告开发人员将整个对象返回给客户端的危险。

请注意，这与代码审查问题有相似之处，并提供静态分析方法和安全编码指南作为此问题的预防性解决方案。在这里，我还提到了代码的同行评审，因为这些发现可能会被一些静态分析工具遗漏，而在某些编码框架中很难发现。

**基础设施评估**

假设我们执行了基础架构评估，并发现了许多在环境中的 Linux 主机上运行的 telnet 实例。以下是我们可能的建议：

> 确保在网络内执行漏洞扫描，以发现正在运行的任何 telnet 实例，以便对其进行修正。此外，请考虑更新金牌版本或配置管理，以确保环境中的新主机和现有主机上不存在 telnet 服务器。

为了完全阻止此问题出现，网络管理员可以修改任何黄金版本或服务器配置管理。但是，鉴于在网络上创建配置仍然很容易，因此必须强调应定期执行漏洞扫描。

您会注意到，建议的这些部分可以用通用方式编写，这非常适合模板化。如果您决定对这些模板进行模板化，请始终记住，如果可以的话，应该阅读和自定义它们。由于预防性建议可能与组织或平台范围的政策、程序和实施有关，因此应抓住任何机会为特定客户定制建议的这些部分。

------

接下来，让我们看一些例子，说明如何把我们所经历的一切放在一起来写一个建议。

# 26-建议 - 示例

现在，让我们以我们在这里介绍的内容为例，看看为我们在描述课程中涵盖的问题编写建议部分。

## 可公开访问的 S3 存储桶

让我们回顾一下问题的描述：

> **描述**
>
> 发现了一个可公开访问的 S3 存储桶。Internet 上任何能够猜出存储桶名称的用户都可以访问和下载 S3 存储桶中的所有文件。该存储桶包含所有员工的工资单信息，以及最近的渗透测试报告的结果，其中包含几个未修补的外部漏洞。利用这些信息，攻击者可以尝试通过利用上述外部漏洞或根据工资单信息的内容对用户进行网络钓鱼和密码猜测攻击来访问互联网。如果攻击者得逞，无论是获得对生产网络的访问权限还是破坏用户的访问权限，内部网络上的敏感客户信息都可能面临泄露的风险。
>
> aws 命令行工具的以下命令输出显示了存储在存储桶中的文件。
>
> ```
> $ aws s3 ls s3://omnicorp-private-files
> 2024-01-28 12:35:29      1024 confidential_report.pdf
> 2024-01-29 08:15:47      2048 employee_data.xlsx
> ```
>
> 这两个文件都可以下载和检查：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231950809.png)
>
> confidential_report.pdf内容
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231950124.png)
>
> employee_data.xlsx内容
>
> 机密报告包含以下可外部利用的漏洞列表，所有这些漏洞都在此评估期间存在：
>
> - 使用可猜测凭据向 Internet 公开的 RDP
> - 使用匿名绑定向 Internet 公开的 LDAP
> - 暴露的 Apache Tomcat 过时且易受攻击
>
> 获取此文档访问权限的攻击者将能够立即确认这些问题的可利用性，因为它们都是面向 Internet 的，并且可能能够透视到内部网络。
>
> 工资单电子表格不仅显示了所有员工的当前工资和奖金，而且还泄露了大量可用于欺诈目的的信息，以及对 OmniCorp 进行其他攻击（例如密码猜测攻击或网络钓鱼）。电子表格中包含以下敏感信息：
>
> - 名字和姓氏
> - 工资
> - 家庭住址
> - 个人电子邮件地址
> - 个人电话号码

我们已经在本课中谈到了基于云的问题，因此其中一些看起来非常熟悉。

以下是您可以编写的内容作为本节的建议：

> **建议**
>
> 重新配置 S3 存储桶以禁用公有访问。
>
> 这可以从管理控制台执行：
>
> 1. 转到 Amazon S3 控制面板。
> 2. 单击存储桶名称 omnicorp-private-files。
> 3. 转到“权限”选项卡。
> 4. 单击 Block public access （bucket settings） （阻止公有访问（存储桶设置）。
> 5. 选中所有复选框以阻止新的公共 ACL 并删除现有的公共访问。
> 6. 点击保存。
>
> 或使用 AWS cli 工具：
>
> ```
> aws s3api put-public-access-block --bucket omnicorp-private-files --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
> ```
>
> 鉴于两个公开文件中都存在高度敏感的数据，应查看与存储桶相关的任何访问日志。
>
> 对云环境执行定期扫描，以发现将来可公开访问的 S3 存储桶（可以利用 ScoutSuite 等工具）。此外，请考虑实施护栏以防止创建不安全的 S3 存储桶（例如可公开访问、不加密等）。这可以使用 AWS Identity and Access Management （IAM） 策略或服务控制策略 （SCP） 来实现。

首先，我们介绍了客户端需要做什么来解决这个问题，这只是更正存储桶权限。为此，UI 和 CLI 选项都已提供。客户要考虑的另一件事是了解这些文件之前是否被访问过，如果是这种情况，他们可能需要采取进一步的步骤。因此，我建议对日志进行调查。

最后，我们提供一些建议，以确保这种情况不会再次发生，如果发生这种情况，我们建议采取发现方法。这以策略更改和使用安全工具扫描 AWS 账户的形式出现。

## Linux 服务器上的弱密码策略

让我们提醒自己发现描述：

> **描述**
>
> 环境中 Linux 服务器上的帐户配置了用户名和密码组合。内部网络上的攻击者可能会使用基本的用户名和密码猜测攻击来获得访问权限。虽然受影响的用户是管理员，这将导致主机完全受损，但主机未被使用，并且不包含对攻击者有用的数据或凭据材料。环境中没有其他主机受此问题的影响。
>
> 成功登录受影响的 Linux 服务器如下所示：
>
> ```
> $ ssh admin@192.168.1.122.com
> admin@192.168.1.122.com's password: password
> Welcome to 192.168.1.122.com!
> Last login: Sun Jan 29 09:00:01 2024 from 192.168.1.122
> admin@192.168.1.122:~$
> ```

同样，这个问题可以用与我们在本课中已经介绍过的例子类似的方法来解决。让我们看看它可能是什么样子：

> **建议**
>
> 如果主机未使用，请停用。
>
> 如果主机有计划，则可以通过利用 libpam-pwquality 软件包来增加密码策略。以下是为此涉及的步骤（请注意，需要进行测试以确保这在所有系统上都有效）：
>
> 安装软件包：
>
> ```
> sudo apt-get update
> sudo apt-get install libpam-pwquality
> ```
>
> 编辑 /etc/pam.d/common-password 文件并编辑以下行：
>
> ```
> password        requisite                       pam_pwquality.so retry=3 minlen=16 dcredit=-1 ucredit=-1 lcredit=-1 ocredit=-1
> ```
>
> The example above enforces the following password complexity:
>
> - minlen=16: Minimum password length.
> - dcredit=-1: Require at least one digit.
> - ucredit=-1: Require at least one uppercase letter.
> - lcredit=-1: Require at least one lowercase letter.
> - ocredit=-1: Require at least one special character.
>
> 要确保 SSH 服务器正在使用此 PAM 模块，请编辑 /etc/ssh/sshd_config 并确保将 UsePam 设置为 Yes。可能需要重新启动 SSH 服务器才能生效。
>
> 如果正在使用金牌版本，或者更广泛的环境处于配置管理之下，请考虑查看密码策略集并按照上述准则增加密码策略集。密码策略的实现可能因 Linux 发行版和其他操作系统而异。虽然此方法可能有助于保护本地帐户，但对于环境中的任何中央身份验证提供商（例如 LDAP 服务），请考虑查看密码策略以确保其符合上述建议。

在这里，我们首先简单地说明，如果不需要主机（团队说它没有使用），最简单的补救措施是从网络中删除盒子。这是他们需要保护的服务器。

如果确实需要保留，则给出了如何在服务器上应用所需强化的示例。关于测试这是否适用于所有服务器的需要，给出了一个适当的警告。此外，环境中的身份验证可能并不总是特定主机的本地身份验证（中央身份验证系统要好得多），因此这只是一个示例。

在预防性建议方面，我们已经提到他们应该更新他们的黄金服务器版本或任何配置管理系统，以确保主机得到适当的强化。此外，如果环境中的其他位置正在使用中央身份验证系统，则应检查它是否具有合适的密码策略集。

## Windows Server 漏洞，由于多个缺失修补程序（包括关键 MS17-010）而导致

以下是描述的提醒：

> **描述**
>
> MS17-010 漏洞会影响 Windows Server 消息块协议（1.0 版），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。
>
> 鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。但是，由于这会影响 Windows 域控制器，因此可以访问所有用户的所有凭据材料（以哈希或加密格式）。
>
> 由于这是整个环境的域控制器，并且是环境中通过 LDAP 提供身份验证的主要服务，因此入侵将影响生产域中所有连接的服务器和服务。
>
> Nessus 的以下结果显示了这一发现：
>
> ```
> Nessus Scan Report:
> Host: 192.168.1.10
> OS: Windows Server 2019
> Vulnerability: MS17-010 - Critical
> Description: Security Update for Microsoft Windows SMB Server (4013389)
> Severity: Critical
> ```
>
> 虽然服务器在评估期间未被利用，但使用了 Metasploit 来确认服务器是否可能易受攻击：
>
> ```
> [*] 192.168.1.100:445   - Scanning for vulnerabilities...
> [*] 192.168.1.100:445   - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 (64-bit)
> [*] Scanned 1 of 1 hosts (100% complete)
> [*] Auxiliary module execution completed
> ```

此问题的补救措施是更新主机和禁用 SMB 版本 1 的组合。让我们来看看这个：

> **建议**
>
> 修复此漏洞的最简单方法是使用 Windows 更新更新主机。如果使用补丁，还可以使用 WSUS 或 SCCM 在整个网络中推出。有关此漏洞的更多详细信息，请参阅 https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010
>
> 如果无法修补漏洞，缓解措施可能是禁用 SMB 版本 1 - 这是因为 MS17-010 仅在 SMB 服务运行版本 1 时才会影响它。但是，应该注意的是，禁用 SMB 版本 1 也应作为完全修正此问题的一部分执行，因为它的使用存在许多漏洞。有关详细信息，请参阅“正在使用的 SMB 版本 1”结果。
>
> 查看网络中不在此评估范围内的任何区域，以查看是否存在此漏洞。
>
> 展望未来，确保在整个网络中执行漏洞扫描，以便及时发现和修复关键问题。查看环境的修补过程和过程，以确保及时修补关键漏洞。

首先，我们介绍了主要建议，即确保主机得到更新。如果由于某种原因这不简单，我们建议禁用 SMB 版本 1。关于缓解措施，您可能可以在这里写更多内容，但我宁愿将重点更多地放在解决问题上，而不是提及多种解决方法。正因为如此，我指出了如何禁用 SMB 版本 1 作为此问题补救措施的一部分（我在虚构报告的其他地方提出了这个问题，以涵盖此版本的 SMB 协议的使用）。

鉴于漏洞的性质，以及客户端明显糟糕的修补过程，我建议他们在网络的其他地方寻找这个问题。

最后，我们提到了漏洞扫描的要求，以便在网络上出现未修补的主机时可以再次发现问题，以及查看环境修补策略的建议。MS17-010 现在不应该真正出现在环境中。

## 不带身份验证的 API 端点

让我们再次回顾一下描述：

> **描述**
>
> 发现了一个 API 端点，该端点返回了平台上所有用户的数据，并且无需身份验证即可访问。如果攻击者发现端点，则返回的数据将能够用于目标平台用户。这可能以密码猜测攻击、网络钓鱼或在其他 API 调用中利用其用户 ID 的形式出现。这些攻击不仅可能导致访问用户的敏感信息，而且这些信息的泄露可能会构成具有GDPR影响的隐私泄露。任何以经过身份验证的用户身份检查流量的攻击者都可能发现此漏洞，这意味着它更有可能被系统用户发现，而不是被外部攻击者随机发现。
>
> 在评估期间，观察到以下 API 调用，该调用检索到的信息随后将放置在用户的个人资料页面上：
>
> **请求**
>
> ```
> GET /api/user/profile/1 HTTP/1.1
> Host: example.com
> Authorization: Bearer REDACTED
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: application/json
> Content-Length: 150
> {"id": "1", "name": "John REDACTED", "email": "REDACTED"}
> ```
>
> 根据 REST 命名方案的构造方式，不带标识符后缀的 URL 通常会返回与对象类型（在本例中为配置文件）关联的所有对象。如下图所示，这返回了所有用户的数据：
>
> **请求**
>
> ```
> GET /api/users/profile HTTP/1.1
> Host: example.com
> Authorization: Bearer REDACTED
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: application/json
> Content-Length: 150
> {"users": [{"id": "1", "name": "John REDACTED", "email": "REDACTED"}, {"id": "2", "name": "Jane REDACTED", "email": "REDACTED}]}
> ```
>
> 虽然这本身就是一个重大问题，但执行了另一项检查，以查看终结点是否无需身份验证即可使用。这是通过删除请求中发送的 API 令牌来实现的，并且仍然返回来自服务器的响应，表明不需要身份验证：
>
> **请求**
>
> ```
> GET /api/users/profile HTTP/1.1
> Host: example.com
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: application/json
> Content-Length: 150
> {"users": [{"id": "1", "name": "John REDACTED", "email": "REDACTED"}, {"id": "2", "name": "Jane REDACTED", "email": "REDACTED"}]}
> ```

此 Web 应用程序问题将涉及我们在其他地方介绍的一些主题。让我们看看如何解决这个问题：

> **建议**
>
> 查看解决方案中的 /api/users/profile 终结点及其用例。如果不需要服务器返回所有用户，则应将其从应用程序中删除。如果平台的管理员用户需要它，则应围绕端点进行适当的身份验证和访问控制，以便只有管理员用户才能从此端点检索数据。
>
> 查看所有 API 端点，以确保返回或修改的数据只有在用户登录或经过身份验证后才能访问的任何端点。同样，请查看 API 端点以确认是否设置了返回所有对象的任何端点，因为代码库中的其他地方可能存在类似的疏忽。
>
> 确保在允许将代码合并到生产代码之前执行的代码审查过程经过仔细审查，特别是围绕引入新终结点或修改现有终结点。请考虑创建动态测试，以检查对不应具有的 API 端点的匿名访问，以及检查返回所有不应配置的对象的 API 端点。最后，考虑针对代码库运行任何适用的静态分析工具。一些特定于框架的工具可能能够突出显示这些问题。

在这里，我们指出这样一个事实，即可能不需要这种泄露所有用户信息的 API 方法，如果不是，则应将其删除。如果需要（并且唯一的逻辑原因可能是管理员用户），则终结点应仅限于管理员用户，并且需要身份验证。

鉴于这些问题通常很难从代码角度（取决于实现或框架）发现，建议客户端在此处查找这两个问题的其他实例是有意义的：缺少身份验证，以及返回特定类型资源的整个对象。

最后，突出显示了代码审查过程，以建议将来在实现新终结点时执行仔细审查。此外，还要为终结点编写测试，以检查经过身份验证的终结点是否意外变为匿名，以及检查不应返回所有内容的终结点是否不返回。最后，我提到静态分析。措辞有点凹陷，因为这可能是扫描仪发现的一个非常微妙的错误，但使用一些工具是可能的。

## 在论坛软件上存储跨站点脚本

最后一个例子！让我们回顾一下调查结果说明：

> **描述**
>
> OmniCorp 用于协助客户支持请求的论坛软件容易受到存储的跨站点脚本的影响。此漏洞影响了论坛帖子页面上的评论部分，任何恶意注入的代码都会对访问受影响页面的任何用户运行。攻击者可以利用此漏洞破坏用户论坛会话（包括论坛版主或管理员），甚至提供虚假的登录表单，试图窃取用户的生产凭据。如果获取了用户凭据，则可能导致攻击者获得对敏感用户数据的访问权限。此漏洞的攻击复杂度非常低，因为没有防御性编码，使攻击者更容易利用;唯一的要求是用户访问受影响的论坛帖子。虽然只有该平台的用户可以利用这个问题，但鉴于互联网上的任何人都可以自行注册和使用该平台，这是没有意义的。虽然在托管论坛的 Web 服务器上安装了 Web 应用程序防火墙，但它当前并未运行。但是，即使启用了此问题，它也可能无法阻止所有利用此问题的尝试。
>
> 存储的跨站点脚本是一种漏洞，Web 应用程序未对不受信任的输入执行足够的输入验证或清理，或者未对值执行足够的输出编码。其结果是，应用程序（在数据库、日志或其他系统中）提交并随后存储的恶意信息随后被反映并合并到生成的网页中。在跨站点脚本的情况下，JavaScript 被发送到服务器、存储并返回到用户的浏览器，并执行以执行各种恶意操作。
>
> 利用跨站点脚本漏洞存在一系列可能性，其中一些包括：
>
> - 在浏览器会话中运行加密矿工
> - 尝试窃取经过身份验证的页面上特定于用户的会话令牌或内容
> - 注入虚假表格供用户填写，以试图窃取信息（例如，用于收集凭据的登录表格）
> - 在用户不知情的情况下在用户上下文中执行操作（例如，将恶意内容发布到论坛）
> - 显示恶意内容
>
> 鉴于利用此漏洞的方式多种多样，此问题会严重影响任何处理敏感数据的应用程序，因为它更有可能被盗、修改或删除。
>
> 以下 HTTP 请求和响应显示了 OmniCorp 论坛应用程序软件接受的基本 JavaScript 的注入。
>
> **请求**
>
> ```
> POST /forum/post/1/comment HTTP/1.1
> Host: forum.example.com
> Content-Type: application/x-www-form-urlencoded
> Content-Length: 68
> Cookie: sessionid=REDACTED
> 
> 
> postId=42&comment=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: text/html; charset=UTF-8
> Content-Length: 256
> ```
>
> 以下 HTTP 请求和响应显示服务器作为可在用户浏览器会话中运行的可执行 JavaScript 返回的有效负载。
>
> **请求**
>
> ```
> GET /forum/post/1/comments HTTP/1.1
> Host: forum.example.com
> Content-Type: application/x-www-form-urlencoded
> Content-Length: 68
> Cookie: sessionid=REDACTED
> ```
>
> **响应**
>
> ```
> HTTP/1.1 200 OK
> Content-Type: text/html; charset=UTF-8
> Content-Length: 256
> 
> 
> <html>
> <body>
>   <div id="content">
>     <div class="comment">User posted: <script>alert('XSS')</script></div>
>   </div>
> </body>
> </html>
> ```
>
> 下图显示了正在执行的有效负载：
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231949643.png)
>
> 正在执行的 Omnicorp 存储的跨站点脚本
>
> 创建概念验证 JavaScript 有效负载以生成以下 OmniCorp 登录表单。这将显示在请求的论坛帖子的顶部，以提示输入用户的凭据。提交后，用户的凭据将被发送到攻击者控制的服务器，然后帖子将变得可见。
>
> ![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231949127.png)
>
> 假 OmniCorp 登录屏幕
>
> 
>
> 可以在附录第 5.2 节中找到虚假登录概念证明 HTML 和 JavaScript 有效负载的完整副本，以及使用的 HTTP 请求和响应。

另一个 Web 应用程序问题，此处的方法将与上一个问题有相似之处。以下是您可以编写的内容作为本节的建议：

> **建议**
>
> 防止跨站点脚本需要多种方法来确保应用程序保持安全：
>
> - 不受信任数据的服务器端验证
> - 用户提供数据的输出编码
>
> 应验证发送到服务器的所有数据，以确保它不包含意外类型，并且内容是预期的。当服务器需要自由范围的文本时，对这些数据进行验证可能更具挑战性。在这些情况下，可以在将特定字符存储在数据库中之前对其进行 HTML 编码。这将确保在客户端请求时以编码格式返回它们。
>
> 在为客户端构建页面时，必须确保返回的所有变量都经过适当的编码。许多现代前端框架将自动执行编码，但在使用应用程序外部任何资源中的值时仍应小心，即使它应被视为受信任的。
>
> 使用编码对应项进行编码的关键值包括：
>
> | 字符 | 编码版本 |
> | ---- | -------- |
> | &    | &        |
> | <    | <        |
> | >    | >        |
> | "    | “        |
> | '    | &#x27;   |
>
> 如果服务器返回包含 HTML 的内容，则可以使用 DOMPurify 来剥离潜在的恶意内容，并且只允许安全的 HTML 标记和属性。如果使用，此库必须保持最新状态。
>
> 对于此应用程序，服务器返回的注释至少应是 HTML，这将导致以下响应：
>
> ```
> <html>
> <body>
>   <div id="content">
>     <div class="comment">User posted: &lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;</div>
>   </div>
> </body>
> </html>
> ```
>
> 如果使用 DOMPurify，恶意脚本标记也将被删除。
>
> 有关跨站点脚本防护和 DOMPurify 使用的更多信息，请访问 OWASP 网站 （https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html）。此外，可以应用 Web 服务器强化，使攻击者更难通过 Content-Security-Policy 标头 （https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html） 利用跨站点脚本 - 请注意，这不会解决任何潜在问题，应始终实施完整修复。
>
> 查看 Web 应用程序代码的其余部分，以检查是否在其他地方使用了类似的编码模式，这可能会导致跨站点脚本编写。
>
> 开发人员应在提交代码之前利用代码 linter 来发现潜在的危险编码模式和函数用法。此外，在合并到生产代码之前，应执行自动化测试，这应该包括基本的静态分析安全测试。除了自动控制之外，如果尚未创建安全编码指南，则应制定突出框架支持的危险方法的安全编码指南。如果当前工具无法找到该漏洞，请调查是否可以编写自定义规则来发现有问题的 Code Pattern 的未来实例，或者查找可能能够发现该漏洞的其他工具。

这是一个相当大的建议，如果您必须自己编写，您应该查看模板;你不想一遍又一遍地写这个！

首先，我们谈到了修复跨站点脚本所需的方法。在非常简短的概述之后，我们给出了一个固定版本可能是什么样子的示例。参考文献在这里至关重要，因为这对开发人员来说可能很复杂（取决于他们的前端和后端框架是用什么编码的），所以建议让他们阅读关于解决此类问题的更全面的指南，但确保我们触及基础知识很重要。

像往常一样，我们建议他们查看他们的代码库，寻找可能导致跨站点脚本的类似编码模式（你永远不知道你是否遗漏了什么）。

最后，我们介绍了他们可以做些什么来阻止这些问题再次出现。鉴于这不是代码审查，我们对底层实现的了解有限。因此，我们只能提供高层次的指导。这主要包括我们以前经历过的建议，但更笼统。

------

接下来，让我们以一些注意事项结束建议课程，并对我们所涵盖的内容进行最终总结。

# 27-建议 - 注意事项和摘要

在为某些部分编写内容时，我想提出几件事以供考虑。现在让我们来看看这些。

## “查找其他实例”建议的适用性

有时这些评论根本不适用。这些将适用于以下情况：

- 只有“事物”的一个实例被发现：
  - 唯一系统的单个设置配置错误
  - Web 应用程序、服务、代码库、网络或环境中缺少的单个功能或特性
- 您以非常高的置信度发现了给定问题的所有实例
  - 您可以访问给定评估类型的所有实例（外部基础结构、内部基础结构、代码库、云环境等）

就我个人而言，只有当我确定它们不可能存在于其他地方时，我才会避免使用这些评论。这通常意味着它们出现在我对大型组织进行评估的调查结果中，很明显我们没有评估所有内容。这要么是因为我们受到范围的限制，要么是因为与我们合作的客户团队不知道其他团队管理的领域是否可能存在相同的问题。

## 系统性发现和“寻找其他实例”

可能会出现以下情况：您发现整个环境、应用程序、服务或代码库中都存在问题，并且无法找到或确认每个实例。

示例可能包括：

- 利用大型 Web 应用程序上的 SQL 注入漏洞并非易事
- 在代码审查中使用危险的编程方法，偶尔会导致存在漏洞

在这些情况下，您应该始终包含一两句话，以确保客户执行自己的调查以检查其他实例。

# 总结

这是一个很长的教训，通过许多例子涵盖了建议的关键领域。以下是这些课程中的一些要点：

- 理想情况下，建议应包含三个关键领域：
  - 有关如何修复已找到的内容的信息
  - 检查结果的其他实例（如适用）的指示
  - 建议客户帮助他们再次发现发现，或防止它再次出现
- 我们的建议应该具体，而不是含糊不清——它们应该尽可能清晰和可操作
  - 此列表应包括所需的示例和参考资料
- 参考有用的材料，但不要用太多的参考资料让客户不知所措
- 考虑一些更具挑战性的建议所涉及的复杂性和工作量，但不要犹豫，首先推荐最佳方法
- 通过使用已知的上下文和有关客户的信息，向客户量身定制建议;这种方法通常受到极大的赞赏

我们将在即将到来的练习中将这里学到的知识付诸实践。

# 28-建议 - 练习

在上一课中，我们介绍了如何编写建议部分。

让我们通过这些练习将我们学到的知识付诸实践。

**反思练习**

反思您撰写或有权访问的报告。查看每个调查结果的建议部分，并：

- 改进建议，使其不那么模糊，对客户更具可操作性
- 在措辞上努力建议客户在其他地方寻找问题的其他实例
- 在调查结果中增加预防性建议

**一般练习**

为所有 OmniCorp 分会练习问题创建建议部分。确保您涵盖：

- 具体的修复信息 - 如果您不确定，请研究您可能需要在本节中编写的内容
- 如果适用，建议客户端在其他地方寻找其他实例。如果不适用，请记下原因
- 提供预防性建议，以防止问题再次出现，或者在问题再次出现时发现问题

**超越练习**

- 为不同类型的问题创建模板，这些模板可能在建议部分包含“查找其他实例”的措辞
- 为预防性建议创建模板，这些模板可以放入调查结果中

# 29-位置或区域

我们现在已经涵盖了如何编写安全发现的大部分核心部分，只剩下几个领域需要涵盖。让我们通过描述发现的“位置”或“区域”部分来进入本章的最后一课。

“位置”或“区域”是一个部分，通常位于调查结果的末尾，概述了发现问题的位置。这一部分对客户很有用，可以确定他们需要在哪些方面应用建议部分中概述的内容，也适用于可能需要执行补救验证工作的同事。

这些部分中的信息可以通过不同的方式捕获，但最常以列表或表格格式呈现。就我个人而言，我觉得发现的大部分信息应该已经涵盖，因此文档的这一领域不需要任何解释或其他信息。

这里有一些可以捕获的示例，让我们来看看常见的示例。

## 网址

如果已执行 Web 应用程序测试，或者已通过 Web 界面对应用程序执行配置评审，则可能需要指定发现给定问题的位置。

下面是执行具有多个匿名 API 终结点的 Web API 评估时可能会看到的 URL 列表示例：

- https://api.example.com/v1/users/list
- https://api.example.com/v1/payments/details
- https://api.example.com/v1/support/tickets

如果您引用的页面包含一些配置错误的应用程序安全信息，则可能会看到以下内容：

> https://admin.example.com/settings/security

请注意，我没有对单个列表项进行项目符号点。根据您自己的内部指南，当问题本身很明显时，可能不需要在此处设置单个项目。但是，我宁愿与我的其他发现保持一致，并使用相同的部分。选择权在您手中。

在某些情况下，您可能需要详细说明参数或其他信息。下面是 Web 应用程序 URL、HTTP VERB 和 SQL 注入受影响参数的列表示例：

| **网址**                         | **HTTP方法** | **受影响的参数**         |
| -------------------------------- | ------------ | ------------------------ |
| https://www.example.com/login    | POST         | 用户名、密码             |
| https://www.example.com/search   | GET          | 查询                     |
| https://www.example.com/register | POST         | 电子邮件、user_name      |
| https://www.example.com/update   | PUT          | user_id，account_details |
| https://www.example.com/delete   | DELETE       | user_id                  |

我在这个例子中使用了一个表格，因为它看起来稍微干净一些。

## IP 地址/主机名/端口

如果您正在执行任何基础结构类型的工作，通常需要提供有关您在哪里看到某些内容的信息。

下面介绍了如何列出多个运行 telnet 的主机，包括端口和主机名（您可以在其中解析它）。

 

| **IP** **地址** | **端口** | **主机名**           |
| --------------- | -------- | -------------------- |
| 192.168.1.50    | 23       | server1.example.com  |
| 192.168.1.51    | 23       | server2.example.com  |
| 10.10.10.5      | 2323     | telnet.example.com   |
| 10.10.10.6      | 2323     | telnet2.example.com  |
| 172.16.0.4      | 23       | internal.example.com |

如果我们能够获取环境中服务器的主机名，我们应该在报告中使用它们。许多组织将具有主机名的命名约定，或者能够根据主机名识别它们的作用。这通常使客户端能够更容易地弄清楚服务器可能在哪里以及哪些团队运行它们，从而实现更有效的补救过程。

如果所有受影响的主机都具有相同的服务和端口易受攻击，则端口号可能是可选的。如果同一服务在许多端口上的多个主机上运行，则可能需要这样做。这里的一个典型示例是配置错误的 SSL/TLS 服务。

下面是正在使用的过时 SSL/TLS 版本的示例：

| **IP地址**    | **端口**        | **主机名**          |
| ------------- | --------------- | ------------------- |
| 203.0.113.5   | 443, 8443       | secure.example.com  |
| 198.51.100.23 | 443, 8443, 8080 | admin.example.com   |
| 203.0.113.6   | 443             | payment.example.com |
| 192.0.2.17    | 443, 8443       | www.example.com     |

您还可以提供有关每个端口使用的版本的详细信息，但这可能会使表变得混乱。如果您有大量主机，则始终可以在补充文件中向客户端提供此附加信息。或者，您可以将 IP 信息分布在多行中：

| **IP地址**    | **端口** | **主机名**          | **SSL/TLS 版本** |
| ------------- | -------- | ------------------- | ---------------- |
| 203.0.113.5   | 443      | secure.example.com  | 红绿灯 1.2       |
| 203.0.113.5   | 8443     | secure.example.com  | TLS 1.1          |
| 198.51.100.23 | 443      | admin.example.com   | 红绿灯 1.2       |
| 198.51.100.23 | 8443     | admin.example.com   | SSL证书 3        |
| 198.51.100.23 | 8080     | admin.example.com   | TLS 1.0          |
| 203.0.113.6   | 443      | payment.example.com | 红绿灯 1.2       |
| 192.0.2.17    | 443      | www.example.com     | 红绿灯 1.2       |
| 192.0.2.17    | 8443     | www.example.com     | TLS 1.1          |

如果要进行外部测试，则不太可能获得 DNS 信息，在这种情况下，可能只需要一个 IP 地址，尤其是对于影响多个实例中同一端口的问题。下面列出了涉及 RDP 向 Internet 公开的问题：

- 203.0.113.7
- 203.0.113.8
- 198.51.100.25
- 198.51.100.26
- 192.0.2.18

## 文件路径和行号

如果已执行代码评审评估，甚至已对其他一些基于文本的文件进行评审，则可能需要将客户端引用到文件的多个区域。

引用这些区域的最简单方法是通过文件路径和行号。此格式可以有所不同：

- path/to/file.txt（第 25 行）
- path/to/file_2.txt（第 25,203 行）

或者（我最喜欢的）

- 路径/到/file.txt：25
- 路径/至/file_2.txt：25,203

让我们看一下 Java 代码库中的一些示例，在这些示例中，我们发现了不安全的随机数生成实例：

- src/main/java/com/example/security/RandomGenerator.java：45
- src/main/java/com/example/user/SessionIdentifier.java：30
- src/main/java/com/example/util/UtilityFunctions.java：112,250

显然，这假设客户端的代码将与您审查的版本匹配，但根据调查结果中的信息，这应该足以让他们知道在哪里查找问题。如果您觉得可能需要其他信息（例如，调用函数名称），可以这样做：

- src/main/java/com/example/security/RandomGenerator.java：45 - 生成 SessionId
- src/main/java/com/example/user/SessionIdentifier.java：30 - 创建用户会话
- src/main/java/com/example/util/UtilityFunctions.java：112 - 随机折扣生成器
- src/main/java/com/example/util/UtilityFunctions.java：250 - 生成随机数

## 其他文档类型

在审查其他文件（例如审查政策文件）的情况下，指导客户的最佳方式可能是按章节编号（如果存在）：

- 部分 2.3.. 密码管理策略
- 部分 4.1.5.. 数据加密标准
- 第 5.2 节：事件响应程序

或通过章节标题导航：

- 密码管理策略
- 数据加密标准
- 事件响应程序

## 云问题

执行云评估时，请务必根据特定资源所在的订阅 （Azure）、帐户 （AWS） 或项目 （GCP） 突出显示特定资源（其他供应商有自己的条款）。除此之外，还应包括受影响资源的名称和任何 ID 值。最好作为桌子来提供。区域信息在这里也很有帮助，因为云提供商的工具通常一次只检查一个区域，在这些服务的 UI 中肯定是这种情况。

让我们看一下各种云提供商的一些示例：

**AWS 示例**

| **账户 ID**  | **地区**   | **资源名称** | **资源 ID**       |
| ------------ | ---------- | ------------ | ----------------- |
| 123456789012 | 美国东-1   | 生产数据库-1 | DB-ABCDEFG1234567 |
| 987654321098 | 欧盟西部-1 | 开发数据库-2 | db-HIJKLMN8901234 |
| 564738291012 | AP-南-1    | 测试数据库-3 | db-OPQRST5678901  |

**Azure 示例**

| **订阅 ID**                          | **资源组** | **资源名称**       |
| ------------------------------------ | ---------- | ------------------ |
| ABCD1234-AB12-CD34-EF56-ABCDEF123456 | 生产资源   | prodstorageaccount |
| EFGH5678-EF12-GH34-IJ56-GHIJKL789012 | 开发资源   | devstorageaccount  |
| IJKL9012-IJ34-KL56-MN78-IJKLMN123456 | 测试资源   | teststorageaccount |

**GCP 示例**

| **项目 ID**     | **位置**  | **资源名称** |
| --------------- | --------- | ------------ |
| my-gcp-项目     | 美国中部  | 公共桶-123   |
| 另一个-GCP-proj | 欧洲-西部 | 私有桶-456   |
| 测试-GCP-项目   | 亚洲-东区 | 存档桶-789   |

提供所有这些信息将确保客户确切地知道在哪里查找修复结果，并且将来审查环境的任何同事都知道他们需要访问哪些内容来验证修复。

如果您只查看了一个特定的订阅/帐户/项目，则可以将此信息显示为列表：

**AWS 示例**

- 生产数据库-1 （db-ABCDEFG1234567）
- 分析数据库-1 （db-ZYXWVUT9876543）

**Azure 示例**

- 资源组：global-resources
  - globalstorageaccount（北欧）
  - backupstorageaccount（美国西部）

**GCP 示例**

- 前端服务器-1 （us-central1-a）
- 后端服务器-1 （us-central1-b）

## 环境

最后，您可能正在测试一个更高级的概念，该概念适用于环境，而不是特定的可归因元素。在这里，我们可以简单地说明它影响的“区域”或“环境”的名称。

假设我们审查了一个网络，看看它们是否被充分隔离。我们可能会像这样突出显示受影响的网络：

- 生产环境
- 开发环境
- 暂存环境
- 企业网络
- 访客 WiFi 网络

在这里，我们将这些显示为一个简单的列表，这对于此类信息来说很好。

## 课程总结

本课不会向你们中的许多人介绍新概念，但为了完整起见，我将其包括在内。它直截了当地提醒人们，在安全调查结果中清楚地显示受影响的区域或“事物”的关键方面。确保完成此部分，以便客户可以确定您在哪里发现了您作为调查结果提出的问题，并且如果您的同事需要对调查结果执行补救验证，也可以确定他们。


# 30-位置或区域 - 练习

我们刚刚介绍了如何编写和呈现安全调查结果的“位置”或“区域”部分。

让我们来做一些练习。

**反思练习**

反思您撰写或有权访问的报告。查看调查结果的“位置”或“区域”部分（或本文档中的任何名称）。所有调查结果都包含客户在本节中查找和修复问题所需的所有内容吗？如果没有，你能根据我们刚刚学到的知识来修复它们吗？

**一般练习**

添加 OmniCorp 练习示例问题的位置信息。使用您认为合适的任何格式，最好是列表或表格。

**超越练习**

想想您每天使用的常用安全工具 - 您能否编写或找到任何工具来根据其他工具输出生成本节的内容？

# 31-引用

在前面的一些课程中，我们已经谈到了参考文献，但这里有一堂专门的课来正确地复习它们。

如前所述，为客户提供大多数问题的参考是有帮助的，这有几个原因可以说明这一点：

- 向客户推荐对复杂问题的更详细解释
- 提供有关如何解决问题的详细指南，来自适用的供应商或受信任的资源

参考文献可以被视为可选的，并且可能有许多发现不需要它们，因为它们的使用价值不大。但是，我认为重要的是要记住，我们是专家，对我们来说容易理解或司空见惯的事情并不总是适用于我们的客户。正因为如此，我更喜欢在我觉得客户有很小的可能性不理解我们在说什么的地方，或者我认为他们可能想要或需要围绕某个主题做进一步的阅读。

让我们来看看在安全检测结果中放置引用的格式选择。

## 格式

据我所知，有三种方法可以在你的发现文章中放置参考文献。

- 在调查结果末尾的专门“参考资料”部分
- 内联 URL
- 脚注

让我们更详细地看一下其中的每一个。

### 专用参考部分

通常，这将是安全发现的最后一部分，只需列出多个 URL 及其标题：

> **引用**
>
> - 密码存储备忘单 - https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html
> - 氩气2 - https://en.wikipedia.org/wiki/Argon2

这些通常从调查结果的正文中引用，例如：

> 有关 Argon2 和安全密码存储的更多信息，请参阅参考资料部分中的文章。

这种方法通常“更啰嗦”，因为它需要更多的键入和格式设置。不过，很高兴看到参考文献列表在它们自己的部分中分解，并且在视觉上更具吸引力。

### 内联链接

指向参考文献的内联链接是您在文章中可以做的最简单的事情，但在视觉上却是最可怕的。我在本课程的示例中使用了它，只是因为我想展示查找文章的部分书面部分（例如，仅推荐部分），并同时包含参考文献。

下面是前面一课中的一个示例，说明它是什么样子的：

> 修复此漏洞的最简单方法是使用 Windows 更新更新主机。如果使用补丁，还可以使用 WSUS 或 SCCM 在整个网络中推出。有关此漏洞的更多详细信息，请参阅 https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010

在此示例中，我们只是将链接直接复制到段落中。这个例子并不是*太*可怕，但是，当你有一个很长的URL时，这看起来一点也不好。

我建议避免使用此选项。

### 脚注

使用脚注，您可以在需要时将引用注入文本中，但不会破坏文本流。这是通过在文本中添加一个小链接来完成的，该链接链接到您正在阅读的页面或部分底部的内容。根据你所写的内容，你的发现和报告将取决于它的呈现方式。让我们以 Word 为例：

要插入脚注，请将光标放在要添加链接的位置（例如橙色框），单击顶部导航栏中的“引用”，然后单击功能区中的“插入脚注”：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231950943.png)

这会将您带到文档的底部，并带有“1”占位符，以便您放置 URL（或您想要的任何文本）。下面我添加了 URL：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231959067.png)

回到段落中，您可以看到链接到页面底部的小“1”：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231959654.png)

如果你使用 markdown 来编写你的报告，并且你能够使用脚注，你可以用非常相似的方式做到这一点。

在段落中，使用[^1]创建链接，在要插入链接的位置旁边：

> 修复此漏洞的最简单方法是使用 Windows 更新更新主机。如果使用补丁，还可以使用 WSUS 或 SCCM 在整个网络中推出。有关详细信息，请参阅 Microsoft 网站[^1]。

然后在您正在处理的部分的底部创建链接，如下所示：

> [^1] https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010

呈现方式将取决于您的特定报告环境。

这种方法现在非常干净，而且很常见，我个人推荐这种方法。

## 过度引用

提供对特定问题区域的多个引用可能很有用。当需要修正某些内容的多个部分，或者发现本身涵盖几个不同的主题时，通常需要这样做。在这些情况下，在涵盖修复中每个点的结束时，可以很好地插入不同区域的参考。

应该避免的是使用许多引用来向客户证明一个观点（“看！每个人都在说这是一个问题！或者提供多个说同样事情的参考资料。这不仅会给客户带来潜在的混乱和潜在工作的增加，而且在实际调查结果中对此的呈现看起来并不好。

如果你使用的是脚注，你不希望引用看起来像这样 - 它看起来不太好：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231950091.png)

将 5 个参考文献一个接一个地堆叠起来，使它看起来像是文档的参考文献 12,345。理想情况下，坚持使用一个参考文献，以避免脚注的堆积。

诚然，如果您使用专用的参考部分，这看起来并不可怕，因为它们将是一个简单的项目符号列表;但同样，您不想发送太多说同样事情的参考资料。报告的结果很可能会给客户带来一些工作要做——除非我们认为确实需要，否则我们真的不想给他们额外的阅读。

## 不正确的引用

我所看到的一些常见现象，尤其是在查看基于模板的发现时，参考文献不是针对特定发现的，即使它们是相关的。

例如，如果您对瞻博网络设备执行了防火墙评估，发现启用了多个物理接口，并且出于纵深防御的原因建议禁用它们。您决定保留对问题模板中对 Cisco 的引用，而不是查找禁用端口所需命令的瞻博网络特定参考。这显然是非常糟糕的，希望在 QA 过程中能够被发现。

另一个示例可能是 Linux 构建配置审查，其中引用（甚至建议本身）与不同的 Linux 发行版相关。参考如何为 CentOS 服务器设置密码策略将显示与 Ubuntu 服务器略有不同的东西。

当调查结果的作者在提交之前没有彻底审查他们的工作时，通常会出现这些问题。请记住，参考文献应尽可能与调查结果相关;因此，被审查设备的供应商应成为参考的一部分。

## 课程总结

您希望在报告文档中如何呈现您的参考资料由您决定。关键是要确保参考文献的呈现方式在整个文档中保持一致。

考虑只使用一两个高质量的参考文献，而不是一长串重复或质量较低的参考文献。请务必通读您的发现，以确保参考文献尽可能具体地针对发现本身及其影响。

# 32-引用 - 练习

在上一课中，我们介绍了参考文献及其在报告中的位置，以及我看到的一些常见的不良做法。

让我们使用我们在一些练习中学到的知识。

**反思练习**

反思您撰写或有权访问的报告。如何将参考文献添加到研究结果中？他们本来可以做得更好吗？

- 你能发现任何“过度引用”的例子吗？
- 您能看到任何可能无效或不够具体的参考文献吗？

**一般练习**

如果您尚未这样做，请添加对 OmniCorp 练习示例问题的引用。使用适合您的任何格式。

# 33-查找模板

任何为报告生成结果的团队都将生成模板。这对于加快报告速度和确保整个团队的一致性是绝对必要的。

让我们来看看创建和使用模板的主题。

## 制作模板

在我们开始之前，我要说的是，我对模板外观的看法可能与您习惯的不同。与往常一样，这很好。如果生成的模板以包含相关信息的最终结果结束，则可以。

理想情况下，一个完美的模板只需要使用它的测试人员进行很少的更改。也就是说，我相信“模板”的概念确实会引导测试人员走上一条道路，即在创建发现实例时只执行最少量的自定义。因此，在创建模板时，请务必确保有足够的占位符来提示测试人员填写特定于客户端的关键详细信息，但结果的编写方式允许大部分文本保持原样。

让我们看一下之前的发现，看看如何将其转化为模板。

> **Windows Server 漏洞，由于多个缺失修补程序（包括关键 MS17-010）而导致**
>
> **风险** - 高
>
> **描述**
>
> 由于缺少修补程序，OmniCorp 网络上的 Windows 域控制器容易受到严重的 MS17-010 安全漏洞的影响。利用此发现将导致对服务器的完全控制。由于服务器向环境中的所有主机提供身份验证，因此攻击者可能会破坏整个网络和所有客户数据。内部网络上的攻击者利用此漏洞是微不足道的，因为工具是公开可用的。
>
> MS17-010 漏洞会影响 Windows Server 消息块协议（1.0 版），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。
>
> 鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。但是，由于这会影响 Windows 域控制器，因此可以访问所有用户的所有凭据材料（以哈希或加密格式）。
>
> 由于这是整个环境的域控制器，并且是环境中通过 LDAP 提供身份验证的主要服务，因此入侵将影响生产域中所有连接的服务器和服务。
>
> Nessus 的以下结果显示了这一发现：
>
> ```
> Nessus Scan Report:
> Host: 192.168.1.10
> OS: Windows Server 2019
> Vulnerability: MS17-010 - Critical
> Description: Security Update for Microsoft Windows SMB Server (4013389)
> Severity: Critical
> ```
>
> 虽然服务器在评估期间未被利用，但使用了 Metasploit 来确认服务器是否可能易受攻击：
>
> ```
> [*] 192.168.1.100:445   - Scanning for vulnerabilities...
> [*] 192.168.1.100:445   - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 (64-bit)
> [*] Scanned 1 of 1 hosts (100% complete)
> [*] Auxiliary module execution completed
> ```
>
> **建议**
>
> 修复此漏洞的最简单方法是使用 Windows 更新更新主机。如果使用补丁，还可以使用 WSUS 或 SCCM 在整个网络中推出。有关此漏洞的更多详细信息，请参阅 https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010
>
> 如果无法修补漏洞，缓解措施可能是禁用 SMB 版本 1 - 这是因为 MS17-010 仅在 SMB 服务运行版本 1 时才会影响它。但是，应该注意的是，禁用 SMB 版本 1 也应作为完全修正此问题的一部分执行，因为它的使用存在许多漏洞。有关详细信息，请参阅“正在使用的 SMB 版本 1”结果。
>
> 查看网络中不在此评估范围内的任何区域，以查看是否存在此漏洞。
>
> 展望未来，确保在整个网络中执行漏洞扫描，以便及时发现和修复关键问题。查看环境的修补过程和过程，以确保及时修补关键漏洞。
>
> **位置**
>
> 192.168.1.100:445
>
> **引用**
>
> Microsoft 安全公告 MS17-010 - 严重 - https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010

要将结果转换为模板，需要考虑几个步骤：

- 删除任何特定于客户的名称、证据、位置/区域、上下文等。
  - 为需要自定义的区域保留占位符
- 删除对其他问题的任何引用
- 确定是否需要将结果模板更改为更通用的模板，或者将其更改为特定模板，并进行相应调整
  - 例如，Linux Server General的弱密码策略）或Ubuntu Server的弱密码策略（特定）
- 最终审查

让我们逐节浏览并将其转换为模板。

**描述**

首先，让我们删除客户端细节。下面可能是这样的：

> 由于缺少修补程序，Windows 域控制器容易受到严重的 MS17-010 安全检测结果的影响。利用此发现将导致对服务器的完全控制。{客户特定影响背景}{特定于客户端的可利用性上下文}{特定于客户端的缓解措施}
>
> MS17-10 漏洞影响 Windows Server 消息块协议（版本 1.0），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。
>
> 鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。但是，由于这会影响 Windows 域控制器，因此可以访问所有用户的所有凭据材料（以哈希或加密格式）。

前面的描述已经过编辑，删除了特定于客户端的详细信息，并将其替换为占位符。开头部分剩下的是：

- 问题是什么？
- 为什么不好？

我们通常应该填写的内容来自定义给定的发现：

- 情境影响
- 可利用性
- 可能存在的缓解措施

假设我们想将这一发现转化为对所有 Windows 服务器都更通用的发现，而不仅仅是域控制器。由于域控制器的轻微上下文性质（由于其在环境中的身份验证用法），某些域控制器措辞已被删除。让我们删除其余部分并添加一些通用提示作为证据：

> 由于缺少修补程序，网络上的 Windows 主机容易受到严重的 MS17-010 安全检测结果的影响。利用此漏洞将导致对受影响的服务器的完全控制。{客户特定影响背景}{特定于客户端的可利用性上下文}{特定于客户端的缓解措施}
>
> MS17-10 漏洞影响 Windows Server 消息块协议（版本 1.0），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。
>
> 鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。
>
> 下面显示了网络上存在 MS17-010：
>
> {证据}

**建议**

此处唯一的更改是删除了对 SMB 版本 1 结果的引用。在模板中引用其他发现是没有意义的，因为在使用此模板的参与期间可能会也可能不会找到它们。

> 有关详细信息，请参阅“正在使用的 SMB 版本 1”结果。

**位置**

所有需要做的就是空白这一部分。

**引用**

与建议部分一样，可以保持原样。在本文的这一部分中没有特定于 OmniCorp 的信息。

让我们看一下最终的模板：

> **描述**
>
> 由于缺少修补程序，网络上的 Windows 主机容易受到严重的 MS17-010 安全检测结果的影响。利用此漏洞将导致对受影响的服务器的完全控制。{客户特定影响背景}{特定于客户端的可利用性上下文}{特定于客户端的缓解措施}
>
> MS17-10 漏洞影响 Windows Server 消息块协议（版本 1.0），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。
>
> 鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。
>
> 下面显示了网络上存在 MS17-010：
>
> {证据}
>
> **建议**
>
> 修复此漏洞的最简单方法是使用 Windows 更新更新主机。如果使用补丁，还可以使用 WSUS 或 SCCM 在整个网络中推出。有关此漏洞的更多详细信息，请参阅 [https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010]（https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010）
>
> 如果无法修补漏洞，则缓解措施可能是禁用 SMB 版本 1 - 这是因为 MS17-010 仅在运行版本 1 时影响 SMB 服务。但是，应该注意的是，禁用 SMB 版本 1 也应作为完全修正此问题的一部分执行，因为它的使用具有许多漏洞。
>
> 查看网络中不在此评估范围内的任何区域，以查看是否存在此漏洞。
>
> 展望未来，确保在整个网络中执行漏洞扫描，以便及时发现和修复关键问题。查看环境的修补过程和过程，以确保及时修补关键漏洞。
>
> **位置**
>
> {位置}
>
> **引用**
>
> Microsoft 安全公告 MS17-010 - 严重 - https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010

## 使用模板

如果您发现了一个已经有模板的问题，那就太好了。这意味着，如果问题与模板内容完全一致，则可以重复使用问题中已有的大部分内容。

但是，重要的是要强调，即使使用最好的模板，也必须有一个定制、定制和仔细审查的过程。不要简单地插入你的证据来证明你的发现，什么都不改变。这种方法通常会导致客户收到非常通用的发现，并会让他们认为，“哦，这只是渗透测试公司的另一个发现”。如果你想让客户高度评价你的文章，请确保你加倍努力。这包括编辑模板，以适应您正在评估的内容以及上下文和影响。

因此，考虑到这一点，还记得我们在本章中已经介绍过的所有内容吗？描述？影响？建议？构建这些部分的方法是什么？好吧，当您想要编辑结果时，您需要重新访问所有这些概念。您必须使用它们来检查内容是否在潜在问题范围内，而不是使用这些信息来生成内容。如果不是，则需要添加。

让我们快速回顾一下在编辑模板时应该问自己的问题。

**风险评级**

- 模板是否附带了现有的风险评级？如果是这样，对于这个特定的发现实例，这是否正确？

**描述（和影响）**

- 描述是否说明了发现是什么？
- 描述是否涵盖了为什么发现是坏的？
- 描述是否需要添加影响级别信息，是否应该针对此特定客户和发现进行修改？
  - 几乎可以肯定的是，如果利用这一发现，对业务、用户和/或数据有什么影响？根据系统的了解，可能发生的最糟糕的事情是什么？
- 描述是否概述了攻击者需要处于什么位置才能利用该发现，以及他们利用该发现的难易程度如何？
  - 这可能需要添加或更改，因为发现的可利用性因环境而异。
- 调查结果是否需要涵盖任何可能使其更难利用并应提及的相关缓解措施？
  - 几乎可以肯定 - 这在测试之前是无法知道的。
- 描述有没有地方可以放置证据？你需要包括它吗？
- 除了最初的开场白之外，描述是否包含进一步的解释，以帮助客户理解问题或证据？如果不是，应该吗？

**建议**

- 该建议是否包含客户端修正此发现的明确说明？
- 是否需要调整说明以添加特定于客户的知识或上下文？
- 是否需要修改说明以更具体地针对调查结果？（例如，针对略有不同的操作系统、供应商、编程语言等量身定制）
- 该建议是否为客户提供了在其他地方寻找问题的任何建议？如果不是，应该吗？
- 该建议是否包括任何预防性建议？
- 可以做些什么来发现将来出现的这个问题？
- 可以做些什么来阻止这个问题再次出现？

**位置**

- 这是需要填写位置（或区域部分）的发现吗？

**引用**

- 此模板是否有可用于支持发现的参考？
- 此模板是否有参考，可以帮助以更深入的方式或只是以不同的方式向客户解释问题？

如果您在查看模板时解决这些问题，您应该能够确保模板是针对特定客户的发现量身定制的。您会注意到，这些都不是新的，并且在之前的课程中已经提到过。这里的不同之处在于，我们只是询问已经编写的文本的问题，而不是使用这些提示从头开始编写内容。

## 改进模板

如果您发现自己对模板的基本部分（不特定于客户端或结果实例的部分）进行了编辑，则很可能应该在下次将这些内容反馈到模板本身中。

以下是一些可能需要更新原始模板的区域（如果您已对原始模板进行更改）：

**描述（和影响）**

- 对发现的描述和/或为什么不好的任何更改。
- 对问题的进一步解释的任何更改，如果不是特定于客户端的。

**建议**

- 对用于解决特定问题的任何“常规”建议的更改。
- 更改为“在您的环境中搜索更多问题”措辞（如果它不是特定于客户端的）。
- 对预防性建议的更改（如果它们不是特定于客户的）。

**引用**

- 对引用的任何更新。

确保模板加快报告过程的唯一方法是，它们不仅经常使用，而且保持更新。如果您觉得应该重新措辞或改进某些内容以更符合最近的更改，请更新原始模板;帮助您自己和您的团队进行未来的评估。

## 课程总结

如果你正在制作一个模板，请确保你花适当的时间来编写它，使其使用者需要尽可能少的编辑，但同时涵盖本章前面介绍的所有内容。

使用模板时，请记住：模板就是模板。他们的目标是节省您的时间，但他们的目标不是确保您进行零自定义。通过进行正确的调整和编辑，确保你为客户做最好的事情，为他们量身定制调查结果。

# 34-查找模板 - 练习

在上一课中，我们介绍了创建和使用模板的思维过程。

以下是根据本课要解决的一些练习：

**反思练习**

反思您最近撰写或有权访问的报告。

- 根据前面的指南，将一些发现转换为模板。
- 如果您知道，是否有任何基于模板创建的发现？进行了哪些更改？模板可以更新吗？根据我们在上一课中讨论的内容，您是否认为最终的发现是不完整的？

**一般练习**

为您在过去几节课中编写的每个 OmniCorp 示例问题制作一个模板。

**超越练习**

你们内部有安全发现库吗？您是否能够根据在本章前面的课程中学到的内容对这些模板进行任何更新？

# 35-使用工具输出文本的问题

我不确定这是否真的是一个教训，但只是对一小部分安全行业的一些一般建议。如果您正在进行评估，并且安全工具发现了您没有模板的内容，请不要只是从工具中复制文本并将其用作您的文章。这不仅非常不专业，而且打开的客户会识别来自常见安全工具的文本，并且不会对您评价太高。如果您经常查看报告，它们并不难发现，因为它们的编写方式与报告的其余部分不同，并且通常不包括任何特定于客户的背景或影响。

我并不是说使用工具的输出作为证据不是一个好主意，我说的是完整复制和粘贴其他工具的描述和/或建议是这里的坏处。

我看到这种情况发生的主要原因有三个：

- 对提出的问题缺乏了解
- 时间压力
- 懒惰

后两点我无能为力，但我可以说的是，花时间了解这一发现，然后为它写一篇文章，比无耻地复制和粘贴更有益于你。此外，您应该能够为您的团队创建一个模板，如果在其他地方发现问题，可以再次使用该模板。

## 课程总结

我注意到我访问过的报告中的发现在过去表现出这种程度的剽窃迹象，但这种情况并不常见。如果你是一个习惯这样做的人，我的建议是：

- 别这样！
- 如果您不知道问题是什么，请进行研究或向您的团队寻求支持，以便您可以自己写下发现

# 36-问题示例

在本章中，我们已经介绍了发现文章的所有主要领域以及如何处理它们。

以下是五个示例问题在完整编写后的样子（至少在内容而不是呈现方面）。

## 严重 - 可公开访问的 S3 存储桶

**描述**

发现了一个可公开访问的 S3 存储桶。Internet 上任何能够猜出存储桶名称的用户都可以访问和下载 S3 存储桶中的所有文件。该存储桶包含所有员工的工资单信息，以及最近的渗透测试报告的结果，其中包含几个未修补的外部漏洞。利用这些信息，攻击者可以尝试通过利用上述外部漏洞或根据工资单信息的内容对用户进行网络钓鱼和密码猜测攻击来访问互联网。如果攻击者得逞，无论是获得对生产网络的访问权限还是破坏用户的访问权限，内部网络上的敏感客户信息都可能面临泄露的风险。

aws 命令行工具的以下命令输出显示了存储桶中存储的文件：

```
$ aws s3 ls s3://omnicorp-private-files
2024-01-28 12:35:29      1024 confidential_report.pdf
2024-01-29 08:15:47      2048 employee_data.xlsx
```

这两个文件都可以下载和检查：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231951892.png)

confidential_report.pdf内容

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404231951651.png)

employee_data.xlsx内容

机密报告包含以下可外部利用的漏洞列表，所有这些漏洞都在此评估期间存在：

- 使用可猜测凭据向 Internet 公开的 RDP
- 使用匿名绑定向 Internet 公开的 LDAP
- 暴露的 Apache Tomcat 过时且易受攻击

获取此文档访问权限的攻击者将能够立即确认这些问题的可利用性，因为它们都是面向 Internet 的，并且可能能够透视到内部网络。

工资单电子表格不仅显示了所有员工的当前工资和奖金，而且还泄露了大量可用于欺诈目的的信息，以及对 OmniCorp 进行其他攻击（例如密码猜测攻击或网络钓鱼）。电子表格中包含以下敏感信息：

- 名字和姓氏
- 工资
- 家庭住址
- 个人电子邮件地址
- 个人电话号码

**建议**

重新配置 S3 存储桶以禁用公有访问。

这可以从管理控制台执行：

1. 转到 Amazon S3 控制面板。
2. 单击存储桶名称 omnicorp-private-files。
3. 转到“权限”选项卡。
4. 单击 Block public access （bucket settings） （阻止公有访问（存储桶设置）。
5. 选中所有复选框以阻止新的公共 ACL 并删除现有的公共访问。
6. 点击保存。

或使用 AWS cli 工具：

```
aws s3api put-public-access-block --bucket omnicorp-private-files --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
```

鉴于两个公开文件中都存在高度敏感的数据，应查看与存储桶相关的任何访问日志。

对云环境执行定期扫描，以发现将来可公开访问的 S3 存储桶（可以利用 ScoutSuite 等工具）。此外，请考虑实施护栏以防止创建不安全的 S3 存储桶（例如可公开访问、不加密等）。这可以使用 AWS Identity and Access Management （IAM） 策略或服务控制策略 （SCP） 来实现。

**位置**

omnicorp-private-files （AWS 账户 123456789012）

**引用**

- Amazon S3 的安全最佳实践 - https://docs.aws.amazon.com/AmazonS3/latest/userguide/security-best-practices.html
- 童子军套房 - https://github.com/nccgroup/ScoutSuite

## 低 - Linux 服务器上的弱密码策略

**描述**

环境中 Linux 服务器上的帐户配置了通用用户名和密码组合。内部网络上的攻击者可能会使用基本的用户名和密码猜测攻击来获得访问权限。虽然受影响的用户是管理员，这将导致主机完全受损，但主机未被使用，并且不包含对攻击者有用的数据或凭据材料。环境中没有其他主机受此问题的影响。

成功登录受影响的 Linux 服务器如下所示：

```
$ ssh admin@192.168.1.122.com
admin@192.168.1.122.com's password: REDACTED
Welcome to 192.168.1.122.com!
Last login: Sun Jan 29 09:00:01 2024 from 192.168.1.122
admin@192.168.1.122:~$
```

**建议**

如果主机未使用，请停用。

如果主机有计划，则可以通过利用 libpam-pwquality 软件包来增加密码策略。以下是为此涉及的步骤（请注意，需要进行测试以确保这在所有系统上都有效）：

安装软件包：

```
sudo apt-get update
sudo apt-get install libpam-pwquality
```

编辑 /etc/pam.d/common-password 文件并编辑以下行：

```
password        requisite                       pam_pwquality.so retry=3 minlen=16 dcredit=-1 ucredit=-1 lcredit=-1 ocredit=-1
```

上面的示例强制执行以下密码复杂性：

- minlen=16：最小密码长度。
- dcredit=-1：至少需要一位数字。
- ucredit=-1：至少需要一个大写字母。
- lcredit=-1：至少需要一个小写字母。
- ocredit=-1：至少需要一个特殊字符。

要确保 SSH 服务器正在使用此 PAM 模块，请编辑 /etc/ssh/sshd_config 并确保将 UsePam 设置为 Yes。可能需要重新启动 SSH 服务器才能生效。

如果正在使用金牌版本，或者更广泛的环境处于配置管理之下，请考虑查看密码策略集并按照上述准则增加密码策略集。密码策略的实现可能因 Linux 发行版和其他操作系统而异。虽然此方法可能有助于保护本地帐户，但对于环境中的任何中央身份验证提供商（例如 LDAP 服务），请考虑查看密码策略以确保其符合上述建议。

**位置**

192.168.1.122

**引用**

Ubuntu 22.04 密码规则 - https://www.server-world.info/en/note?os=Ubuntu_22.04&p=pam&f=1

## 高 - Windows Server 漏洞，由于多个缺失修补程序（包括关键 MS17-010）而导致

**描述**

MS17-010 漏洞会影响 Windows Server 消息块协议（1.0 版），该协议主要用于 Windows 网络中的文件共享。该漏洞本身被 WannaCry 勒索软件广泛利用，在全球范围内造成了重大影响。

鉴于利用此漏洞会导致以 SYSTEM 用户身份在主机上执行任意远程代码，攻击者能够完全破坏系统。其结果意味着主机上的任何用户、数据或凭据材料都可能受到损害，并被用于攻击网络的其余部分。但是，由于这会影响 Windows 域控制器，因此可以访问所有用户的所有凭据材料（以哈希或加密格式）。

由于这是整个环境的域控制器，并且是环境中通过 LDAP 提供身份验证的主要服务，因此入侵将影响生产域中所有连接的服务器和服务。

Nessus 的以下结果显示了这一发现：

```
Nessus Scan Report:
Host: 192.168.1.10
OS: Windows Server 2019
Vulnerability: MS17-010 - Critical
Description: Security Update for Microsoft Windows SMB Server (4013389)
Severity: Critical
```

虽然服务器在评估期间未被利用，但使用了 Metasploit 来确认服务器是否可能易受攻击：

```
[*] 192.168.1.100:445   - Scanning for vulnerabilities...
[*] 192.168.1.100:445   - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 (64-bit)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

**建议**

修复此漏洞的最简单方法是使用 Windows 更新更新主机。如果使用补丁，还可以使用 WSUS 或 SCCM 在整个网络中推出。有关此漏洞的更多详细信息，请参阅 https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010

如果无法修补漏洞，缓解措施可能是禁用 SMB 版本 1 - 这是因为 MS17-010 仅在 SMB 服务运行版本 1 时才会影响它。但是，应该注意的是，禁用 SMB 版本 1 也应作为完全修正此问题的一部分执行，因为它的使用存在许多漏洞。有关详细信息，请参阅“正在使用的 SMB 版本 1”结果。

查看网络中不在此评估范围内的任何区域，以查看是否存在此漏洞。

展望未来，确保在整个网络中执行漏洞扫描，以便及时发现和修复关键问题。查看环境的修补过程和过程，以确保及时修补关键漏洞。

**位置**

192.168.1.100:445

**引用**

Microsoft 安全公告 MS17-010 - 严重 - https://learn.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010

## 严重 - 未进行身份验证的 API 端点

**描述**

发现了一个 API 端点，该端点返回了平台上所有用户的数据，并且无需身份验证即可访问。如果攻击者发现端点，则返回的数据将能够用于目标平台用户。这可能以密码猜测攻击、网络钓鱼或在其他 API 调用中利用其用户 ID 的形式出现。这些攻击不仅可能导致访问用户的敏感信息，而且这些信息的泄露可能会构成具有GDPR影响的隐私泄露。任何以经过身份验证的用户身份检查流量的攻击者都可能发现此漏洞，这意味着它更有可能被系统用户发现，而不是被外部攻击者随机发现。

During the assessment the following API call was observed which retrieved information that would be subsequently placed on the user's profile page:

**Request**

```
GET /api/user/profile/1 HTTP/1.1
Host: example.com
Authorization: Bearer REDACTED
```

**Response**

```
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 150
{"id": "1", "name": "John REDACTED", "email": "REDACTED"}
```

Based on how REST naming schemes are constructed, it is common for URLs without the suffix of identifiers to return all objects associated with the object type (profile in this case). As can be seen below, this returned data from all users:

**Request**

```
GET /api/users/profile HTTP/1.1
Host: example.com
Authorization: Bearer REDACTED
```

**Response**

```
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 150
{"users": [{"id": "1", "name": "John REDACTED", "email": "REDACTED"}, {"id": "2", "name": "Jane REDACTED", "email": "REDACTED}]}
```

While this was a significant concern on its own, another check was performed to see if the endpoint was available without authentication. This was achieved by removing the API token sent in the request and the response from the server was still returned, indicating no authentication was required:

**Request**

```
GET /api/users/profile HTTP/1.1
Host: example.com
```

**Response**

```
HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 150
{"users": [{"id": "1", "name": "John REDACTED", "email": "REDACTED"}, {"id": "2", "name": "Jane REDACTED", "email": "REDACTED"}]}
```

**Recommendations**

查看解决方案中的 /api/users/profile 终结点及其用例。如果不需要服务器返回所有用户，则应将其从应用程序中删除。如果平台的管理员用户需要它，则应围绕端点进行适当的身份验证和访问控制，以便只有管理员用户才能从此端点检索数据。

查看所有 API 端点，以确保返回或修改的数据只有在用户登录或经过身份验证后才能访问的任何端点。同样，请查看 API 端点以确认是否设置了返回所有对象的任何端点，因为代码库中的其他地方可能存在类似的疏忽。

确保在允许将代码合并到生产代码之前执行的代码审查过程经过仔细审查，特别是围绕引入新终结点或修改现有终结点。请考虑创建动态测试，以检查对不应具有的 API 端点的匿名访问，以及检查返回所有不应配置的对象的 API 端点。最后，考虑针对代码库运行任何适用的静态分析工具。一些特定于框架的工具可能能够突出显示这些问题。

**位置**

/api/users/profile

**引用**

OWASP 数据泄露过多 - https://owasp.org/API-Security/editions/2019/en/0xa3-excessive-data-exposure/

## 严重 - 在论坛软件上存储的跨站点脚本

**描述**

OmniCorp 用于协助客户支持请求的论坛软件容易受到存储的跨站点脚本的影响。此漏洞影响了论坛帖子页面上的评论部分，任何恶意注入的代码都会对访问受影响页面的任何用户运行。攻击者可以利用此漏洞破坏用户论坛会话（包括论坛版主或管理员），甚至提供虚假的登录表单，试图窃取用户的生产凭据。如果获取了用户凭据，则可能导致攻击者获得对敏感用户数据的访问权限。此漏洞的攻击复杂度非常低，因为没有防御性编码，使攻击者更容易利用;唯一的要求是用户访问受影响的论坛帖子。虽然只有该平台的用户可以利用这个问题，但鉴于互联网上的任何人都可以自行注册和使用该平台，这是没有意义的。虽然在托管论坛的 Web 服务器上安装了 Web 应用程序防火墙，但它当前并未运行。但是，即使启用了此问题，它也可能无法阻止所有利用此问题的尝试。

存储的跨站点脚本是一种漏洞，Web 应用程序未对不受信任的输入执行足够的输入验证或清理，或者未对值执行足够的输出编码。其结果是，应用程序（在数据库、日志或其他系统中）提交并随后存储的恶意信息随后被反映并合并到生成的网页中。在跨站点脚本的情况下，JavaScript 被发送到服务器、存储并返回到用户的浏览器，并执行以执行各种恶意操作。

利用跨站点脚本漏洞存在一系列可能性，其中一些包括：

- 在浏览器会话中运行加密矿工
- 尝试窃取经过身份验证的页面上特定于用户的会话令牌或内容
- 注入虚假表格供用户填写，以试图窃取信息（例如，用于收集凭据的登录表格）
- 在用户不知情的情况下在用户上下文中执行操作（例如，将恶意内容发布到论坛）
- 显示恶意内容

鉴于利用此漏洞的方式多种多样，此问题会严重影响任何处理敏感数据的应用程序，因为它更有可能被盗、修改或删除。

以下 HTTP 请求和响应显示了 OmniCorp 论坛应用程序软件接受的基本 JavaScript 的注入。

**请求**

```
POST /forum/post/1/comment HTTP/1.1
Host: forum.example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: sessionid=REDACTED


postId=42&comment=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E
```

**响应**

```
HTTP/1.1 200 OK
Content-Type: text/html; charset=UTF-8
Content-Length: 256
```

以下 HTTP 请求和响应显示服务器作为可在用户浏览器会话中运行的可执行 JavaScript 返回的有效负载。

**请求**

```
GET /forum/post/1/comments HTTP/1.1
Host: forum.example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 68
Cookie: sessionid=REDACTED
```

**响应**

```
HTTP/1.1 200 OK
Content-Type: text/html; charset=UTF-8
Content-Length: 256


<html>
<body>
  <div id="content">
    <div class="comment">User posted: <script>alert('XSS')</script></div>
  </div>
</body>
</html>
```

下图显示了正在执行的有效负载：

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404232001881.png)

正在执行的 Omnicorp 存储的跨站点脚本

创建概念验证 JavaScript 有效负载以生成以下 OmniCorp 登录表单。这将显示在请求的论坛帖子的顶部，以提示输入用户的凭据。提交后，用户的凭据将被发送到攻击者控制的服务器，然后帖子将变得可见。

![img](https://raw.githubusercontent.com/B1ueD0g/Picture/main/202404232001294.png)

假 OmniCorp 登录屏幕

可以在附录第 5.2 节中找到虚假登录概念证明 HTML 和 JavaScript 有效负载的完整副本，以及使用的 HTTP 请求和响应。

**建议**

防止跨站点脚本需要多种方法来确保应用程序保持安全：

- 不受信任数据的服务器端验证
- 用户提供数据的输出编码

应验证发送到服务器的所有数据，以确保它不包含意外类型，并且内容是预期的。当服务器需要自由范围的文本时，对这些数据进行验证可能更具挑战性。在这些情况下，可以在将特定字符存储在数据库中之前对其进行 HTML 编码。这将确保在客户端请求时以编码格式返回它们。

在为客户端构建页面时，必须确保返回的所有变量都经过适当的编码。许多现代前端框架将自动执行编码，但在使用应用程序外部任何资源中的值时仍应小心，即使它应被视为受信任的。

使用编码对应项进行编码的关键值包括：

| 字符 | 编码版本 |
| ---- | -------- |
| &    | &        |
| <    | <        |
| >    | >        |
| "    | “        |
| '    | &#x27;   |

如果服务器返回包含 HTML 的内容，则可以使用 DOMPurify 来剥离潜在的恶意内容，并且只允许安全的 HTML 标记和属性。如果使用，此库必须保持最新状态。

对于此应用程序，服务器返回的注释至少应是 HTML，这将导致以下响应：

```
<html>
<body>
  <div id="content">
    <div class="comment">User posted: &lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;</div>
  </div>
</body>
</html>
```

如果使用 DOMPurify，恶意脚本标记也将被删除。

有关跨站点脚本防护和 DOMPurify 使用的更多信息，请访问 OWASP 网站 （https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html）。此外，可以应用 Web 服务器强化，使攻击者更难通过 Content-Security-Policy 标头 （https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html） 利用跨站点脚本 - 请注意，这不会解决任何潜在问题，应始终实施完整修复。

查看 Web 应用程序代码的其余部分，以检查是否在其他地方使用了类似的编码模式，这可能会导致跨站点脚本编写。

开发人员应在提交代码之前利用代码 linter 来发现潜在的危险编码模式和函数用法。此外，在合并到生产代码之前，应执行自动化测试，这应该包括基本的静态分析安全测试。除了自动控制之外，如果尚未创建安全编码指南，则应制定突出框架支持的危险方法的安全编码指南。如果当前工具无法找到该漏洞，请调查是否可以编写自定义规则来发现有问题的 Code Pattern 的未来实例，或者查找可能能够发现该漏洞的其他工具。

**位置**

POST /forum/post/1/comment （参数：comment）

**引用**

- OWASP 备忘单 - 跨站点脚本防护 https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
- OWASP 备忘单 - 内容安全策略 https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html

# 37-本章小结

如果你做到了这一点，那就太好了——这是一个很长的章节。在其中，我们涵盖了查找文章的所有核心领域，以及如何以捕获客户执行补救所需的所有信息的方式编写它们的策略。

以下是本章的一些关键要点：

- 确保您的调查结果具有标识符 （ID），以便客户可以轻松参考调查结果 - 越简单越好
- 对调查结果的风险评级要深思熟虑，尤其是当您对客户有额外的背景和见解时
- 仔细考虑“良好”或“信息性”的调查结果 - 它们应该在调查结果部分、报告的其他地方，还是完全省略？
- 考虑使用其他元数据来支持您的发现，例如影响、可利用性、可能性、类别、修正工作或修正验证状态的分数/指标
- 确保所有调查结果的议题标题格式一致，措辞简明扼要，但需要时包括细节
- 在撰写调查结果时，请考虑如果漏洞被利用，对客户及其组织的实际影响
- 确保在文章中包括每个发现的影响
- 查找说明应包括以下信息：
  - 发现是什么
  - 为什么不好
  - 影响（或分解成自己的部分）
    - 哪些用户会受到影响？
    - 哪些系统会受到影响？
    - 哪些数据会受到影响？
  - 该问题的可利用性以及被利用的可能性如何？
  - 是否有任何缓解措施可能使问题更难利用？
  - 调查结果的证据
  - 如果问题很复杂或您需要解释您的证据，则解释调查结果的更多细节（超出初始描述）
- 调查结果建议应包括：
  - 有关如何修复发现的发现的信息，包括细节和可操作的建议
  - 建议客户在其他地方搜索同一问题（如果适用）
  - 如果问题再次出现，就发现问题的预防性建议，或完全预防问题的策略
- 确保以最清晰的方式提供证据，如果有意义，可以将其放在附录中或作为补充文件提供
- 从证据中编辑敏感信息
- 包括给定发现存在的明确位置，以便客户知道在哪里进行补救
- 考虑为所有非平凡的可解释的发现提供一两个好的参考资料。确保这些内容干净利落地呈现
  - 不要用无休止的引用来超载发现，并确保使用的任何引用都是最新的
- 使用您在这些课程中学到的所有知识来创建好的模板，为您自己或您的团队留下占位符，以注入良好的客户特定上下文和影响信息
- 如果使用模板，请记住本章的课程，以确保它们包含所有必需的信息 - 请记住，所有模板都需要自定义！

创建良好的安全发现是一项必须训练的技能，因此，如果您在本章中的练习中遇到困难，请不要担心。本课程稍后将进行更多练习。如果你将本章学到的原则应用到你的工作中，你的发现写作会得到改善。